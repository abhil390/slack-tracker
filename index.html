<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Login/Logout Tracker</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        body{background:#f0f2f5;padding:20px;}
        .container{max-width:1500px;margin:0 auto;}
        .header{background:linear-gradient(135deg,#1a4d8c 0%,#2c3e50 100%);color:white;padding:20px 30px;border-radius:15px 15px 0 0;}
        .header h1{font-size:24px;margin-bottom:5px;}
        .header p{opacity:.9;font-size:14px;}

        /* sync status bar */
        .sync-bar{background:#e8f5e9;border:1px solid #c8e6c9;border-radius:8px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;color:#2e7d32;}
        .sync-bar.error{background:#fdecea;border-color:#f5c6cb;color:#c62828;}
        .sync-bar.loading{background:#e3f2fd;border-color:#bbdefb;color:#1565c0;}
        .sync-dot{width:10px;height:10px;border-radius:50%;background:#27ae60;flex-shrink:0;}
        .sync-dot.error{background:#dc3545;}
        .sync-dot.loading{background:#1a4d8c;animation:pulse 1s infinite;}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

        /* panels */
        .panel{background:white;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:20px;overflow:hidden;}
        .panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;cursor:pointer;user-select:none;}
        .panel-header h2{font-size:15px;color:#333;font-weight:600;display:flex;align-items:center;gap:8px;}
        .panel-body{display:none;padding:20px;}
        .panel-body.open{display:block;}
        .toggle-icon{font-size:14px;color:#888;transition:transform .25s;}
        .panel-header.open .toggle-icon{transform:rotate(180deg);}

        .badge{font-size:12px;font-weight:700;padding:2px 9px;border-radius:20px;display:inline-block;}
        .badge-blue{background:#1a4d8c;color:white;}
        .badge-red{background:#dc3545;color:white;}

        .team-tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;}
        .team-tab{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all .2s;background:#f0f2f5;color:#555;}
        .team-tab.active-annotation{background:#e8f0fe;color:#1a4d8c;border-color:#1a4d8c;}
        .team-tab.active-assessment{background:#fef3e8;color:#c0631a;border-color:#c0631a;}

        .add-emp-row{display:flex;gap:10px;margin-bottom:18px;}
        .add-emp-row input{flex:1;padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;transition:border-color .2s;}
        .add-emp-row input:focus{outline:none;border-color:#1a4d8c;}
        .add-emp-row input.shake{animation:shake .3s;border-color:#dc3545;}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
        .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;max-height:260px;overflow-y:auto;padding-right:4px;}
        .emp-chip{display:flex;align-items:center;justify-content:space-between;border-radius:8px;padding:8px 12px;font-size:13px;color:#333;transition:background .15s;}
        .emp-chip.annotation{background:#e8f0fe;} .emp-chip.annotation:hover{background:#d2e3fc;}
        .emp-chip.assessment{background:#fef3e8;} .emp-chip.assessment:hover{background:#fde0c0;}
        .emp-chip .emp-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .emp-chip .remove-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:16px;line-height:1;padding:0 0 0 8px;transition:color .15s;flex-shrink:0;}
        .emp-chip .remove-btn:hover{color:#dc3545;}
        .panel-footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid #eee;font-size:12px;color:#999;flex-wrap:wrap;gap:10px;}

        .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
        .btn-sm{padding:6px 14px;font-size:12px;}
        .btn-xs{padding:4px 10px;font-size:11px;}
        .btn-primary{background:#1a4d8c;color:white;} .btn-primary:hover{background:#0d3a6b;}
        .btn-secondary{background:#e0e0e0;color:#333;} .btn-secondary:hover{background:#d0d0d0;}
        .btn-success{background:#27ae60;color:white;} .btn-success:hover{background:#219a52;}
        .btn-info{background:#17a2b8;color:white;} .btn-info:hover{background:#138496;}
        .btn-danger{background:#dc3545;color:white;} .btn-danger:hover{background:#b02a37;}
        .btn-warning{background:#e67e22;color:white;} .btn-warning:hover{background:#ca6f1e;}

        .input-section{background:white;padding:20px;border-radius:0 0 15px 15px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px;}
        .input-section textarea{width:100%;height:280px;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;font-family:monospace;resize:vertical;margin-bottom:15px;line-height:1.5;}
        .input-section textarea:focus{outline:none;border-color:#1a4d8c;}
        .button-group{display:flex;gap:10px;flex-wrap:wrap;}
        .date-row{display:flex;align-items:center;gap:12px;margin-bottom:15px;flex-wrap:wrap;}
        .date-row label{font-size:14px;font-weight:600;color:#555;}
        .date-row input[type=date]{padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;}
        .date-row input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .date-row .date-hint{font-size:12px;color:#999;}

        .view-tabs{display:flex;gap:0;border-radius:10px 10px 0 0;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.08);}
        .view-tab{flex:1;padding:14px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;background:#e9ecef;color:#555;border:none;transition:background .2s,color .2s;}
        .view-tab .tab-count{font-size:11px;font-weight:700;margin-left:6px;padding:2px 7px;border-radius:20px;background:rgba(0,0,0,.1);}
        .view-tab.active-all{background:#2c3e50;color:white;}
        .view-tab.active-violations{background:#dc3545;color:white;}
        .view-tab.active-annotation{background:#1a4d8c;color:white;}
        .view-tab.active-assessment{background:#c0631a;color:white;}

        .stats-wrapper{background:white;padding:16px 16px 0;border-top:1px solid #dee2e6;}
        .stats-label{font-size:12px;font-weight:700;text-transform:uppercase;color:#999;letter-spacing:.5px;margin-bottom:10px;}
        .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px;}
        .stat-card{background:#f8f9fa;padding:16px;border-radius:10px;text-align:center;border:1px solid #eee;}
        .stat-card h3{color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px;}
        .stat-card .value{font-size:28px;font-weight:bold;color:#1a4d8c;}
        .stat-card .value.complete{color:#27ae60;} .stat-card .value.incomplete{color:#e67e22;}
        .stat-card .value.leave{color:#6c757d;} .stat-card .value.missing{color:#dc3545;}

        .table-container{background:white;border-radius:0 0 10px 10px;box-shadow:0 2px 4px rgba(0,0,0,.1);overflow:auto;max-height:600px;}
        table{width:100%;border-collapse:collapse;}
        th{background:#f8f9fa;color:#333;font-weight:600;font-size:13px;padding:14px 15px;text-align:left;border-bottom:2px solid #dee2e6;position:sticky;top:0;z-index:10;white-space:nowrap;}
        td{padding:11px 15px;border-bottom:1px solid #e0e0e0;font-size:14px;}
        tr:hover td{background:#f5f5f5;}
        .team-header-row td{font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;padding:8px 15px;border-bottom:2px solid #dee2e6;}
        .team-header-row.annotation td{background:#e8f0fe;color:#1a4d8c;}
        .team-header-row.assessment td{background:#fef3e8;color:#c0631a;}

        .status-badge{padding:4px 8px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;}
        .status-complete{background:#d4edda;color:#155724;}
        .status-incomplete{background:#fff3cd;color:#856404;}
        .status-halfday{background:#fde8c8;color:#8a4a00;}
        .status-leave{background:#e2e3e5;color:#383d41;}
        .status-missing{background:#f8d7da;color:#721c24;}
        .time-badge{background:#e9ecef;padding:4px 8px;border-radius:15px;font-size:12px;}
        .team-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block;}
        .team-badge.annotation{background:#e8f0fe;color:#1a4d8c;}
        .team-badge.assessment{background:#fef3e8;color:#c0631a;}

        /* history */
        .history-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
        .history-toolbar select,.history-toolbar input[type=date]{padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;}
        .history-toolbar select:focus,.history-toolbar input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .history-toolbar label{font-size:13px;font-weight:600;color:#555;}

        .hist-emp-block{border:1px solid #e0e0e0;border-radius:10px;margin-bottom:10px;overflow:hidden;}
        .hist-emp-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f8f9fa;cursor:pointer;user-select:none;gap:10px;flex-wrap:wrap;}
        .hist-emp-header:hover{background:#eef0f3;}
        .hist-emp-name{font-weight:700;font-size:14px;color:#2c3e50;}
        .hist-emp-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
        .hist-violations-count{background:#dc3545;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-resolved-count{background:#27ae60;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-streak{background:#e67e22;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-emp-body{display:none;}
        .hist-emp-body.open{display:block;}
        .hist-table{width:100%;border-collapse:collapse;}
        .hist-table th{background:#f0f2f5;font-size:12px;padding:10px 14px;text-align:left;font-weight:600;color:#555;border-bottom:1px solid #dee2e6;}
        .hist-table td{padding:9px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;vertical-align:middle;}
        .hist-table tr:last-child td{border-bottom:none;}
        .hist-table tr:hover td{background:#fafafa;}
        .viol-row-missing td:first-child{border-left:4px solid #dc3545;}
        .viol-row-incomplete td:first-child{border-left:4px solid #e67e22;}
        .viol-row-resolved-leave td:first-child{border-left:4px solid #6c757d;}
        .viol-row-resolved-ignored td:first-child{border-left:4px solid #6f42c1;}
        .viol-row-resolved-leave td,.viol-row-resolved-ignored td{opacity:.65;}
        .res-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:4px;}
        .res-leave{background:#e2e3e5;color:#383d41;}
        .res-ignored{background:#e8d5ff;color:#5a32a3;}
        .res-reason{font-size:11px;color:#888;margin-top:3px;font-style:italic;}
        .no-history{padding:40px;text-align:center;color:#aaa;font-size:14px;}
        .history-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px;}
        .hist-stat{background:#f8f9fa;border:1px solid #eee;border-radius:8px;padding:12px;text-align:center;}
        .hist-stat .hv{font-size:22px;font-weight:bold;color:#dc3545;}
        .hist-stat .hl{font-size:11px;text-transform:uppercase;color:#999;margin-top:4px;}

        /* edit modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;align-items:center;justify-content:center;}
        .modal-overlay.open{display:flex;}
        .modal-confirm{background:white;border-radius:12px;padding:28px 32px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.2);text-align:center;}
        .modal-confirm h3{font-size:18px;margin-bottom:10px;color:#2c3e50;}
        .modal-confirm p{font-size:14px;color:#666;margin-bottom:22px;line-height:1.5;}
        .modal-btns{display:flex;gap:12px;justify-content:center;}
        .modal-edit{background:white;border-radius:14px;width:90%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-edit-header{background:linear-gradient(135deg,#1a4d8c,#2c3e50);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;}
        .modal-edit-header h3{font-size:16px;font-weight:700;}
        .modal-edit-close{background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;opacity:.8;}
        .modal-edit-close:hover{opacity:1;}
        .modal-edit-body{padding:24px;}
        .viol-info-box{background:#f8f9fa;border-radius:8px;padding:14px 16px;margin-bottom:20px;border:1px solid #e0e0e0;}
        .viol-info-box .vi-row{display:flex;justify-content:space-between;font-size:13px;padding:3px 0;color:#555;}
        .viol-info-box .vi-row strong{color:#2c3e50;}
        .resolution-options{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;}
        .res-option{border:2px solid #e0e0e0;border-radius:10px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;background:white;}
        .res-option:hover{border-color:#1a4d8c;background:#f0f4ff;}
        .res-option.selected-violation{border-color:#dc3545;background:#fff5f5;}
        .res-option.selected-on-leave{border-color:#6c757d;background:#f5f5f5;}
        .res-option.selected-ignored{border-color:#6f42c1;background:#f5f0ff;}
        .res-option .res-icon{font-size:24px;margin-bottom:6px;}
        .res-option .res-label{font-size:12px;font-weight:700;color:#333;}
        .res-option .res-desc{font-size:11px;color:#888;margin-top:3px;}
        .reason-field{margin-bottom:20px;}
        .reason-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
        .reason-field textarea{width:100%;padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;resize:none;height:72px;font-family:inherit;}
        .reason-field textarea:focus{outline:none;border-color:#1a4d8c;}
        .reason-field textarea.required-shake{animation:shake .3s;border-color:#dc3545;}
        .modal-edit-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        /* date manager */
        .date-manager{background:#fff8e1;border:1px solid #ffe082;border-radius:10px;padding:16px;margin-bottom:18px;}
        .date-manager h4{font-size:13px;font-weight:700;color:#555;margin-bottom:12px;text-transform:uppercase;letter-spacing:.4px;}
        .date-manager-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .date-manager-row select{flex:1;min-width:200px;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;cursor:pointer;}
        .date-manager-row select:focus{outline:none;border-color:#1a4d8c;}
        .date-manager-meta{font-size:12px;color:#888;margin-top:8px;}
        .no-dates{color:#aaa;font-size:13px;padding:4px 0;}

        /* clear-all confirm modal */
        .modal-clear{background:white;border-radius:14px;width:90%;max-width:440px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-clear-header{background:linear-gradient(135deg,#dc3545,#b02a37);color:white;padding:18px 24px;}
        .modal-clear-header h3{font-size:16px;font-weight:700;}
        .modal-clear-body{padding:24px;}
        .modal-clear-body p{font-size:14px;color:#555;margin-bottom:16px;line-height:1.6;}
        .modal-clear-body input{width:100%;padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;font-weight:700;letter-spacing:2px;text-align:center;}
        .modal-clear-body input:focus{outline:none;border-color:#dc3545;}
        .modal-clear-body input.match{border-color:#27ae60;background:#f0fff4;}
        .modal-clear-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        /* attendance panel */
        .attend-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
        .attend-toolbar select{padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;min-width:200px;}
        .attend-toolbar select:focus{outline:none;border-color:#1a4d8c;}
        /* searchable employee filter */
        .emp-search-wrap{position:relative;min-width:220px;}
        .emp-search-wrap input{width:100%;padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;box-sizing:border-box;}
        .emp-search-wrap input:focus{outline:none;border-color:#1a4d8c;}
        .emp-search-dropdown{position:absolute;top:100%;left:0;right:0;background:white;border:2px solid #1a4d8c;border-top:none;border-radius:0 0 8px 8px;max-height:220px;overflow-y:auto;z-index:500;display:none;}
        .emp-search-dropdown.open{display:block;}
        .emp-search-opt{padding:8px 12px;font-size:13px;cursor:pointer;border-bottom:1px solid #f0f0f0;}
        .emp-search-opt:hover,.emp-search-opt.highlighted{background:#e8f0fe;color:#1a4d8c;}
        .emp-search-opt.selected{font-weight:700;color:#1a4d8c;}
        /* date range row */
        .attend-range-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:16px;background:#f8f9fa;border:1px solid #e0e0e0;border-radius:8px;padding:10px 14px;}
        .attend-range-row label{font-size:13px;font-weight:600;color:#555;}
        .attend-range-row input[type=date]{padding:7px 10px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;}
        .attend-range-row input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .attend-range-active{background:#e8f0fe;border-color:#1a4d8c;}
        .attend-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px;}
        .attend-stat{background:#f8f9fa;border:1px solid #eee;border-radius:8px;padding:12px;text-align:center;}
        .attend-stat .av{font-size:22px;font-weight:bold;}
        .attend-stat .al{font-size:11px;text-transform:uppercase;color:#999;margin-top:4px;}
        .attend-table-wrap{overflow:auto;border-radius:8px;border:1px solid #e0e0e0;}
        .attend-table{width:100%;border-collapse:collapse;}
        .attend-table th{background:#f0f2f5;font-size:12px;padding:10px 14px;text-align:left;font-weight:600;color:#555;border-bottom:1px solid #dee2e6;white-space:nowrap;}
        .attend-table td{padding:9px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;vertical-align:middle;}
        .attend-table tr:last-child td{border-bottom:none;}
        .attend-table tr:hover td{background:#fafafa;}
        .attend-present td:first-child{border-left:4px solid #27ae60;}
        .attend-fullday td:first-child{border-left:4px solid #27ae60;}
        .attend-halfday td:first-child{border-left:4px solid #e67e22;}
        .attend-incomplete td:first-child{border-left:4px solid #e67e22;}
        .attend-absent td:first-child{border-left:4px solid #dc3545;}
        .attend-leave td:first-child{border-left:4px solid #6c757d;}
        .attend-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;}
        .ab-present{background:#d4edda;color:#155724;}
        .ab-fullday{background:#d4edda;color:#155724;}
        .ab-halfday{background:#fde8c8;color:#8a4a00;}
        .ab-incomplete{background:#fff3cd;color:#856404;}
        .ab-absent{background:#f8d7da;color:#721c24;}
        .ab-leave{background:#e2e3e5;color:#383d41;}
        .ab-manual{background:#e8d5ff;color:#5a32a3;font-size:10px;margin-left:4px;}
        .no-attend{padding:30px;text-align:center;color:#aaa;font-size:14px;}
        .attend-emp-history{background:#f8f9fa;border:1px solid #e0e0e0;border-radius:10px;padding:16px;margin-bottom:16px;}
        .attend-emp-history h4{font-size:13px;font-weight:700;color:#333;margin-bottom:12px;}
        .attend-hist-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #eee;font-size:13px;flex-wrap:wrap;}
        .attend-hist-row:last-child{border-bottom:none;}
        .attend-day-label{font-weight:700;color:#1a4d8c;min-width:90px;}
        .attend-day-name{color:#888;font-size:11px;min-width:70px;}

        /* attendance manual entry modal */
        .modal-attend{background:white;border-radius:14px;width:90%;max-width:480px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-attend-header{background:linear-gradient(135deg,#27ae60,#1e8449);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;}
        .modal-attend-header h3{font-size:16px;font-weight:700;}
        .modal-attend-close{background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;opacity:.8;}
        .modal-attend-close:hover{opacity:1;}
        .modal-attend-body{padding:24px;}
        .attend-field{margin-bottom:14px;}
        .attend-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:5px;}
        .attend-field input,.attend-field select{width:100%;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;}
        .attend-field input:focus,.attend-field select:focus{outline:none;border-color:#27ae60;}
        .attend-field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
        .modal-attend-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        .debug-info{background:#f8f9fa;padding:10px;margin:10px 0;border-radius:5px;font-size:12px;color:#666;max-height:200px;overflow:auto;display:none;border:1px solid #dee2e6;font-family:monospace;}
        .footer{text-align:center;margin-top:20px;color:#666;font-size:13px;}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#2c3e50;color:white;padding:12px 24px;border-radius:30px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .3s;z-index:9999;}
        .toast.show{opacity:1;}

        /* Date confirm modal */
        .modal-dateconfirm{background:white;border-radius:16px;width:90%;max-width:460px;box-shadow:0 12px 50px rgba(0,0,0,.3);overflow:hidden;}
        .modal-dateconfirm-header{background:linear-gradient(135deg,#e67e22,#d35400);color:white;padding:20px 24px;}
        .modal-dateconfirm-header h3{font-size:17px;font-weight:700;margin-bottom:4px;}
        .modal-dateconfirm-header p{font-size:13px;opacity:.9;}
        .modal-dateconfirm-body{padding:24px;}
        .modal-dateconfirm-body .date-display{background:#fff8f0;border:2px solid #e67e22;border-radius:10px;padding:14px;text-align:center;font-size:22px;font-weight:800;color:#d35400;letter-spacing:2px;margin-bottom:16px;}
        .modal-dateconfirm-body .date-day{font-size:13px;color:#888;text-align:center;margin-top:-10px;margin-bottom:16px;}
        .modal-dateconfirm-body p{font-size:13px;color:#555;margin-bottom:10px;line-height:1.6;}
        .modal-dateconfirm-body input{width:100%;padding:11px 14px;border:2px solid #e0e0e0;border-radius:9px;font-size:15px;font-weight:700;letter-spacing:2px;text-align:center;box-sizing:border-box;}
        .modal-dateconfirm-body input:focus{outline:none;border-color:#e67e22;}
        .modal-dateconfirm-body input.match{border-color:#27ae60;background:#f0fff4;color:#155724;}
        .modal-dateconfirm-body input.wrong{border-color:#dc3545;background:#fff5f5;color:#721c24;}
        .modal-dateconfirm-hint{font-size:12px;margin-top:6px;text-align:center;min-height:16px;}
        .modal-dateconfirm-footer{padding:14px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}
        .team-select{padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;background:white;cursor:pointer;}
        .team-select:focus{outline:none;border-color:#1a4d8c;}
        /* â•â• LOGIN SCREEN â•â• */
        .login-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#1a4d8c 0%,#2c3e50 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
        .login-overlay.hidden{display:none;}
        .login-box{background:white;border-radius:20px;padding:40px 36px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.4);text-align:center;}
        .login-logo{font-size:48px;margin-bottom:12px;}
        .login-box h2{font-size:22px;font-weight:700;color:#2c3e50;margin-bottom:4px;}
        .login-box p{font-size:13px;color:#888;margin-bottom:28px;}
        .login-field{text-align:left;margin-bottom:16px;}
        .login-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
        .login-field input{width:100%;padding:11px 14px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;transition:border-color .2s;}
        .login-field input:focus{outline:none;border-color:#1a4d8c;}
        .login-field input.error{border-color:#dc3545;animation:shake .3s;}
        .login-btn{width:100%;padding:13px;background:linear-gradient(135deg,#1a4d8c,#2c3e50);color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;transition:opacity .2s;}
        .login-btn:hover{opacity:.9;}
        .login-error{color:#dc3545;font-size:13px;margin-top:12px;min-height:18px;font-weight:600;}
        .login-user-badge{display:inline-flex;align-items:center;gap:6px;background:#e8f0fe;color:#1a4d8c;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;cursor:pointer;border:none;}
        .login-user-badge:hover{background:#d2e3fc;}
        .top-user-bar{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:12px;}
    </style>
</head>
<body>

<!-- â•â• LOGIN SCREEN â•â• -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="login-logo">ğŸ“‹</div>
        <h2>Slack Tracker</h2>
        <p>Please log in to continue</p>

        <div class="login-field">
            <label for="loginUser">Username</label>
            <input type="text" id="loginUser" placeholder="Enter your username" autocomplete="username"/>
        </div>
        <div class="login-field">
            <label for="loginPass">Password</label>
            <input type="password" id="loginPass" placeholder="Enter your password" autocomplete="current-password"/>
        </div>
        <button class="login-btn" id="loginBtn">ğŸ” Login</button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>

<div class="container" id="mainApp" style="display:none;">

    <div class="header">
        <div class="top-user-bar">
            <span style="color:rgba(255,255,255,.7);font-size:13px;">Logged in as:</span>
            <span class="login-user-badge" id="loggedUserBadge">ğŸ‘¤ â€”</span>
            <button class="btn btn-sm" id="logoutBtn" style="background:rgba(255,255,255,.15);color:white;font-size:12px;padding:5px 14px;">ğŸšª Logout</button>
        </div>
        <h1>ğŸ“‹ Slack Login/Logout Tracker <span class="status-badge status-complete">v8.0</span></h1>
        <p>Shared history between both users â€” powered by Supabase cloud database</p>
    </div>

    <!-- Sync status bar -->
    <div class="sync-bar loading" id="syncBar">
        <div class="sync-dot loading" id="syncDot"></div>
        <span id="syncMsg">Connecting to shared databaseâ€¦</span>
    </div>

    <!-- Employee Management -->
    <div class="panel">
        <div class="panel-header" id="empPanelToggle">
            <h2>ğŸ‘¥ Manage Employees <span class="badge badge-blue" id="empCount">0</span></h2>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-body" id="empPanelBody">
            <div class="team-tabs">
                <div class="team-tab active-annotation" id="tabAnnotation">ğŸ”µ Data Annotation (<span id="countAnnotation">0</span>)</div>
                <div class="team-tab" id="tabAssessment">ğŸŸ  Data Assessment / DA (<span id="countAssessment">0</span>)</div>
            </div>
            <div class="add-emp-row">
                <input type="text" id="newEmpInput" placeholder="Employee nameâ€¦" maxlength="80"/>
                <select class="team-select" id="newEmpTeam">
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <button class="btn btn-primary" id="addEmpBtn">â• Add</button>
            </div>
            <div class="emp-grid" id="empGrid"></div>
            <div class="panel-footer">
                <span>ğŸ’¾ Saved in this browser. History is shared via cloud.</span>
                <button class="btn btn-danger btn-sm" id="resetEmpBtn">â†© Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Slack Input -->
    <div class="input-section">
        <div class="date-row">
            <label for="reportDate">ğŸ“… Date of this log:</label>
            <input type="date" id="reportDate"/>
            <span class="date-hint">Tags violations in shared history. Defaults to today.</span>
        </div>
        <textarea id="slackInput" placeholder="Paste Slack messages here â€” both teams together is fineâ€¦"></textarea>
        <div class="button-group">
            <button class="btn btn-primary"   id="processBtn">ğŸ” Process &amp; Save to History</button>
            <button class="btn btn-secondary" id="clearBtn">ğŸ—‘ï¸ Clear</button>
            <button class="btn btn-success"   id="sample1Btn">ğŸ“‹ Format 1</button>
            <button class="btn btn-info"      id="sample2Btn">ğŸ“‹ Format 2</button>
            <button class="btn btn-secondary" id="exportBtn">ğŸ“¥ Export CSV</button>
            <button class="btn btn-secondary" id="debugBtn">ğŸ› Debug</button>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <!-- Today's Results -->
    <div class="view-tabs" id="viewTabs" style="display:none;">
        <button class="view-tab active-all" data-view="all">ğŸ“Š All <span class="tab-count" id="tcAll">0</span></button>
        <button class="view-tab" data-view="violations">ğŸš¨ Violations <span class="tab-count" id="tcViolations">0</span></button>
        <button class="view-tab" data-view="annotation">ğŸ”µ Annotation <span class="tab-count" id="tcAnnotation">0</span></button>
        <button class="view-tab" data-view="assessment">ğŸŸ  Assessment <span class="tab-count" id="tcAssessment">0</span></button>
    </div>
    <div id="resultsArea" style="display:none;">
        <div class="stats-wrapper">
            <div class="stats-label" id="statsLabel">Overall</div>
            <div class="stats-container" id="statsContainer"></div>
        </div>
        <div class="table-container"><div id="tableContainer"></div></div>
    </div>

    <!-- Violation History -->
    <div class="panel" style="margin-top:24px;">
        <div class="panel-header" id="histPanelToggle">
            <h2>ğŸš¨ Violation History <span class="badge badge-red" id="histTotalBadge">0 violations</span>
                <button class="btn btn-info btn-sm" id="refreshHistBtn" style="margin-left:8px;font-size:11px;padding:3px 10px;">ğŸ”„ Refresh</button>
            </h2>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-body" id="histPanelBody">
            <div class="history-summary" id="histSummary"></div>
            <div class="history-toolbar">
                <label>Team:</label>
                <select id="histTeamFilter">
                    <option value="all">All Teams</option>
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <label>Show:</label>
                <select id="histTypeFilter">
                    <option value="all">All Records</option>
                    <option value="active" selected>Active Violations Only</option>
                    <option value="resolved">Resolved Only</option>
                    <option value="Missing">Missing</option>
                    <option value="Incomplete">Incomplete</option>
                    <option value="On Leave">Marked On Leave</option>
                    <option value="Ignored">Ignored</option>
                </select>
                <label>From:</label><input type="date" id="histFromDate"/>
                <label>To:</label><input type="date" id="histToDate"/>
                <button class="btn btn-secondary btn-sm" id="histFilterBtn">ğŸ” Apply</button>
                <button class="btn btn-secondary btn-sm" id="histResetFilterBtn">âœ– Clear</button>
                <button class="btn btn-success btn-sm"   id="histExportBtn">ğŸ“¥ Export CSV</button>
                <button class="btn btn-danger btn-sm"    id="histClearBtn">ğŸ—‘ï¸ Clear All</button>
            </div>
            <!-- Date Manager -->
            <div class="date-manager">
                <h4>ğŸ“… Manage Data by Date â€” Select a date to delete and re-enter fresh data</h4>
                <div class="date-manager-row">
                    <select id="dateSelect" onchange="onDateSelectChange()">
                        <option value="">â€” Select a date â€”</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" id="dateReenterBtn" onclick="preloadSelectedDate()" disabled>âœï¸ Re-enter Data</button>
                    <button class="btn btn-danger btn-sm"   id="dateDeleteBtn"  onclick="deleteSelectedDate()"  disabled>ğŸ—‘ï¸ Delete Date</button>
                </div>
                <div class="date-manager-meta" id="dateMeta"></div>
            </div>

            <div id="histContent"></div>
        </div>
    </div>

    <!-- Attendance Tracker Panel -->
    <div class="panel" style="margin-top:24px;">
        <div class="panel-header" id="attendPanelToggle">
            <h2>ğŸ“Š Daily Attendance Tracker
                <span class="badge badge-blue" id="attendBadge">Select a date</span>
            </h2>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-body" id="attendPanelBody">
            <div class="attend-toolbar">
                <label style="font-size:13px;font-weight:600;color:#555;">Select Date:</label>
                <select id="attendDateSelect" onchange="loadAttendance()">
                    <option value="">â€” Pick a date â€”</option>
                </select>
                <label style="font-size:13px;font-weight:600;color:#555;">Employee:</label>
                <div class="emp-search-wrap" id="empSearchWrap">
                    <input type="text" id="empSearchInput" placeholder="Search or select employeeâ€¦" autocomplete="off" oninput="onEmpSearchInput()" onfocus="openEmpDropdown()" onkeydown="onEmpSearchKey(event)"/>
                    <div class="emp-search-dropdown" id="empSearchDropdown"></div>
                </div>
                <button class="btn btn-success btn-sm" id="attendAddBtn" onclick="openAttendanceModal()" disabled>â• Add / Edit Entry</button>
                <button class="btn btn-secondary btn-sm" id="attendExportBtn" onclick="exportAttendanceCSV()" disabled>ğŸ“¥ Export CSV</button>
                <button class="btn btn-danger btn-sm"   id="attendDeleteDateBtn" onclick="deleteAttendanceByDate()" disabled>ğŸ—‘ï¸ Delete Date</button>
            </div>
            <!-- Date range row â€” shown only when an employee is selected -->
            <div class="attend-range-row" id="attendRangeRow" style="display:none;">
                <label>ğŸ“… Date Range:</label>
                <label style="font-weight:400;">From</label>
                <input type="date" id="empRangeFrom" onchange="applyEmpDateRange()"/>
                <label style="font-weight:400;">To</label>
                <input type="date" id="empRangeTo" onchange="applyEmpDateRange()"/>
                <button class="btn btn-secondary btn-sm" onclick="clearEmpDateRange()">âœ– Clear Range</button>
                <span id="empRangeLabel" style="font-size:12px;color:#888;"></span>
            </div>
            <div class="attend-summary" id="attendSummary"></div>
            <div class="attend-table-wrap">
                <div id="attendContent"><div class="no-attend">Select a date above to view attendance.</div></div>
            </div>
        </div>
    </div>

    <div class="footer"><span id="lastUpdated"></span></div>
</div><!-- end mainApp -->

<div class="toast" id="toast"></div>

<!-- Clear All Modal (requires typing CLEAR) -->
<div class="modal-overlay" id="clearOverlay">
    <div class="modal-clear">
        <div class="modal-clear-header">
            <h3>ğŸ—‘ï¸ Clear All History</h3>
        </div>
        <div class="modal-clear-body">
            <p>This will <strong>permanently delete ALL violation history</strong> for both users and cannot be undone.<br><br>
            To confirm, type <strong>CLEAR</strong> in the box below:</p>
            <input type="text" id="clearConfirmInput" placeholder="Type CLEAR hereâ€¦" autocomplete="off"/>
        </div>
        <div class="modal-clear-footer">
            <button class="btn btn-secondary" id="clearOverlayCancel">Cancel</button>
            <button class="btn btn-danger"    id="clearOverlayConfirm" disabled>ğŸ—‘ï¸ Delete Everything</button>
        </div>
    </div>
</div>

<!-- Attendance Manual Entry Modal -->
<div class="modal-overlay" id="attendOverlay">
    <div class="modal-attend">
        <div class="modal-attend-header">
            <h3>â• Add / Edit Attendance Entry</h3>
            <button class="modal-attend-close" id="attendCloseBtn">Ã—</button>
        </div>
        <div class="modal-attend-body">
            <div class="attend-field">
                <label>Employee</label>
                <select id="attendEmpSelect">
                    <option value="">â€” Select employee â€”</option>
                </select>
            </div>
            <div class="attend-field">
                <label>Status</label>
                <select id="attendStatus" onchange="onAttendStatusChange()">
                    <option value="Full Day">âœ… Full Day (7.5+ hrs)</option>
                    <option value="Half Day">ğŸŒ“ Half Day (less than 4.5 hrs)</option>
                    <option value="Incomplete">âš ï¸ Incomplete (missing login or logout)</option>
                    <option value="Absent">âŒ Absent</option>
                    <option value="On Leave">ğŸ“… On Leave</option>
                </select>
            </div>
            <div id="attendTimeFields">
                <div class="attend-field-row">
                    <div class="attend-field">
                        <label>Login Time</label>
                        <input type="text" id="attendLogin" placeholder="e.g. 9:00 AM"/>
                    </div>
                    <div class="attend-field">
                        <label>Logout Time</label>
                        <input type="text" id="attendLogout" placeholder="e.g. 6:00 PM"/>
                    </div>
                </div>
            </div>
            <div class="attend-field">
                <label>Notes (optional)</label>
                <input type="text" id="attendNotes" placeholder="Any notes or remarksâ€¦"/>
            </div>
        </div>
        <div class="modal-attend-footer">
            <button class="btn btn-secondary" id="attendCancelBtn" onclick="closeAttendanceModal()">Cancel</button>
            <button class="btn btn-success"   id="attendSaveBtn">ğŸ’¾ Save Entry</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmOverlay">
    <div class="modal-confirm">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMsg"></p>
        <div class="modal-btns">
            <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
            <button class="btn btn-danger"    id="confirmOk">Confirm</button>
        </div>
    </div>
</div>

<!-- Edit Violation Modal -->
<div class="modal-overlay" id="editOverlay">
    <div class="modal-edit">
        <div class="modal-edit-header">
            <h3>âœï¸ Edit Violation</h3>
            <button class="modal-edit-close" id="editClose">Ã—</button>
        </div>
        <div class="modal-edit-body">
            <div class="viol-info-box" id="editInfoBox"></div>
            <p style="font-size:13px;font-weight:600;color:#555;margin-bottom:10px;">Change resolution to:</p>
            <div class="resolution-options">
                <div class="res-option" data-res="violation" id="resOptViolation">
                    <div class="res-icon">ğŸš¨</div>
                    <div class="res-label">Keep as Violation</div>
                    <div class="res-desc">Counts against the employee</div>
                </div>
                <div class="res-option" data-res="On Leave" id="resOptLeave">
                    <div class="res-icon">ğŸ“…</div>
                    <div class="res-label">Mark On Leave</div>
                    <div class="res-desc">Absent for legitimate reason</div>
                </div>
                <div class="res-option" data-res="Ignored" id="resOptIgnored">
                    <div class="res-icon">ğŸ”•</div>
                    <div class="res-label">Ignore / Excuse</div>
                    <div class="res-desc">System error or known reason</div>
                </div>
            </div>
            <div class="reason-field">
                <label for="editReason">Reason / Notes <span id="editReasonRequired" style="color:#dc3545;display:none;">*required</span></label>
                <textarea id="editReason" placeholder="Required for On Leave and Ignore â€” add a note explaining whyâ€¦"></textarea>
            </div>
        </div>
        <div class="modal-edit-footer">
            <button class="btn btn-secondary" id="editCancel">Cancel</button>
            <button class="btn btn-primary"   id="editSave">ğŸ’¾ Save to Cloud</button>
        </div>
    </div>
</div>

<!-- Date Confirm Modal -->
<div class="modal-overlay" id="dateConfirmOverlay">
    <div class="modal-dateconfirm">
        <div class="modal-dateconfirm-header">
            <h3>âš ï¸ Confirm Date Before Saving</h3>
            <p>Please verify the date is correct before proceeding.</p>
        </div>
        <div class="modal-dateconfirm-body">
            <div class="date-display" id="dcDateDisplay"></div>
            <div class="date-day" id="dcDayDisplay"></div>
            <p>Type the date shown above in <strong>DD/MM/YYYY</strong> format to confirm:</p>
            <input type="text" id="dcInput" placeholder="e.g. 19/02/2026" autocomplete="off" maxlength="10"/>
            <div class="modal-dateconfirm-hint" id="dcHint"></div>
        </div>
        <div class="modal-dateconfirm-footer">
            <button class="btn btn-secondary" id="dcCancelBtn">âœ– Cancel</button>
            <button class="btn btn-primary"   id="dcConfirmBtn" disabled>âœ… Yes, Process & Save</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ğŸ‘¤  USER ACCOUNTS  â€” change usernames and passwords here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const USERS = [
    { username: 'admin',   password: 'Admin@123',  displayName: 'Admin' },
    { username: 'user2',   password: 'User2@456',  displayName: 'User 2' }
];
// To add more users, copy a line above and change the details.
// Example: { username: 'john', password: 'John@789', displayName: 'John' }

const LS_SESSION = 'slackTracker_session';

function checkSession(){
    try{
        const s = localStorage.getItem(LS_SESSION);
        if(s){
            const parsed = JSON.parse(s);
            if(parsed && parsed.username && parsed.expires > Date.now()) return parsed;
        }
    } catch(e){}
    return null;
}

function doLogin(){
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value;
    const errEl    = document.getElementById('loginError');
    errEl.textContent = '';

    if(!username || !password){
        errEl.textContent = 'Please enter both username and password.';
        return;
    }

    const user = USERS.find(u =>
        u.username.toLowerCase() === username.toLowerCase() && u.password === password
    );

    if(!user){
        errEl.textContent = 'âŒ Incorrect username or password.';
        document.getElementById('loginUser').classList.add('error');
        document.getElementById('loginPass').classList.add('error');
        setTimeout(()=>{
            document.getElementById('loginUser').classList.remove('error');
            document.getElementById('loginPass').classList.remove('error');
        }, 800);
        document.getElementById('loginPass').value = '';
        document.getElementById('loginPass').focus();
        return;
    }

    // Save session â€” expires in 8 hours
    const session = { username: user.username, displayName: user.displayName, expires: Date.now() + 8*60*60*1000 };
    localStorage.setItem(LS_SESSION, JSON.stringify(session));
    showMainApp(session);
}

function doLogout(){
    localStorage.removeItem(LS_SESSION);
    document.getElementById('mainApp').style.display    = 'none';
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').textContent = '';
}

function showMainApp(session){
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('loggedUserBadge').textContent = 'ğŸ‘¤ ' + session.displayName;
    // Only init app if not already initialised (prevents double-init on page load)
    if(!window._appInitialised) initApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  SUPABASE CONFIG  â€” paste your keys here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://tfapnbvrquswjzogdhbh.supabase.co';
const SUPABASE_KEY = 'sb_publishable_VcT6pNqY6tO0jwBgBkOqQQ_ie4JPHdD';  // â† replace this with the long eyJ... key
const TABLE = 'violation_history';
const ATTEND_TABLE = 'attendance_records';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE API WRAPPER  (no extra libraries needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbFetch(path, opts={}){
    const url = SUPABASE_URL + '/rest/v1/' + path;
    // Build headers â€” Prefer must be set explicitly per call
    const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
    };
    if(opts.prefer) headers['Prefer'] = opts.prefer;
    if(opts.headers) Object.assign(headers, opts.headers);

    const res = await fetch(url, {
        method: opts.method || 'GET',
        headers,
        body: opts.body || undefined
    });
    if(!res.ok){
        const err = await res.text();
        throw new Error(`Supabase error ${res.status}: ${err}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : [];
}

// Load all rows sorted by date
async function dbLoad(){
    return sbFetch(TABLE + '?order=date.asc&select=*');
}

// Insert a brand-new row (no id â€” let Supabase generate uuid)
async function dbInsert(row){
    const {id, ...payload} = row; // strip id if present
    const url = SUPABASE_URL + '/rest/v1/' + TABLE;
    const res = await fetch(url, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(payload)
    });
    console.log('[dbInsert] response status='+res.status);
    if(!res.ok){
        const err = await res.text();
        throw new Error('INSERT failed '+res.status+': '+err);
    }
    return true;
}

// Update an existing row by its uuid â€” used for resolution changes
async function dbPatch(rowId, fields){
    console.log('[dbPatch] PATCH id='+rowId, fields);
    const url = SUPABASE_URL + '/rest/v1/' + TABLE + '?id=eq.' + rowId;
    const res = await fetch(url, {
        method: 'PATCH',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(fields)
    });
    console.log('[dbPatch] response status='+res.status);
    if(!res.ok){
        const err = await res.text();
        throw new Error('PATCH failed '+res.status+': '+err);
    }
    return true;
}

// Check if row exists for date+name, then insert or patch
async function dbUpsertByDateName(row){
    const existing = dbRows.find(d => d.date === row.date && d.name === row.name);
    if(existing){
        // Update existing row â€” only overwrite non-resolution fields; keep resolution/reason
        return dbPatch(existing.id, {
            team: row.team,
            status: row.status,
            login: row.login,
            logout: row.logout,
            working_hours: row.working_hours,
            // preserve existing resolution/reason
            resolution: existing.resolution,
            reason: existing.reason,
            resolved_at: existing.resolved_at
        });
    } else {
        const {id, ...payload} = row;
        return dbInsert(payload);
    }
}

async function dbDeleteAll(){
    return sbFetch(TABLE + '?date=gte.0000-00-00', {
        method: 'DELETE'
    });
}

async function dbDeleteByDate(dateStr){
    return sbFetch(TABLE + '?date=eq.' + encodeURIComponent(dateStr), {
        method: 'DELETE'
    });
}

// Bulk insert multiple violation_history rows in ONE request
async function dbBulkInsertViolations(rows){
    if(!rows.length) return [];
    const payload = rows.map(({id,...r})=>r);
    const url = SUPABASE_URL + '/rest/v1/' + TABLE;
    const res = await fetch(url, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'   // return inserted rows so we get their IDs
        },
        body: JSON.stringify(payload)
    });
    if(!res.ok){ const e=await res.text(); throw new Error('Bulk insert failed: '+e); }
    const text = await res.text();
    return text ? JSON.parse(text) : [];
}

// â”€â”€ Attendance DB helpers â”€â”€
async function dbLoadAttendance(dateStr){
    return sbFetch(ATTEND_TABLE + '?date=eq.' + encodeURIComponent(dateStr) + '&order=name.asc&select=*');
}
async function dbSaveAttendance(row){
    // PATCH if id exists, else INSERT
    if(row.id){
        return sbFetch(ATTEND_TABLE + '?id=eq.' + row.id, {
            method:'PATCH', prefer:'return=minimal', body: JSON.stringify(row)
        });
    } else {
        const {id, ...payload} = row;
        return sbFetch(ATTEND_TABLE, {
            method:'POST', prefer:'return=minimal', body: JSON.stringify(payload)
        });
    }
}
async function dbDeleteAttendance(id){
    return sbFetch(ATTEND_TABLE + '?id=eq.' + id, { method:'DELETE' });
}
async function dbLoadAttendanceDates(){
    // Get distinct dates from attendance table
    return sbFetch(ATTEND_TABLE + '?select=date&order=date.desc');
}

// Bulk insert many attendance rows in ONE request â€” much faster than one-by-one
async function dbBulkInsertAttendance(rows){
    if(!rows.length) return;
    // Strip any id fields â€” let Supabase generate them
    const payload = rows.map(({id, ...r}) => r);
    return sbFetch(ATTEND_TABLE, {
        method: 'POST',
        prefer: 'return=minimal',
        body: JSON.stringify(payload)
    });
}

// Delete all slack-auto-saved attendance for a date so we can re-insert fresh
async function dbDeleteSlackAttendanceForDate(dateStr){
    return sbFetch(ATTEND_TABLE + '?date=eq.' + encodeURIComponent(dateStr) + '&source=eq.slack', {
        method: 'DELETE'
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_TEAMS={
    annotation:[
        "Ramyashree Ragupathy","Manoj kumar","Kalyani Dande","Sandhya D","Koteswari","Hari","Uma",
        "Manjunath Bandihal","Akshay Phatale","Maitra Salimath","YATHISH GOWDA KH","Pavan Yeddala",
        "sabarmathi","G umesh","Shilpa E","Prema Joshi","Keerti Doddwad","Ajayreddy","Varun Kumar H N",
        "Sneha B V","Fathima Reneesha P","Vishruthi Raghu","Sanjana G P","Dhanyasri as","Siddharth Anandan",
        "Bindu Sree","Anilkumar","Mihir","Suzan John","Umesh Barker","HR SUNIL KUMAR","Shanta mantri",
        "Nandini Keni","Shweta k","Kishore Devaragudi","ANIL GANDREDDI","K Ganesh","kirany","Vishwas Reddy"
    ],
    assessment:[
        "Sandhya K","Venkatesh Chilukuri","Gowthami TP","Jagadish","kaushik","Ishika","Ramyashree A",
        "Jobin Johnson","Divya K","Sujan Debnath","Sajina NM","Shivaranjani Hiremath","M.Sarvani",
        "vengatesan","V Srividhya","sunkavalli Gayatri","Aashvi"
    ]
};

const LS_TEAMS = 'slackTracker_teams_v1';
let teams = {annotation:[],assessment:[]};
let dbRows = [];   // flat array from Supabase
let lastReport = [];
let activeEmpTab = 'annotation';
let activeViewTab = 'all';
let editContext = null;
let selectedResolution = 'violation';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC STATUS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncStatus(state, msg){
    const bar=document.getElementById('syncBar');
    const dot=document.getElementById('syncDot');
    const txt=document.getElementById('syncMsg');
    bar.className='sync-bar '+(state==='ok'?'':state);
    dot.className='sync-dot '+(state==='ok'?'':state);
    txt.textContent=msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD FROM SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFromCloud(){
    setSyncStatus('loading','Loading shared history from cloudâ€¦');
    try{
        dbRows = await dbLoad();
        const active = dbRows.filter(r=>r.resolution==='violation').length;
        setSyncStatus('ok','âœ… Connected â€” '+active+' active violation'+(active!==1?'s':'')+' | '+dbRows.length+' total records.');
        renderHistory(getHistFilters());
        renderDateManager();
        refreshAttendDateSelect();
    } catch(e){
        setSyncStatus('error','âŒ Could not connect to database. Check your API key. â€” '+e.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE VIOLATIONS TO CLOUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveViolationsForDate(dateStr, report){
    setSyncStatus('loading','Saving to cloudâ€¦');
    try{
        const toInsert = [];
        const toUpdate = [];

        for(const r of report){
            const cleanLogin  = r.login  === 'âŒ No login'  ? '' : (r.login  || '');
            const cleanLogout = r.logout === 'âŒ No logout' ? '' : (r.logout || '');

            // Determine resolution:
            // - violations (Missing/Incomplete/Half Day) â†’ 'violation'
            // - everyone else (Full Day, On Leave) â†’ 'present'  â† NEW: saved so attendance works
            const isViol = r.status==='Missing' || r.status==='Incomplete' || r.status==='Half Day';
            const existing = dbRows.find(d => d.date===dateStr && d.name===r.name);

            const row = {
                date: dateStr, name: r.name, team: r.team,
                status: r.status,
                login: cleanLogin, logout: cleanLogout,
                working_hours: r.workingHours || '-',
                // preserve existing resolution/reason if already resolved by user
                resolution: existing ? (existing.resolution==='violation' && !isViol ? 'present' : existing.resolution || (isViol?'violation':'present')) : (isViol ? 'violation' : 'present'),
                reason: existing ? (existing.reason || '') : '',
                resolved_at: existing ? (existing.resolved_at || '') : ''
            };

            if(existing){
                toUpdate.push({id: existing.id, row: {
                    team: row.team, status: row.status,
                    login: row.login, logout: row.logout, working_hours: row.working_hours,
                    resolution: row.resolution, reason: row.reason, resolved_at: row.resolved_at
                }});
            } else {
                toInsert.push(row);
            }
        }

        // Bulk insert new rows + parallel PATCH existing â€” both in one await
        const [inserted] = await Promise.all([
            toInsert.length ? dbBulkInsertViolations(toInsert) : Promise.resolve([]),
            Promise.all(toUpdate.map(u => dbPatch(u.id, u.row).catch(e=>console.warn('patch fail',e))))
        ]);

        // Update local dbRows cache â€” no cloud reload needed
        if(Array.isArray(inserted)) inserted.forEach(row => {
            const idx = dbRows.findIndex(d=>d.date===row.date&&d.name===row.name);
            if(idx===-1) dbRows.push(row); else dbRows[idx]=row;
        });
        toUpdate.forEach(u => {
            const idx = dbRows.findIndex(d=>d.id===u.id);
            if(idx!==-1) Object.assign(dbRows[idx], u.row);
        });

        const active = dbRows.filter(r=>r.resolution==='violation').length;
        setSyncStatus('ok','âœ… Saved â€” '+active+' active violation'+(active!==1?'s':'')+' in cloud.');
        renderHistory(getHistFilters());
        renderDateManager();
        refreshAttendDateSelect();

    } catch(e){
        setSyncStatus('error','âŒ Save failed: '+e.message);
        console.error('saveViolationsForDate error:', e);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE RESOLUTION IN CLOUD  â€” uses PATCH by row id (reliable update)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveResolutionToCloud(date, name, resolution, reason){
    setSyncStatus('loading','Saving resolution to cloudâ€¦');
    try{
        // Find the row in our local cache
        const idx = dbRows.findIndex(d => d.date === date && d.name === name);
        if(idx === -1 || !dbRows[idx].id){
            setSyncStatus('error','âŒ Record not found. Click ğŸ”„ Refresh and try again.');
            return;
        }
        const rowId = dbRows[idx].id;
        const resolvedAt = resolution !== 'violation' ? new Date().toLocaleString() : '';

        // STEP 1: Send PATCH to Supabase
        await dbPatch(rowId, {
            resolution:  resolution,
            reason:      reason,
            resolved_at: resolvedAt
        });

        // STEP 2: Update local cache immediately â€” no waiting for server reload
        dbRows[idx].resolution  = resolution;
        dbRows[idx].reason      = reason;
        dbRows[idx].resolved_at = resolvedAt;

        // STEP 3: Switch filter to Active Violations Only so resolved records hide
        if(resolution !== 'violation'){
            document.getElementById('histTypeFilter').value = 'active';
        }

        // STEP 4: Re-render right away using updated local data
        renderHistory(getHistFilters());
        updateHistBadge();

        const label = resolution === 'violation' ? 'Reverted to Violation' :
                      resolution === 'On Leave'  ? 'Marked as On Leave'    : 'Marked as Ignored';
        setSyncStatus('ok', 'âœ… ' + label + ' for ' + name + ' â€” saved & synced.');

        // STEP 5: Background reload from cloud to confirm (does not block UI)
        setTimeout(() => loadFromCloud().catch(e => console.warn('BG reload:', e)), 1500);

    } catch(e){
        setSyncStatus('error', 'âŒ Could not save: ' + e.message);
        console.error('[saveResolution] ERROR:', e);
    }
}
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isActive(v){ return v.resolution==='violation'; }

function longestStreak(violations){
    const active=violations.filter(isActive);
    if(!active.length) return 0;
    const dates=[...new Set(active.map(v=>v.date))].sort();
    if(dates.length===1) return 1;
    let max=1,cur=1;
    for(let i=1;i<dates.length;i++){
        const d=(new Date(dates[i])-new Date(dates[i-1]))/86400000;
        if(d===1){cur++;max=Math.max(max,cur);}else cur=1;
    }
    return max;
}

function updateHistBadge(){
    const active=dbRows.filter(isActive).length;
    document.getElementById('histTotalBadge').textContent=active+' active violation'+(active!==1?'s':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATE MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDateManager(){
    const sel = document.getElementById('dateSelect');
    if(!sel) return;

    // Remember current selection
    const prev = sel.value;

    // Get unique dates sorted newest first
    const dates = [...new Set(dbRows.map(r=>r.date))].sort().reverse();

    sel.innerHTML = '<option value="">â€” Select a date â€”</option>';
    dates.forEach(date=>{
        const rows   = dbRows.filter(r=>r.date===date);
        const active = rows.filter(isActive).length;
        const total  = rows.length;
        const opt    = document.createElement('option');
        opt.value    = date;
        opt.textContent = formatDate(date) + '  (' + active + ' active / ' + total + ' total)';
        sel.appendChild(opt);
    });

    // Restore previous selection if still valid
    if(prev && dates.includes(prev)) sel.value = prev;
    onDateSelectChange();
}

function onDateSelectChange(){
    const sel      = document.getElementById('dateSelect');
    const dateStr  = sel.value;
    const meta     = document.getElementById('dateMeta');
    const reBtn    = document.getElementById('dateReenterBtn');
    const delBtn   = document.getElementById('dateDeleteBtn');

    if(!dateStr){
        meta.textContent = '';
        reBtn.disabled = true;
        delBtn.disabled = true;
        return;
    }

    const rows     = dbRows.filter(r=>r.date===dateStr);
    const active   = rows.filter(isActive).length;
    const resolved = rows.length - active;
    const parts    = [];
    if(active)   parts.push(active+' active violation'+(active!==1?'s':''));
    if(resolved) parts.push(resolved+' resolved');
    meta.textContent = parts.length ? parts.join(' Â· ') : 'No violations on this date';
    reBtn.disabled = false;
    delBtn.disabled = false;
}

function preloadSelectedDate(){
    const dateStr = document.getElementById('dateSelect').value;
    if(!dateStr) return;
    document.getElementById('reportDate').value = dateStr;
    document.getElementById('slackInput').value = '';
    window.scrollTo({top:0, behavior:'smooth'});
    showToast('ğŸ“… Date set to '+formatDate(dateStr)+' â€” paste fresh Slack data and click Process.');
}

function deleteSelectedDate(){
    const dateStr = document.getElementById('dateSelect').value;
    if(!dateStr) return;
    const count = dbRows.filter(r=>r.date===dateStr).length;
    openConfirm(
        'Delete Date',
        'This will permanently delete <strong>all '+count+' records</strong> for <strong>'+formatDate(dateStr)+'</strong>.<br><br>You can then paste fresh data for this date.',
        async ()=>{
            setSyncStatus('loading','Deleting records for '+formatDate(dateStr)+'â€¦');
            try{
                // Delete violation_history and attendance_records for this date in parallel
                await Promise.all([
                    dbDeleteByDate(dateStr),
                    sbFetch(ATTEND_TABLE+'?date=eq.'+encodeURIComponent(dateStr), {method:'DELETE'}).catch(()=>{})
                ]);
                // Remove from local cache
                dbRows = dbRows.filter(r=>r.date!==dateStr);
                attendRows = attendRows.filter(r=>r.date!==dateStr);
                renderHistory(getHistFilters());
                renderDateManager();
                refreshAttendDateSelect();
                document.getElementById('reportDate').value = dateStr;
                showToast('ğŸ—‘ï¸ Deleted records for '+formatDate(dateStr)+'. Paste fresh data and click Process.');
                setSyncStatus('ok','âœ… Date deleted.');
            } catch(e){
                setSyncStatus('error','âŒ Delete failed: '+e.message);
            }
        }
    );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditModal(date, name){
    const v = dbRows.find(d=>d.date===date && d.name===name);
    if(!v) return;
    editContext = {date, name};
    selectedResolution = v.resolution||'violation';

    document.getElementById('editInfoBox').innerHTML=`
        <div class="vi-row"><span>Employee</span><strong>${esc(v.name)}</strong></div>
        <div class="vi-row"><span>Date</span><strong>${formatDate(date)}</strong></div>
        <div class="vi-row"><span>Team</span><strong>${teamLabel(v.team)}</strong></div>
        <div class="vi-row"><span>Original Status</span><strong>${v.status}</strong></div>
        <div class="vi-row"><span>Login</span><strong>${v.login}</strong></div>
        <div class="vi-row"><span>Logout</span><strong>${v.logout}</strong></div>`;

    document.getElementById('editReason').value = v.reason||'';
    updateResOptions(); updateReasonLabel();
    document.getElementById('editOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('editReason').focus(),100);
}

function updateResOptions(){
    document.getElementById('resOptViolation').className='res-option'+(selectedResolution==='violation'?' selected-violation':'');
    document.getElementById('resOptLeave').className='res-option'+(selectedResolution==='On Leave'?' selected-on-leave':'');
    document.getElementById('resOptIgnored').className='res-option'+(selectedResolution==='Ignored'?' selected-ignored':'');
}

function updateReasonLabel(){
    document.getElementById('editReasonRequired').style.display=selectedResolution!=='violation'?'inline':'none';
}

async function saveEdit(){
    const reason = document.getElementById('editReason').value.trim();
    const ta = document.getElementById('editReason');
    ta.classList.remove('required-shake');
    if(selectedResolution!=='violation' && !reason){
        void ta.offsetWidth; ta.classList.add('required-shake'); ta.focus(); return;
    }

    // âš ï¸ Capture BEFORE closing modal â€” closeEditModal sets editContext to null
    const savedDate = editContext.date;
    const savedName = editContext.name;
    const savedResolution = selectedResolution;

    closeEditModal();

    await saveResolutionToCloud(savedDate, savedName, savedResolution, reason);

    const label = savedResolution==='violation' ? 'reverted to Violation' :
                  savedResolution==='On Leave'  ? 'marked as On Leave'    : 'marked as Ignored';
    showToast('âœ… ' + savedName + ' â€” ' + label + ' (synced to cloud)');
}

function closeEditModal(){ document.getElementById('editOverlay').classList.remove('open'); editContext=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory(filters={}){
    updateHistBadge();
    renderDateManager();
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];

    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from) violations=violations.filter(v=>v.date>=from);
    if(to)   violations=violations.filter(v=>v.date<=to);

    const active   =violations.filter(isActive).length;
    const resolved =violations.filter(v=>!isActive(v)).length;
    const onLeave  =violations.filter(v=>v.resolution==='On Leave').length;
    const ignored  =violations.filter(v=>v.resolution==='Ignored').length;
    const uniqueEmp=new Set(violations.map(v=>v.name)).size;
    const uniqueDays=new Set(violations.map(v=>v.date)).size;

    document.getElementById('histSummary').innerHTML=`
        <div class="hist-stat"><div class="hv">${violations.length}</div><div class="hl">Total Records</div></div>
        <div class="hist-stat"><div class="hv">${active}</div><div class="hl">Active Violations</div></div>
        <div class="hist-stat"><div class="hv" style="color:#27ae60">${resolved}</div><div class="hl">Resolved</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6c757d">${onLeave}</div><div class="hl">On Leave</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6f42c1">${ignored}</div><div class="hl">Ignored</div></div>
        <div class="hist-stat"><div class="hv" style="color:#e67e22">${uniqueEmp}</div><div class="hl">Employees</div></div>
        <div class="hist-stat"><div class="hv" style="color:#1a4d8c">${uniqueDays}</div><div class="hl">Days</div></div>`;

    const content=document.getElementById('histContent');
    if(!violations.length){content.innerHTML='<div class="no-history">ğŸ‰ No records match the current filters.</div>';return;}

    const byEmp={};
    violations.forEach(v=>{
        if(!byEmp[v.name]) byEmp[v.name]={name:v.name,team:v.team,violations:[]};
        byEmp[v.name].violations.push(v);
    });

    const sorted=Object.values(byEmp).sort((a,b)=>
        b.violations.filter(isActive).length - a.violations.filter(isActive).length
    );

    content.innerHTML=sorted.map((emp,i)=>{
        const activeV=emp.violations.filter(isActive).length;
        const resolvedV=emp.violations.filter(v=>!isActive(v)).length;
        const streak=longestStreak(emp.violations);
        const streakBadge=streak>=3?`<span class="hist-streak">ğŸ”¥ ${streak}-day streak</span>`:'';
        const teamBadge=`<span class="team-badge ${emp.team}">${emp.team==='annotation'?'Annotation':'Assessment'}</span>`;
        const activeBadge=activeV?`<span class="hist-violations-count">${activeV} active</span>`:'';
        const resolvedBadge=resolvedV?`<span class="hist-resolved-count">${resolvedV} resolved</span>`:'';

        const rows=emp.violations.sort((a,b)=>b.date.localeCompare(a.date)).map(v=>{
            const res=v.resolution||'violation';
            const rowClass=res==='violation'
                ?`viol-row-${v.status.toLowerCase()}`
                :`viol-row-resolved-${res.toLowerCase().replace(' ','-')}`;

            let resBadge='';
            if(res==='On Leave') resBadge=`<span class="res-badge res-leave">ğŸ“… On Leave</span>`;
            else if(res==='Ignored') resBadge=`<span class="res-badge res-ignored">ğŸ”• Ignored</span>`;

            const reasonHtml=v.reason?`<div class="res-reason">ğŸ’¬ ${esc(v.reason)}</div>`:'';
            const resolvedAtHtml=v.resolved_at?`<div class="res-reason">ğŸ• ${v.resolved_at}</div>`:'';

            const statusHtml=res==='violation'
                ?`<span class="status-badge status-${v.status.toLowerCase()}">${v.status==='Missing'?'â“':'âš ï¸'} ${v.status}</span>`
                :`${resBadge}<div style="font-size:11px;color:#888;margin-top:3px;">was: ${v.status}</div>`;

            return`<tr class="${rowClass}">
                <td>${formatDate(v.date)}</td>
                <td>${statusHtml}${reasonHtml}${resolvedAtHtml}</td>
                <td><span class="time-badge">${v.login}</span></td>
                <td><span class="time-badge">${v.logout}</span></td>
                <td>${v.working_hours}</td>
                <td><button class="btn btn-xs btn-secondary"
                    onclick="openEditModal('${v.date}','${v.name.replace(/'/g,"\\'")}')">âœï¸ Edit</button></td>
            </tr>`;
        }).join('');

        return`<div class="hist-emp-block">
            <div class="hist-emp-header" onclick="toggleHistBlock('hb${i}')">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span class="hist-emp-name">${esc(emp.name)}</span>${teamBadge}
                </div>
                <div class="hist-emp-meta">${streakBadge}${activeBadge}${resolvedBadge}
                    <span style="color:#aaa;font-size:13px;">â–¼</span>
                </div>
            </div>
            <div class="hist-emp-body" id="hb${i}">
                <table class="hist-table"><thead><tr>
                    <th>Date</th><th>Status / Resolution</th><th>Login</th><th>Logout</th><th>Hours</th><th>Action</th>
                </tr></thead><tbody>${rows}</tbody></table>
            </div>
        </div>`;
    }).join('');
}

function toggleHistBlock(id){const el=document.getElementById(id);if(el)el.classList.toggle('open');}

function formatDate(d){
    if(!d)return'-';
    return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
}
function getDayName(d){
    if(!d)return'';
    return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{weekday:'long'});
}
function formatDateWithDay(d){
    if(!d)return'';
    return getDayName(d)+', '+formatDate(d);
}

function getHistFilters(){
    return{team:document.getElementById('histTeamFilter').value,
           type:document.getElementById('histTypeFilter').value,
           from:document.getElementById('histFromDate').value,
           to:  document.getElementById('histToDate').value};
}

function exportHistoryCSV(filters={}){
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];
    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from)violations=violations.filter(v=>v.date>=from);
    if(to)  violations=violations.filter(v=>v.date<=to);
    if(!violations.length){showToast('No records to export.');return;}
    let csv='Date,Employee,Team,Original Status,Resolution,Login,Logout,Working Hours,Reason,Resolved At\n';
    violations.forEach(v=>{
        csv+=`"${v.date}","${v.name}","${teamLabel(v.team)}","${v.status}","${v.resolution}","${v.login}","${v.logout}","${v.working_hours}","${(v.reason||'').replace(/"/g,'""')}","${v.resolved_at||''}"\n`;
    });
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`violation-history-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPLOYEE MANAGEMENT  (stays in localStorage â€” same for all)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTeams(){
    try{const r=localStorage.getItem(LS_TEAMS);if(r){const p=JSON.parse(r);if(p&&p.annotation&&p.assessment){teams=p;return;}}}catch(e){}
    teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
}
function saveTeams(){try{localStorage.setItem(LS_TEAMS,JSON.stringify(teams));}catch(e){}}

function renderEmpGrid(){
    const list=[...teams[activeEmpTab]].sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    document.getElementById('countAnnotation').textContent=teams.annotation.length;
    document.getElementById('countAssessment').textContent=teams.assessment.length;
    document.getElementById('empCount').textContent=teams.annotation.length+teams.assessment.length;
    const grid=document.getElementById('empGrid');
    if(!list.length){grid.innerHTML='<p style="color:#bbb;font-size:13px;grid-column:1/-1;padding:10px 0;">No employees yet.</p>';return;}
    grid.innerHTML=list.map(name=>`
        <div class="emp-chip ${activeEmpTab}">
            <span class="emp-name" title="${esc(name)}">${esc(name)}</span>
            <button class="remove-btn" data-name="${esc(name)}" title="Remove">âœ•</button>
        </div>`).join('');
    grid.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',()=>confirmRemove(btn.dataset.name,activeEmpTab)));
    document.getElementById('newEmpTeam').value=activeEmpTab;
}

function switchEmpTab(t){
    activeEmpTab=t;
    document.getElementById('tabAnnotation').className='team-tab'+(t==='annotation'?' active-annotation':'');
    document.getElementById('tabAssessment').className='team-tab'+(t==='assessment'?' active-assessment':'');
    renderEmpGrid();
}

function addEmployee(){
    const input=document.getElementById('newEmpInput');
    const team=document.getElementById('newEmpTeam').value;
    const name=input.value.trim();
    input.classList.remove('shake');
    if(!name){void input.offsetWidth;input.classList.add('shake');input.focus();return;}
    if(allEmployees().some(e=>e.toLowerCase()===name.toLowerCase())){showToast(`âš ï¸ "${name}" already exists`);input.select();return;}
    teams[team].push(name);saveTeams();switchEmpTab(team);input.value='';input.focus();
    showToast(`âœ… "${name}" added to ${teamLabel(team)}`);
}

function confirmRemove(name,team){
    openConfirm('Remove Employee',`Remove <strong>${esc(name)}</strong> from ${teamLabel(team)}?`,()=>{
        teams[team]=teams[team].filter(e=>e!==name);saveTeams();renderEmpGrid();showToast(`ğŸ—‘ï¸ "${name}" removed`);
    });
}

function resetToDefaults(){
    openConfirm('Reset to Defaults','Replace both team lists with the original default employees?',()=>{
        teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
        saveTeams();renderEmpGrid();showToast('â†© Reset to defaults');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dbg=[];
function addDebug(m){_dbg.push(m);}
function clearDebug(){_dbg=[];}
function flushDebug(){document.getElementById('debugInfo').innerHTML=_dbg.join('<br>');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function norm(n){return n.trim().toLowerCase().replace(/\s+/g,' ');}
function allEmployees(){return[...teams.annotation,...teams.assessment];}
function teamLabel(t){return t==='annotation'?'Data Annotation':'Data Assessment / DA';}
function getTeam(name){
    const n=norm(name);
    if(teams.annotation.some(e=>norm(e)===n))return 'annotation';
    if(teams.assessment.some(e=>norm(e)===n))return 'assessment';
    return null;
}
function findEmployee(rawName){
    const n=norm(rawName);const all=allEmployees();
    return all.find(e=>norm(e)===n)||all.find(e=>n.includes(norm(e))||norm(e).includes(n))||rawName;
}
function timeToMinutes(str){
    if(!str)return null;
    str=str.trim().toUpperCase().replace(/\./g,':').replace(/\s+/g,' ').replace(/(\d)([AP]M)/,'$1 $2');
    const pm=str.includes('PM'),am=str.includes('AM');
    str=str.replace(/[AP]M/,'').trim();
    let[h,m]=str.split(':');h=parseInt(h,10);m=parseInt(m,10)||0;
    if(isNaN(h))return null;
    if(pm&&h!==12)h+=12;if(am&&h===12)h=0;
    return h*60+m;
}

let _tt=null;
function showToast(msg){const t=document.getElementById('toast');t.innerHTML=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2800);}

let _ccb=null;
function openConfirm(title,msg,cb){
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').innerHTML=msg;
    document.getElementById('confirmOverlay').classList.add('open');_ccb=cb;
}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('open');_ccb=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseMessages(rawText){
    clearDebug();addDebug('=== Parsing ===');
    const lines=rawText.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    const headerRe=/^(.+?)\s+\[(\d{1,2}:\d{2}\s*[AP]M)\]\s*$/i;
    const msgs=[];let cur=null;
    function flush(){
        if(!cur)return;
        const body=cur.lines.join('\n');
        if(/\bon\s+leave\b/i.test(body)){msgs.push({name:cur.name,type:'leave'});return;}
        if(/\b(in\s+working|working\s+on)\b/i.test(body)||/\blogin\b/i.test(body)){msgs.push({name:cur.name,type:'login',time:cur.time});return;}
        if(/\bworked\s+on\b/i.test(body)||/\blogout\b/i.test(body)){msgs.push({name:cur.name,type:'logout',time:cur.time});return;}
    }
    for(const rawLine of lines){
        const line=rawLine.trim();if(!line)continue;
        const hm=line.match(headerRe);
        if(hm){flush();cur={name:findEmployee(hm[1].trim()),time:hm[2].replace(/\s+/g,' '),lines:[]};}
        else if(cur){cur.lines.push(line);if(/\bon\s+leave\b/i.test(line)){flush();cur=null;}}
    }
    flush();addDebug(`Events: ${msgs.length}`);flushDebug();return msgs;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ Determine attendance status based on working hours â”€â”€
// < 4.5 hrs  â†’ Half Day
// 4.5â€“7.5 hrs â†’ Incomplete (present but short)
// > 7.5 hrs  â†’ Full Day
// No login or logout â†’ Missing / Incomplete (unchanged)
function getAttendanceStatus(login, logout, hasLogin, hasLogout){
    if(!hasLogin && !hasLogout) return { status:'Missing',    statusClass:'status-missing',    icon:'â“', attendStatus:'Absent'    };
    if(!hasLogin || !hasLogout) return { status:'Incomplete', statusClass:'status-incomplete', icon:'âš ï¸', attendStatus:'Incomplete' };

    const a = timeToMinutes(login), b = timeToMinutes(logout);
    if(a === null || b === null)   return { status:'Incomplete', statusClass:'status-incomplete', icon:'âš ï¸', attendStatus:'Incomplete' };

    const diffMins = (b < a ? b + 1440 : b) - a;
    const hrs      = diffMins / 60;

    if(hrs < 4.5)  return { status:'Half Day',  statusClass:'status-halfday',  icon:'ğŸŒ“', attendStatus:'Half Day'  };
    if(hrs >= 7.5) return { status:'Full Day',  statusClass:'status-complete', icon:'âœ…', attendStatus:'Full Day'  };
                   return { status:'Incomplete', statusClass:'status-incomplete', icon:'âš ï¸', attendStatus:'Incomplete' };
}

function buildReport(msgs){
    const state={};
    allEmployees().forEach(n=>{state[n]={logins:[],logouts:[],onLeave:false};});
    msgs.forEach(m=>{
        const s=state[m.name];if(!s)return;
        if(m.type==='leave')s.onLeave=true;
        if(m.type==='login')s.logins.push(m.time);
        if(m.type==='logout')s.logouts.push(m.time);
    });
    return Object.keys(state).sort().map(name=>{
        const s=state[name];const team=getTeam(name)||'annotation';
        if(s.onLeave)return{name,team,login:'-',logout:'-',workingHours:'-',status:'On Leave',statusClass:'status-leave',icon:'ğŸ“…'};
        const login=s.logins.sort((a,b)=>(timeToMinutes(a)||0)-(timeToMinutes(b)||0))[0]||null;
        const logout=s.logouts.sort((a,b)=>(timeToMinutes(b)||0)-(timeToMinutes(a)||0))[0]||null;
        let hours='-';
        if(login&&logout){const d=timeToMinutes(logout)-timeToMinutes(login);hours=((d<0?d+1440:d)/60).toFixed(2)+' hrs';}
        const {status,statusClass,icon} = getAttendanceStatus(login, logout, !!login, !!logout);
        return{name,team,login:login||'âŒ No login',logout:logout||'âŒ No logout',workingHours:hours,status,statusClass,icon};
    });
}

function calcStats(rows){
    const total    = rows.length,
          fullDay  = rows.filter(r=>r.status==='Full Day').length,
          halfDay  = rows.filter(r=>r.status==='Half Day').length,
          inc      = rows.filter(r=>r.status==='Incomplete').length,
          leave    = rows.filter(r=>r.status==='On Leave').length,
          miss     = rows.filter(r=>r.status==='Missing').length,
          rate     = total?((fullDay/total)*100).toFixed(1):'0';
    return{total,fullDay,halfDay,inc,leave,miss,rate};
}
function renderStats(rows){
    const s=calcStats(rows);
    document.getElementById('statsContainer').innerHTML=`
        <div class="stat-card"><h3>Total</h3><div class="value">${s.total}</div></div>
        <div class="stat-card"><h3>âœ… Full Day</h3><div class="value complete">${s.fullDay}</div></div>
        <div class="stat-card"><h3>ğŸŒ“ Half Day</h3><div class="value incomplete">${s.halfDay}</div></div>
        <div class="stat-card"><h3>âš ï¸ Incomplete</h3><div class="value incomplete">${s.inc}</div></div>
        <div class="stat-card"><h3>ğŸ“… On Leave</h3><div class="value leave">${s.leave}</div></div>
        <div class="stat-card"><h3>âŒ Missing</h3><div class="value missing">${s.miss}</div></div>
        <div class="stat-card"><h3>Full Day %</h3><div class="value">${s.rate}%</div></div>`;
}
function empRow(e){
    return`<tr>
        <td><strong>${esc(e.name)}</strong></td>
        <td><span class="team-badge ${e.team}">${e.team==='annotation'?'Annotation':'Assessment'}</span></td>
        <td><span class="status-badge ${e.statusClass}">${e.icon} ${e.status}</span></td>
        <td><span class="time-badge">${e.login}</span></td>
        <td><span class="time-badge">${e.logout}</span></td>
        <td><strong>${e.workingHours}</strong></td>
    </tr>`;
}
function renderView(view){
    activeViewTab=view;
    document.querySelectorAll('.view-tab').forEach(t=>{const v=t.dataset.view;t.className='view-tab'+(v===view?' active-'+view:'');});

    // Violations tab â€” only show Missing/Incomplete/Half Day employees
    if(view==='violations'){
        const viols = lastReport.filter(r=>r.status==='Missing'||r.status==='Incomplete'||r.status==='Half Day');
        document.getElementById('statsLabel').textContent = 'ğŸš¨ Violations Only';
        renderStats(viols);
        if(!viols.length){
            document.getElementById('tableContainer').innerHTML='<p style="padding:20px;color:#27ae60;font-weight:600;text-align:center;">âœ… No violations for this date!</p>';
            return;
        }
        const ann=viols.filter(r=>r.team==='annotation'), ass=viols.filter(r=>r.team==='assessment');
        let rows='';
        if(ann.length) rows+=`<tr class="team-header-row annotation"><td colspan="6">ğŸ”µ Data Annotation â€” Violations (${ann.length})</td></tr>`+ann.map(empRow).join('');
        if(ass.length) rows+=`<tr class="team-header-row assessment"><td colspan="6">ğŸŸ  Data Assessment â€” Violations (${ass.length})</td></tr>`+ass.map(empRow).join('');
        document.getElementById('tableContainer').innerHTML=`
            <table><thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th></tr></thead>
            <tbody>${rows}</tbody></table>`;
        return;
    }

    const filtered=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    document.getElementById('statsLabel').textContent=view==='all'?'All Employees':view==='annotation'?'Data Annotation':'Data Assessment / DA';
    renderStats(filtered);
    if(!filtered.length){document.getElementById('tableContainer').innerHTML='<p style="padding:20px;color:#aaa;">No data.</p>';return;}
    let rows='';
    if(view==='all'){
        const ann=filtered.filter(r=>r.team==='annotation'),ass=filtered.filter(r=>r.team==='assessment');
        rows+=`<tr class="team-header-row annotation"><td colspan="6">ğŸ”µ Data Annotation Team (${ann.length})</td></tr>`+ann.map(empRow).join('');
        rows+=`<tr class="team-header-row assessment"><td colspan="6">ğŸŸ  Data Assessment / DA Team (${ass.length})</td></tr>`+ass.map(empRow).join('');
    }else rows=filtered.map(empRow).join('');
    document.getElementById('tableContainer').innerHTML=`
        <table><thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th></tr></thead>
        <tbody>${rows}</tbody></table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sampleData1=`Ramyashree Ragupathy  [8:59 AM]
In working on car parts updates
Koteswari  [9:09 AM]
Working on all_new_car_parts _rear bumper review.
Anilkumar  [9:09 AM]
Working on all_new_car_parts_rear_bumper annotation.
Manoj kumar  [9:13 AM]
Working on volvo_pov_damage_2 Annotation.
Hari  [9:19 AM]
In working on VOLVO_POV_damage Review.
Kalyani Dande  [9:24 AM]
Working on all_new_car_parts_rear_bumper annotation.
Uma  [9:29 AM]
Working on all new car parts annotation.
Koteswari  [6:11 PM]
Worked on all_new_car_parts _rear bumper review.
Anilkumar  [6:11 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Hari  [6:18 PM]
Worked on VOLVO_POV_damage Review.
Manoj kumar  [6:21 PM]
Worked on volvo_pov_damage_2 Annotation.
Kalyani Dande  [6:25 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Uma  [6:30 PM]
Worked on all new car parts annotation.
Ramyashree Ragupathy  [6:37 PM]
Worked on car parts updates`;

const sampleData2=`Ishika  [7:16 AM]
Login - Working on: Production portals
Remarks: Nil
Jobin Johnson  [8:00 AM]
Login - Working on: Work hours 08:00 AM
Remarks: Nil
Jagadish  [8:04 AM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [8:31 AM]
Login - Working on: Production portals
Remarks: Nil
Sandhya K  [9:01 AM]
On leave
sunkavalli Gayatri  [9:28 AM]
Login - Working on: Production portal
Remarks: Nil
Gowthami TP  [9:29 AM]
Login - Working on: Pilot Portals
Remarks: Nil
Sajina NM  [9:32 AM]
Login - Working on: Production portals
Remarks: Nil
vengatesan  [9:56 AM]
On leave
M.Sarvani  [10:01 AM]
Login-Working on: Production portals
Remarks:Nil
Divya K  [10:59 AM]
Login - Working on: Production portals
Remarks: Nil
Ishika  [5:33 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.
Jobin Johnson  [5:36 PM]
Logout - Worked on: Production Portals
Remarks: Done
Gowthami TP  [6:30 PM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [6:30 PM]
Logout - Worked on: Production Portals
Remarks: 30 mins extra.
Sajina NM  [6:33 PM]
Logout - Worked on: Production Portals
Remarks: NIL
sunkavalli Gayatri  [7:01 PM]
Logout - Worked on: Production Portals
Remarks: Extended 30 mins
M.Sarvani  [7:35 PM]
Logout - Worked on: Production Portals
Remarks: 30mins extra.
Divya K  [8:31 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTENDANCE TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let attendRows = [];        // current date's attendance rows from DB
let attendCurrentDate = ''; // currently selected date
let attendEditId = null;    // id of row being edited (null = new)

// Populate attendance date dropdown â€” merge violation dates + attendance dates
function refreshAttendDateSelect(){
    // Dates come from dbRows (already in memory â€” no extra DB call needed)
    const sel = document.getElementById('attendDateSelect');
    const prev = sel.value;
    const allDates = [...new Set(dbRows.map(r=>r.date))].sort().reverse();
    sel.innerHTML = '<option value="">â€” Pick a date â€”</option>';
    allDates.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = getDayName(d) + ' â€” ' + formatDate(d);
        sel.appendChild(opt);
    });
    if(prev && allDates.includes(prev)) sel.value = prev;
    // Also add current report date if not in list
    const curDate = document.getElementById('reportDate')?.value;
    if(curDate && !allDates.includes(curDate)){
        const opt = document.createElement('option');
        opt.value = curDate; opt.textContent = getDayName(curDate) + ' â€” ' + formatDate(curDate);
        sel.insertBefore(opt, sel.children[1]);
    }
}

async function loadAttendance(){
    const dateStr = document.getElementById('attendDateSelect').value;
    if(!dateStr){
        document.getElementById('attendContent').innerHTML='<div class="no-attend">Select a date above to view attendance.</div>';
        document.getElementById('attendSummary').innerHTML='';
        return;
    }
    attendCurrentDate = dateStr;
    document.getElementById('attendAddBtn').disabled = false;
    document.getElementById('attendExportBtn').disabled = false;
    document.getElementById('attendDeleteDateBtn').disabled = false;
    document.getElementById('attendContent').innerHTML = '<div class="no-attend">Loadingâ€¦</div>';
    try{
        // Only load manual overrides â€” auto attendance is derived from dbRows in memory
        attendRows = await dbLoadAttendance(dateStr);
        populateAttendEmpFilter(); // refresh employee list
        renderAttendance(dateStr);
    } catch(e){
        attendRows = [];
        renderAttendance(dateStr); // still render from memory even if DB fails
    }
}

// â”€â”€ Searchable employee filter â”€â”€
let _empSearchSelected = ''; // currently selected employee name
let _empSearchHighlight = -1;
let _empSearchAll = [];

function populateAttendEmpFilter(){
    _empSearchAll = [...teams.annotation.map(n=>n), ...teams.assessment.map(n=>n)].sort();
    // Keep previous selection if still valid
    if(_empSearchSelected && !_empSearchAll.includes(_empSearchSelected)){
        _empSearchSelected = '';
        document.getElementById('empSearchInput').value = '';
    }
}

function getEmpFilter(){ return _empSearchSelected; }

function onEmpSearchInput(){
    _empSearchHighlight = -1;
    renderEmpDropdown();
    openEmpDropdown();
}

function openEmpDropdown(){
    renderEmpDropdown();
    document.getElementById('empSearchDropdown').classList.add('open');
}

function closeEmpDropdown(){
    document.getElementById('empSearchDropdown').classList.remove('open');
}

function renderEmpDropdown(){
    const q = document.getElementById('empSearchInput').value.trim().toLowerCase();
    const filtered = q ? _empSearchAll.filter(n=>n.toLowerCase().includes(q)) : _empSearchAll;
    const dd = document.getElementById('empSearchDropdown');
    if(!filtered.length){ dd.innerHTML='<div class="emp-search-opt" style="color:#aaa;">No match</div>'; return; }
    dd.innerHTML = (q ? '' : '<div class="emp-search-opt" data-val="" style="color:#888;">All Employees</div>') +
        filtered.map((n,i)=>`<div class="emp-search-opt${n===_empSearchSelected?' selected':''}" data-val="${esc(n)}" data-idx="${i}">${esc(n)}</div>`).join('');
    dd.querySelectorAll('.emp-search-opt').forEach(el=>{
        el.addEventListener('mousedown', e=>{ e.preventDefault(); selectEmpFilter(el.dataset.val); });
    });
}

function selectEmpFilter(name){
    _empSearchSelected = name;
    _empSearchHighlight = -1;
    document.getElementById('empSearchInput').value = name;
    closeEmpDropdown();
    // Show/hide date range row
    const rangeRow = document.getElementById('attendRangeRow');
    rangeRow.style.display = name ? 'flex' : 'none';
    if(!name){ clearEmpDateRange(false); }
    renderAttendanceFiltered();
}

function onEmpSearchKey(e){
    const dd = document.getElementById('empSearchDropdown');
    const opts = dd.querySelectorAll('.emp-search-opt[data-val]');
    if(e.key==='ArrowDown'){ e.preventDefault(); _empSearchHighlight=Math.min(_empSearchHighlight+1,opts.length-1); highlightEmpOpt(opts); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); _empSearchHighlight=Math.max(_empSearchHighlight-1,0); highlightEmpOpt(opts); }
    else if(e.key==='Enter'){ e.preventDefault(); if(_empSearchHighlight>=0&&opts[_empSearchHighlight]) selectEmpFilter(opts[_empSearchHighlight].dataset.val); }
    else if(e.key==='Escape'){ closeEmpDropdown(); }
}

function highlightEmpOpt(opts){
    opts.forEach((o,i)=>o.classList.toggle('highlighted',i===_empSearchHighlight));
    if(opts[_empSearchHighlight]) opts[_empSearchHighlight].scrollIntoView({block:'nearest'});
}

// Close dropdown when clicking outside
document.addEventListener('click', e=>{
    if(!document.getElementById('empSearchWrap')?.contains(e.target)) closeEmpDropdown();
});

function renderAttendanceFiltered(){
    const empName = getEmpFilter();
    if(empName){
        const from = document.getElementById('empRangeFrom').value;
        const to   = document.getElementById('empRangeTo').value;
        renderEmployeeHistory(empName, from, to);
    } else if(attendCurrentDate){
        renderAttendance(attendCurrentDate);
    }
}

// â”€â”€ Date range helpers â”€â”€
function applyEmpDateRange(){
    const from = document.getElementById('empRangeFrom').value;
    const to   = document.getElementById('empRangeTo').value;
    const row  = document.getElementById('attendRangeRow');
    row.classList.toggle('attend-range-active', !!(from||to));
    const label = document.getElementById('empRangeLabel');
    label.textContent = (from&&to) ? formatDate(from)+' â†’ '+formatDate(to) : (from?'From '+formatDate(from):'') || (to?'Until '+formatDate(to):'');
    renderAttendanceFiltered();
}

function clearEmpDateRange(rerender=true){
    document.getElementById('empRangeFrom').value='';
    document.getElementById('empRangeTo').value='';
    document.getElementById('attendRangeRow').classList.remove('attend-range-active');
    document.getElementById('empRangeLabel').textContent='';
    if(rerender) renderAttendanceFiltered();
}

function calcWorkingHours(login, logout){
    if(!login || !logout) return '-';
    const a = timeToMinutes(login), b = timeToMinutes(logout);
    if(a===null || b===null) return '-';
    const diff = (b < a ? b+1440 : b) - a;
    return (diff/60).toFixed(2) + ' hrs';
}

// Show all attendance records across all dates for a single employee
async function renderEmployeeHistory(empName, fromDate='', toDate=''){
    const content = document.getElementById('attendContent');
    const badge   = document.getElementById('attendBadge');
    const rangeLabel = (fromDate||toDate) ? (' Â· '+(fromDate?formatDate(fromDate):'â€¦')+' â†’ '+(toDate?formatDate(toDate):'â€¦')) : ' â€” All Dates';
    badge.textContent = esc(empName) + rangeLabel;
    content.innerHTML = '<div class="no-attend">Loading historyâ€¦</div>';

    try{
        // Load manual overrides from attendance_records for this employee
        const manualRows = await sbFetch(ATTEND_TABLE + '?name=eq.' + encodeURIComponent(empName) + '&source=eq.manual&order=date.desc&select=*').catch(()=>[]);

        // All employee records now stored in dbRows (violation_history table)
        const empDbRows = dbRows.filter(r=>r.name===empName);

        // All dates = union of both sources, filtered by range if set
        let allDates = [...new Set([...manualRows.map(r=>r.date), ...empDbRows.map(r=>r.date)])].sort().reverse();
        if(fromDate) allDates = allDates.filter(d=>d>=fromDate);
        if(toDate)   allDates = allDates.filter(d=>d<=toDate);

        if(!allDates.length){
            content.innerHTML = '<div class="no-attend">No records found for <strong>' + esc(empName) + '</strong>. Process their Slack messages first.</div>';
            document.getElementById('attendSummary').innerHTML = '';
            return;
        }

        const merged = allDates.map(date=>{
            // Manual override wins
            const manual = manualRows.find(r=>r.date===date);
            if(manual) return {...manual, isManual:true};

            // Use violation_history row (now stores everyone)
            const row = empDbRows.find(r=>r.date===date);
            if(row){
                // Map resolution to attendance status
                let attendStatus;
                if(row.resolution==='On Leave')   attendStatus = 'On Leave';
                else if(row.resolution==='present') attendStatus = row.status==='On Leave'?'On Leave':
                    (()=>{
                        const a=timeToMinutes(row.login),b=timeToMinutes(row.logout);
                        if(a!==null&&b!==null){ const h=((b<a?b+1440:b)-a)/60; return h>=7.5?'Full Day':h<4.5?'Half Day':'Incomplete'; }
                        return 'Full Day';
                    })();
                else if(row.resolution==='Ignored') attendStatus = 'Full Day'; // ignored violations = treated as present
                else if(row.resolution==='violation') attendStatus = row.status==='Missing'?'Absent':row.status;
                else attendStatus = row.status==='Missing'?'Absent':row.status;

                return { date, name:empName, status:attendStatus,
                    login:row.login||'', logout:row.logout||'',
                    working_hours:row.working_hours||'', notes:'',
                    resolution:row.resolution };
            }
            return {date, name:empName, status:'Unknown', login:'', logout:'', notes:''};
        });

        // Summary for this employee
        const fullDay  = merged.filter(r=>r.status==='Full Day'||r.status==='Present'||r.status==='Ignored').length;
        const halfDay  = merged.filter(r=>r.status==='Half Day').length;
        const absent   = merged.filter(r=>r.status==='Absent').length;
        const onLeave  = merged.filter(r=>r.status==='On Leave').length;
        const inc      = merged.filter(r=>r.status==='Incomplete').length;

        document.getElementById('attendSummary').innerHTML = `
            <div class="attend-stat"><div class="av" style="color:#2c3e50">${merged.length}</div><div class="al">Total Days</div></div>
            <div class="attend-stat"><div class="av" style="color:#27ae60">${fullDay}</div><div class="al">âœ… Full Day</div></div>
            <div class="attend-stat"><div class="av" style="color:#e67e22">${halfDay}</div><div class="al">ğŸŒ“ Half Day</div></div>
            <div class="attend-stat"><div class="av" style="color:#e67e22">${inc}</div><div class="al">âš ï¸ Incomplete</div></div>
            <div class="attend-stat"><div class="av" style="color:#dc3545">${absent}</div><div class="al">âŒ Absent</div></div>
            <div class="attend-stat"><div class="av" style="color:#6c757d">${onLeave}</div><div class="al">ğŸ“… On Leave</div></div>`;

        const rowsHtml = merged.map(r=>{
            const badgeCls = r.status==='Full Day'||r.status==='Present'?'ab-fullday':
                             r.status==='Half Day'?'ab-halfday':
                             r.status==='Incomplete'?'ab-incomplete':
                             r.status==='Absent'?'ab-absent':'ab-leave';
            const hours = calcWorkingHours(r.login, r.logout);
            const loginTxt  = r.login  && r.login!=='âŒ No login'  ? r.login  : 'â€”';
            const logoutTxt = r.logout && r.logout!=='âŒ No logout' ? r.logout : 'â€”';
            return `<tr>
                <td><strong>${formatDate(r.date)}</strong></td>
                <td style="color:#888;font-size:12px;">${getDayName(r.date)}</td>
                <td><span class="attend-badge ${badgeCls}">${r.status}</span></td>
                <td><span class="time-badge">${loginTxt}</span></td>
                <td><span class="time-badge">${logoutTxt}</span></td>
                <td><strong>${hours}</strong></td>
                <td>${r.notes?'<span style="color:#888;font-size:12px;">'+esc(r.notes)+'</span>':''}</td>
            </tr>`;
        }).join('');

        content.innerHTML = `<table class="attend-table">
            <thead><tr><th>Date</th><th>Day</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th><th>Notes</th></tr></thead>
            <tbody>${rowsHtml}</tbody>
        </table>`;
    } catch(e){
        content.innerHTML = '<div class="no-attend">âŒ Error loading history: '+e.message+'</div>';
    }
}

function renderAttendance(dateStr){
    window._attendRowMap = {}; // clear map on each render
    const empFilter = getEmpFilter();
    const content = document.getElementById('attendContent');
    const badge   = document.getElementById('attendBadge');

    // If filtering by employee, show their full history
    if(empFilter){
        const from = document.getElementById('empRangeFrom').value;
        const to   = document.getElementById('empRangeTo').value;
        renderEmployeeHistory(empFilter, from, to);
        return;
    }
    let allEmp = [...teams.annotation.map(n=>({name:n,team:'annotation'})),
                  ...teams.assessment.map(n=>({name:n,team:'assessment'}))];

    // Build merged list priority: manual override > lastReport (current date) > dbRows (past dates) > Unknown
    const isCurrentDate = (lastReport.length > 0 && dateStr === (document.getElementById('reportDate').value || new Date().toISOString().split('T')[0]));
    const merged = allEmp.map(e=>{
        // 1. Manual override always wins
        const manual = attendRows.find(r=>r.name===e.name && r.source==='manual');
        if(manual) return {...manual};

        // 2. Use in-memory lastReport if this is the currently processed date (instant, no DB needed)
        if(isCurrentDate){
            const rep = lastReport.find(r=>r.name===e.name);
            if(rep){
                const cleanLogin  = rep.login  === 'âŒ No login'  ? '' : rep.login;
                const cleanLogout = rep.logout === 'âŒ No logout' ? '' : rep.logout;
                return { name:e.name, team:e.team, date:dateStr,
                    status: rep.status==='On Leave'?'On Leave': rep.status==='Missing'?'Absent': rep.status,
                    login:cleanLogin, logout:cleanLogout, notes:'', source:'slack', id:null };
            }
            return { name:e.name, team:e.team, date:dateStr, status:'Absent', login:'', logout:'', notes:'', source:'slack', id:null };
        }

        // 3. For past dates: all employees now stored in dbRows
        const viol = dbRows.find(r=>r.date===dateStr && r.name===e.name);
        if(viol){
            // Map resolution â†’ attendance status
            let status;
            if(viol.resolution==='On Leave')    status = 'On Leave';
            else if(viol.resolution==='Ignored') status = 'Full Day'; // ignored = treated as present
            else if(viol.resolution==='present'){
                // Compute from hours
                const a=timeToMinutes(viol.login), b=timeToMinutes(viol.logout);
                if(a!==null && b!==null){ const h=((b<a?b+1440:b)-a)/60; status=h>=7.5?'Full Day':h<4.5?'Half Day':'Incomplete'; }
                else status = 'Full Day';
            }
            else if(viol.resolution==='violation') status = viol.status==='Missing'?'Absent':viol.status;
            else status = viol.status==='Missing'?'Absent':viol.status;

            return { name:e.name, team:e.team, date:dateStr,
                status, login:viol.login||'', logout:viol.logout||'',
                notes:'', source:'slack', id:null, resolution:viol.resolution };
        }

        return { name:e.name, team:e.team, date:dateStr, status:'Unknown', login:'', logout:'', notes:'', source:'slack', id:null };
    });

    const fullDay    = merged.filter(r=>r.status==='Full Day'||r.status==='Present').length;
    const present    = 0; // merged into fullDay
    const halfDay    = merged.filter(r=>r.status==='Half Day').length;
    const incomplete = merged.filter(r=>r.status==='Incomplete').length;
    const absent     = merged.filter(r=>r.status==='Absent').length;
    const onLeave    = merged.filter(r=>r.status==='On Leave').length;
    const unknown    = merged.filter(r=>r.status==='Unknown').length;

    badge.textContent = formatDateWithDay(dateStr);
    document.getElementById('attendSummary').innerHTML = `
        <div class="attend-stat"><div class="av" style="color:#2c3e50">${merged.length}</div><div class="al">Total</div></div>
        <div class="attend-stat"><div class="av" style="color:#27ae60">${fullDay + present}</div><div class="al">âœ… Full Day</div></div>
        <div class="attend-stat"><div class="av" style="color:#e67e22">${halfDay}</div><div class="al">ğŸŒ“ Half Day</div></div>
        <div class="attend-stat"><div class="av" style="color:#e67e22">${incomplete}</div><div class="al">âš ï¸ Incomplete</div></div>
        <div class="attend-stat"><div class="av" style="color:#dc3545">${absent}</div><div class="al">âŒ Absent</div></div>
        <div class="attend-stat"><div class="av" style="color:#6c757d">${onLeave}</div><div class="al">ğŸ“… On Leave</div></div>
        <div class="attend-stat"><div class="av" style="color:#aaa">${unknown}</div><div class="al">â“ No Data</div></div>`;

    if(!merged.length){ content.innerHTML='<div class="no-attend">No employees found.</div>'; return; }

    const rows = merged.map(r=>{
        const rowClass = r.status==='Full Day'   ?'attend-fullday':
                         r.status==='Present'    ?'attend-present':
                         r.status==='Half Day'   ?'attend-halfday':
                         r.status==='Incomplete' ?'attend-incomplete':
                         r.status==='Absent'     ?'attend-absent':
                         r.status==='On Leave'   ?'attend-leave':'';
        const badgeCls = r.status==='Full Day'   ?'ab-fullday':
                         r.status==='Present'    ?'ab-present':
                         r.status==='Half Day'   ?'ab-halfday':
                         r.status==='Incomplete' ?'ab-incomplete':
                         r.status==='Absent'     ?'ab-absent':'ab-leave';
        const manualBadge = r.source === 'manual' ? '<span class="attend-badge ab-manual">âœï¸ Manual</span>' : '';
        const teamBadge   = `<span class="team-badge ${r.team}">${r.team==='annotation'?'Annotation':'Assessment'}</span>`;
        const hours       = calcWorkingHours(r.login, r.logout);
        const loginTxt    = r.login  && r.login!=='âŒ No login'  ? r.login  : (r.status==='Absent'||r.status==='On Leave'||r.status==='Unknown')?'â€”':'âŒ Missing';
        const logoutTxt   = r.logout && r.logout!=='âŒ No logout' ? r.logout : (r.status==='Absent'||r.status==='On Leave'||r.status==='Unknown')?'â€”':'âŒ Missing';
        // Store row data in a global map keyed by safe index â€” avoids ALL quote issues in onclick
        const rowKey = 'ar_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        window._attendRowMap = window._attendRowMap || {};
        window._attendRowMap[rowKey] = {id:r.id||null,name:r.name,status:r.status,login:r.login||'',logout:r.logout||'',notes:r.notes||''};

        return `<tr class="${rowClass}">
            <td><strong>${esc(r.name)}</strong>${manualBadge}</td>
            <td>${teamBadge}</td>
            <td><span class="attend-badge ${badgeCls}">${r.status}</span></td>
            <td><span class="time-badge">${loginTxt}</span></td>
            <td><span class="time-badge">${logoutTxt}</span></td>
            <td><strong>${hours}</strong></td>
            <td>${r.notes?'<span style="color:#888;font-size:12px;">'+esc(r.notes)+'</span>':''}</td>
            <td>
                <button class="btn btn-xs btn-secondary" onclick="openAttendanceModalFor(window._attendRowMap['${rowKey}'])">âœï¸ Edit</button>
                ${r.id?`<button class="btn btn-xs btn-danger" style="margin-left:4px;" onclick="deleteAttendEntry('${r.id}')">ğŸ—‘ï¸</button>`:''}
            </td>
        </tr>`;
    }).join('');

    content.innerHTML = `<table class="attend-table">
        <thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

function onAttendStatusChange(){
    const s = document.getElementById('attendStatus').value;
    document.getElementById('attendTimeFields').style.display = (s==='Absent'||s==='On Leave') ? 'none' : 'block';
}

// Recalculate status from login/logout when times are provided manually
function recalcStatusFromTimes(){
    const login  = document.getElementById('attendLogin').value.trim();
    const logout = document.getElementById('attendLogout').value.trim();
    if(!login || !logout) return;
    const a = timeToMinutes(login), b = timeToMinutes(logout);
    if(a === null || b === null) return;
    const hrs = ((b < a ? b+1440 : b) - a) / 60;
    const sel = document.getElementById('attendStatus');
    if(hrs < 4.5)       sel.value = 'Half Day';
    else if(hrs >= 7.5) sel.value = 'Full Day';
    else                sel.value = 'Incomplete';
}

function openAttendanceModal(){
    attendEditId = null;
    // Populate employee dropdown
    const sel = document.getElementById('attendEmpSelect');
    const allEmp = [...teams.annotation.map(n=>n), ...teams.assessment.map(n=>n)].sort();
    sel.innerHTML = '<option value="">â€” Select employee â€”</option>' + allEmp.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    document.getElementById('attendStatus').value  = 'Present';
    document.getElementById('attendLogin').value   = '';
    document.getElementById('attendLogout').value  = '';
    document.getElementById('attendNotes').value   = '';
    onAttendStatusChange();
    document.getElementById('attendOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('attendEmpSelect').focus(), 100);
}

function openAttendanceModalFor(data){
    attendEditId = data.id || null;
    const sel = document.getElementById('attendEmpSelect');
    const allEmp = [...teams.annotation.map(n=>n), ...teams.assessment.map(n=>n)].sort();
    sel.innerHTML = '<option value="">â€” Select employee â€”</option>' + allEmp.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    sel.value      = data.name;
    document.getElementById('attendStatus').value  = data.status  || 'Present';
    document.getElementById('attendLogin').value   = data.login   || '';
    document.getElementById('attendLogout').value  = data.logout  || '';
    document.getElementById('attendNotes').value   = data.notes   || '';
    onAttendStatusChange();
    document.getElementById('attendOverlay').classList.add('open');
}

function closeAttendanceModal(){
    document.getElementById('attendOverlay').classList.remove('open');
    attendEditId = null;
}

async function saveManualEntry(){
    const name   = document.getElementById('attendEmpSelect').value.trim();
    const status = document.getElementById('attendStatus').value;
    const login  = document.getElementById('attendLogin').value.trim();
    const logout = document.getElementById('attendLogout').value.trim();
    const notes  = document.getElementById('attendNotes').value.trim();

    if(!name){ showToast('âš ï¸ Please select an employee.'); return; }
    if(!attendCurrentDate){ showToast('âš ï¸ No date selected.'); return; }

    // Check if a DB record already exists for this employee on this date
    const existing = attendRows.find(r=>r.name===name);
    const rowId    = attendEditId || (existing ? existing.id : null);

    const row = {
        id:     rowId || undefined,
        date:   attendCurrentDate,
        name:   name,
        team:   getTeam(name) || 'annotation',
        status: status,
        login:  (status==='Absent'||status==='On Leave') ? '' : login,
        logout: (status==='Absent'||status==='On Leave') ? '' : logout,
        notes:  notes,
        source: 'manual'
    };
    if(!rowId) delete row.id;
    // Only manual entries go to DB â€” slack data is derived from violation_history in memory

    closeAttendanceModal();
    try{
        await dbSaveAttendance(row);
        attendRows = await dbLoadAttendance(attendCurrentDate);
        renderAttendance(attendCurrentDate);
        showToast('âœ… Attendance saved for '+esc(name));
    } catch(e){
        showToast('âŒ Save failed: '+e.message);
    }
}

async function deleteAttendEntry(id){
    openConfirm('Delete Entry','Remove this attendance record?', async()=>{
        try{
            await dbDeleteAttendance(id);
            attendRows = await dbLoadAttendance(attendCurrentDate);
            renderAttendance(attendCurrentDate);
            showToast('ğŸ—‘ï¸ Entry deleted.');
        } catch(e){ showToast('âŒ Delete failed: '+e.message); }
    });
}

async function deleteAttendanceByDate(){
    const dateStr = attendCurrentDate;
    if(!dateStr){ showToast('No date selected.'); return; }
    const totalCount = dbRows.filter(r=>r.date===dateStr).length;
    openConfirm(
        'ğŸ—‘ï¸ Delete All Data for ' + formatDate(dateStr),
        'This will permanently delete <strong>all '+totalCount+' records</strong> (attendance + violations) for <strong>'+formatDateWithDay(dateStr)+'</strong>.<br><br>This cannot be undone.',
        async ()=>{
            setSyncStatus('loading','Deleting all data for '+formatDate(dateStr)+'â€¦');
            try{
                // Delete from both tables in parallel
                await Promise.all([
                    sbFetch(TABLE+'?date=eq.'+encodeURIComponent(dateStr), {method:'DELETE'}),
                    sbFetch(ATTEND_TABLE+'?date=eq.'+encodeURIComponent(dateStr), {method:'DELETE'}).catch(()=>{})
                ]);
                // Remove from local cache
                dbRows = dbRows.filter(r=>r.date!==dateStr);
                attendRows = [];
                attendCurrentDate = '';
                // Reset UI
                document.getElementById('attendDateSelect').value = '';
                document.getElementById('attendContent').innerHTML = '<div class="no-attend">Select a date above to view attendance.</div>';
                document.getElementById('attendSummary').innerHTML = '';
                document.getElementById('attendAddBtn').disabled = true;
                document.getElementById('attendExportBtn').disabled = true;
                document.getElementById('attendDeleteDateBtn').disabled = true;
                renderHistory(getHistFilters());
                renderDateManager();
                refreshAttendDateSelect();
                showToast('ğŸ—‘ï¸ All data for '+formatDate(dateStr)+' deleted.');
                setSyncStatus('ok','âœ… Deleted.');
            } catch(e){
                setSyncStatus('error','âŒ Delete failed: '+e.message);
            }
        }
    );
}

function exportAttendanceCSV(){
    if(!attendCurrentDate){ showToast('Select a date first.'); return; }
    const allEmp = [...teams.annotation.map(n=>({name:n,team:'annotation'})),
                    ...teams.assessment.map(n=>({name:n,team:'assessment'}))];
    const merged = allEmp.map(e=>{
        const saved = attendRows.find(r=>r.name===e.name);
        if(saved) return saved;
        const viol = dbRows.find(r=>r.date===attendCurrentDate && r.name===e.name);
        if(viol) return {name:e.name,team:e.team,status:viol.status==='Missing'?'Absent':viol.status,login:viol.login||'',logout:viol.logout||'',notes:''};
        return {name:e.name,team:e.team,status:'Unknown',login:'',logout:'',notes:''};
    });
    let csv = 'Date,Employee,Team,Status,Login,Logout,Working Hours,Notes\n';
    merged.forEach(r=>{
        const hrs = calcWorkingHours(r.login,r.logout);
        csv += `"${attendCurrentDate}","${r.name}","${teamLabel(r.team)}","${r.status}","${r.login||''}","${r.logout||''}","${hrs}","${(r.notes||'').replace(/"/g,'""')}"
`;
    });
    const a = Object.assign(document.createElement('a'),{
        href: URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download: `attendance-${attendCurrentDate}.csv`
    });
    a.click(); URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Save ALL employees' attendance from Slack report to attendance_records table

// â”€â”€ Date confirmation modal â”€â”€
function openDateConfirm(dateStr, onConfirm){
    // Format date as DD/MM/YYYY for user to type
    const [y,m,d] = dateStr.split('-');
    const displayDMY = d+'/'+m+'/'+y;

    document.getElementById('dcDateDisplay').textContent = displayDMY;
    document.getElementById('dcDayDisplay').textContent  = getDayName(dateStr) + ', ' + formatDate(dateStr);
    document.getElementById('dcInput').value   = '';
    document.getElementById('dcInput').className = '';
    document.getElementById('dcHint').textContent = '';
    document.getElementById('dcConfirmBtn').disabled = true;
    document.getElementById('dateConfirmOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('dcInput').focus(), 120);

    // Wire confirm button for this call
    const confirmBtn = document.getElementById('dcConfirmBtn');
    const newBtn = confirmBtn.cloneNode(true); // remove old listeners
    confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
    newBtn.disabled = true;
    newBtn.addEventListener('click', ()=>{
        document.getElementById('dateConfirmOverlay').classList.remove('open');
        onConfirm();
    });

    // Input validation
    const input = document.getElementById('dcInput');
    const newInput = input.cloneNode(true);
    input.parentNode.replaceChild(newInput, input);
    newInput.addEventListener('input', function(){
        const val   = this.value.trim();
        const match = val === displayDMY;
        const hint  = document.getElementById('dcHint');
        newBtn.disabled = !match;
        if(!val){ this.className=''; hint.textContent=''; return; }
        if(match){
            this.className='match';
            hint.innerHTML='<span style="color:#27ae60;font-weight:600;">âœ… Date confirmed!</span>';
        } else {
            this.className='wrong';
            hint.innerHTML='<span style="color:#dc3545;">Expected: <strong>'+displayDMY+'</strong></span>';
        }
    });
    newInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !newBtn.disabled) newBtn.click(); });
}

function closeDateConfirm(){
    document.getElementById('dateConfirmOverlay').classList.remove('open');
}

async function processMessages(){
    const input = document.getElementById('slackInput').value.trim();
    if(!input){ alert('Please paste some Slack messages first!'); return; }
    const msgs = parseMessages(input);
    if(!msgs.length){ alert('No valid messages detected.'); return; }

    let dateStr = document.getElementById('reportDate').value;
    if(!dateStr) dateStr = new Date().toISOString().split('T')[0];

    // Show date confirmation modal â€” only proceed after user types the date
    openDateConfirm(dateStr, ()=> doProcessMessages(dateStr));
}

async function doProcessMessages(dateStr){

    // â”€â”€ Step 1: Show results instantly (synchronous, no DB needed) â”€â”€
    const ann   = lastReport.filter(r=>r.team==='annotation');
    const ass   = lastReport.filter(r=>r.team==='assessment');
    const viols = lastReport.filter(r=>r.status==='Missing'||r.status==='Incomplete'||r.status==='Half Day');
    document.getElementById('tcAll').textContent        = lastReport.length;
    document.getElementById('tcViolations').textContent = viols.length;
    document.getElementById('tcAnnotation').textContent = ann.length;
    document.getElementById('tcAssessment').textContent = ass.length;
    document.getElementById('viewTabs').style.display   = 'flex';
    document.getElementById('resultsArea').style.display = 'block';
    renderView(activeViewTab);

    // â”€â”€ Step 2: Show attendance instantly from in-memory data â”€â”€
    attendCurrentDate = dateStr;
    refreshAttendDateSelect();
    document.getElementById('attendDateSelect').value = dateStr;
    document.getElementById('attendAddBtn').disabled        = false;
    document.getElementById('attendExportBtn').disabled     = false;
    document.getElementById('attendDeleteDateBtn').disabled = false;
    // Fetch only manual overrides for this date (small, fast query)
    dbLoadAttendance(dateStr).then(rows=>{
        attendRows = rows;
        populateAttendEmpFilter();
        renderAttendance(dateStr);
    }).catch(()=>{ attendRows=[]; renderAttendance(dateStr); });

    // Open panels
    const ap=document.getElementById('attendPanelToggle'),ab=document.getElementById('attendPanelBody');
    if(!ab.classList.contains('open')){ ap.classList.add('open'); ab.classList.add('open'); }
    const hp=document.getElementById('histPanelToggle'),hb=document.getElementById('histPanelBody');
    if(!hb.classList.contains('open')){ hp.classList.add('open'); hb.classList.add('open'); }

    document.getElementById('lastUpdated').textContent = `âœ“ Last updated: ${new Date().toLocaleString()}`;
    showToast(viols.length ? `âœ… <strong>${viols.length} violation${viols.length!==1?'s':''}</strong> found. Saving to cloudâ€¦` : `âœ… Everyone compliant on ${formatDate(dateStr)}! Savingâ€¦`);

    // â”€â”€ Step 3: Save to cloud in background â€” UI already showing results â”€â”€
    await saveViolationsForDate(dateStr, lastReport);
}

function clearAll(){
    document.getElementById('slackInput').value='';
    document.getElementById('viewTabs').style.display='none';
    document.getElementById('resultsArea').style.display='none';
    document.getElementById('lastUpdated').textContent='';
    lastReport=[];clearDebug();document.getElementById('debugInfo').innerHTML='';
}

function exportCSV(){
    if(!lastReport.length){alert('Process messages first!');return;}
    const view=activeViewTab,rows=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    let csv='Employee,Team,Status,Login,Logout,Working Hours\n';
    rows.forEach(r=>{csv+=`"${r.name}","${teamLabel(r.team)}","${r.status}","${r.login}","${r.logout}","${r.workingHours}"\n`;});
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`slack-attendance-${view}-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ App init â€” called once after login is confirmed â”€â”€
async function initApp(){
    if(window._appInitialised) return;
    window._appInitialised = true;

    loadTeams(); renderEmpGrid();
    document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
    await loadFromCloud();

    document.getElementById('empPanelToggle').addEventListener('click',()=>{
        document.getElementById('empPanelToggle').classList.toggle('open');
        document.getElementById('empPanelBody').classList.toggle('open');
    });
    document.getElementById('tabAnnotation').addEventListener('click',()=>switchEmpTab('annotation'));
    document.getElementById('tabAssessment').addEventListener('click',()=>switchEmpTab('assessment'));
    document.getElementById('newEmpTeam').addEventListener('change',e=>switchEmpTab(e.target.value));
    document.getElementById('addEmpBtn').addEventListener('click',addEmployee);
    document.getElementById('newEmpInput').addEventListener('keydown',e=>{if(e.key==='Enter')addEmployee();});
    document.getElementById('resetEmpBtn').addEventListener('click',resetToDefaults);

    document.getElementById('histPanelToggle').addEventListener('click',()=>{
        document.getElementById('histPanelToggle').classList.toggle('open');
        document.getElementById('histPanelBody').classList.toggle('open');
    });
    document.getElementById('refreshHistBtn').addEventListener('click',e=>{e.stopPropagation();loadFromCloud();});
    document.getElementById('histFilterBtn').addEventListener('click',()=>renderHistory(getHistFilters()));
    document.getElementById('histResetFilterBtn').addEventListener('click',()=>{
        ['histTeamFilter','histTypeFilter','histFromDate','histToDate'].forEach(id=>document.getElementById(id).value=id.includes('Filter')?'all':'');
        renderHistory();
    });
    document.getElementById('histExportBtn').addEventListener('click',()=>exportHistoryCSV(getHistFilters()));
    document.getElementById('histClearBtn').addEventListener('click',()=>{
        document.getElementById('clearConfirmInput').value='';
        document.getElementById('clearOverlayConfirm').disabled=true;
        document.getElementById('clearOverlay').classList.add('open');
        setTimeout(()=>document.getElementById('clearConfirmInput').focus(),100);
    });
    document.getElementById('clearConfirmInput').addEventListener('input',function(){
        const match = this.value.trim().toUpperCase() === 'CLEAR';
        document.getElementById('clearOverlayConfirm').disabled = !match;
        this.classList.toggle('match', match);
    });
    document.getElementById('clearOverlayCancel').addEventListener('click',()=>{
        document.getElementById('clearOverlay').classList.remove('open');
    });
    document.getElementById('clearOverlayConfirm').addEventListener('click',async()=>{
        document.getElementById('clearOverlay').classList.remove('open');
        setSyncStatus('loading','Deleting all recordsâ€¦');
        try{
            // Delete violation_history and attendance_records in parallel
            await Promise.all([
                dbDeleteAll(),
                sbFetch(ATTEND_TABLE+'?date=gte.0000-00-00', {method:'DELETE'}).catch(()=>{})
            ]);
            await loadFromCloud();
            attendRows = [];
            document.getElementById('attendContent').innerHTML='<div class="no-attend">Select a date above to view attendance.</div>';
            document.getElementById('attendSummary').innerHTML='';
            document.getElementById('attendDateSelect').innerHTML='<option value="">â€” Pick a date â€”</option>';
            showToast('ğŸ—‘ï¸ All history cleared.');
        }
        catch(e){ setSyncStatus('error','Delete failed: '+e.message); }
    });
    document.getElementById('clearOverlay').addEventListener('click',e=>{
        if(e.target===document.getElementById('clearOverlay'))
            document.getElementById('clearOverlay').classList.remove('open');
    });
    document.getElementById('confirmOk').addEventListener('click',()=>{if(_ccb)_ccb();closeConfirm();});
    document.getElementById('confirmCancel').addEventListener('click',closeConfirm);
    document.getElementById('confirmOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('confirmOverlay'))closeConfirm();});

    document.querySelectorAll('.res-option').forEach(opt=>{
        opt.addEventListener('click',()=>{selectedResolution=opt.dataset.res;updateResOptions();updateReasonLabel();});
    });
    document.getElementById('editSave').addEventListener('click',saveEdit);
    document.getElementById('editCancel').addEventListener('click',closeEditModal);
    document.getElementById('editClose').addEventListener('click',closeEditModal);
    document.getElementById('editOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('editOverlay'))closeEditModal();});

    // Attendance modal wiring
    document.getElementById('attendLogin') .addEventListener('blur', recalcStatusFromTimes);
    document.getElementById('attendLogout').addEventListener('blur', recalcStatusFromTimes);
    document.getElementById('attendCloseBtn').addEventListener('click', closeAttendanceModal);
    document.getElementById('dcCancelBtn').addEventListener('click', closeDateConfirm);
    document.getElementById('dateConfirmOverlay').addEventListener('click', e=>{
        if(e.target===document.getElementById('dateConfirmOverlay')) closeDateConfirm();
    });
    // Populate searchable employee filter after teams are loaded
    populateAttendEmpFilter();
    document.getElementById('attendOverlay').addEventListener('click', e=>{ if(e.target===document.getElementById('attendOverlay')) closeAttendanceModal(); });
    document.getElementById('attendSaveBtn').addEventListener('click', saveManualEntry);
    document.getElementById('attendPanelToggle').addEventListener('click',()=>{
        document.getElementById('attendPanelToggle').classList.toggle('open');
        document.getElementById('attendPanelBody').classList.toggle('open');
    });

    document.querySelectorAll('.view-tab').forEach(t=>t.addEventListener('click',()=>renderView(t.dataset.view)));
    document.getElementById('processBtn').addEventListener('click',processMessages);
    document.getElementById('clearBtn').addEventListener('click',clearAll);
    document.getElementById('exportBtn').addEventListener('click',exportCSV);
    document.getElementById('debugBtn').addEventListener('click',()=>{
        const d=document.getElementById('debugInfo');d.style.display=d.style.display==='block'?'none':'block';
    });
    document.getElementById('sample1Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData1;processMessages();});
    document.getElementById('sample2Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData2;processMessages();});
}

document.addEventListener('DOMContentLoaded', function(){
    // Always wire login buttons first
    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
    document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('loginPass').focus(); });
    document.getElementById('logoutBtn').addEventListener('click', doLogout);

    // If already logged in, go straight to app
    const session = checkSession();
    if(session){ showMainApp(session); }
    // else: login screen stays visible, initApp called when user logs in via showMainApp()
});
</script>
</body>
</html>
