<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Login/Logout Tracker</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        body{background:#f0f2f5;padding:20px;}
        .container{max-width:1500px;margin:0 auto;}
        .header{background:linear-gradient(135deg,#1a4d8c 0%,#2c3e50 100%);color:white;padding:20px 30px;border-radius:15px 15px 0 0;}
        .header h1{font-size:24px;margin-bottom:5px;}
        .header p{opacity:.9;font-size:14px;}

        /* sync status bar */
        .sync-bar{background:#e8f5e9;border:1px solid #c8e6c9;border-radius:8px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;color:#2e7d32;}
        .sync-bar.error{background:#fdecea;border-color:#f5c6cb;color:#c62828;}
        .sync-bar.loading{background:#e3f2fd;border-color:#bbdefb;color:#1565c0;}
        .sync-dot{width:10px;height:10px;border-radius:50%;background:#27ae60;flex-shrink:0;}
        .sync-dot.error{background:#dc3545;}
        .sync-dot.loading{background:#1a4d8c;animation:pulse 1s infinite;}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

        /* panels */
        .panel{background:white;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:20px;overflow:hidden;}
        .panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;cursor:pointer;user-select:none;}
        .panel-header h2{font-size:15px;color:#333;font-weight:600;display:flex;align-items:center;gap:8px;}
        .panel-body{display:none;padding:20px;}
        .panel-body.open{display:block;}
        .toggle-icon{font-size:14px;color:#888;transition:transform .25s;}
        .panel-header.open .toggle-icon{transform:rotate(180deg);}

        .badge{font-size:12px;font-weight:700;padding:2px 9px;border-radius:20px;display:inline-block;}
        .badge-blue{background:#1a4d8c;color:white;}
        .badge-red{background:#dc3545;color:white;}

        .team-tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;}
        .team-tab{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all .2s;background:#f0f2f5;color:#555;}
        .team-tab.active-annotation{background:#e8f0fe;color:#1a4d8c;border-color:#1a4d8c;}
        .team-tab.active-assessment{background:#fef3e8;color:#c0631a;border-color:#c0631a;}

        .add-emp-row{display:flex;gap:10px;margin-bottom:18px;}
        .add-emp-row input{flex:1;padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;transition:border-color .2s;}
        .add-emp-row input:focus{outline:none;border-color:#1a4d8c;}
        .add-emp-row input.shake{animation:shake .3s;border-color:#dc3545;}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
        .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;max-height:260px;overflow-y:auto;padding-right:4px;}
        .emp-chip{display:flex;align-items:center;justify-content:space-between;border-radius:8px;padding:8px 12px;font-size:13px;color:#333;transition:background .15s;}
        .emp-chip.annotation{background:#e8f0fe;} .emp-chip.annotation:hover{background:#d2e3fc;}
        .emp-chip.assessment{background:#fef3e8;} .emp-chip.assessment:hover{background:#fde0c0;}
        .emp-chip .emp-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .emp-chip .remove-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:16px;line-height:1;padding:0 0 0 8px;transition:color .15s;flex-shrink:0;}
        .emp-chip .remove-btn:hover{color:#dc3545;}
        .panel-footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid #eee;font-size:12px;color:#999;flex-wrap:wrap;gap:10px;}

        .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
        .btn-sm{padding:6px 14px;font-size:12px;}
        .btn-xs{padding:4px 10px;font-size:11px;}
        .btn-primary{background:#1a4d8c;color:white;} .btn-primary:hover{background:#0d3a6b;}
        .btn-secondary{background:#e0e0e0;color:#333;} .btn-secondary:hover{background:#d0d0d0;}
        .btn-success{background:#27ae60;color:white;} .btn-success:hover{background:#219a52;}
        .btn-info{background:#17a2b8;color:white;} .btn-info:hover{background:#138496;}
        .btn-danger{background:#dc3545;color:white;} .btn-danger:hover{background:#b02a37;}
        .btn-warning{background:#e67e22;color:white;} .btn-warning:hover{background:#ca6f1e;}

        .input-section{background:white;padding:20px;border-radius:0 0 15px 15px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px;}
        .input-section textarea{width:100%;height:280px;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;font-family:monospace;resize:vertical;margin-bottom:15px;line-height:1.5;}
        .input-section textarea:focus{outline:none;border-color:#1a4d8c;}
        .button-group{display:flex;gap:10px;flex-wrap:wrap;}
        .date-row{display:flex;align-items:center;gap:12px;margin-bottom:15px;flex-wrap:wrap;}
        .date-row label{font-size:14px;font-weight:600;color:#555;}
        .date-row input[type=date]{padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;}
        .date-row input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .date-row .date-hint{font-size:12px;color:#999;}

        .view-tabs{display:flex;gap:0;border-radius:10px 10px 0 0;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.08);}
        .view-tab{flex:1;padding:14px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;background:#e9ecef;color:#555;border:none;transition:background .2s,color .2s;}
        .view-tab .tab-count{font-size:11px;font-weight:700;margin-left:6px;padding:2px 7px;border-radius:20px;background:rgba(0,0,0,.1);}
        .view-tab.active-all{background:#2c3e50;color:white;}
        .view-tab.active-annotation{background:#1a4d8c;color:white;}
        .view-tab.active-assessment{background:#c0631a;color:white;}

        .stats-wrapper{background:white;padding:16px 16px 0;border-top:1px solid #dee2e6;}
        .stats-label{font-size:12px;font-weight:700;text-transform:uppercase;color:#999;letter-spacing:.5px;margin-bottom:10px;}
        .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px;}
        .stat-card{background:#f8f9fa;padding:16px;border-radius:10px;text-align:center;border:1px solid #eee;}
        .stat-card h3{color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px;}
        .stat-card .value{font-size:28px;font-weight:bold;color:#1a4d8c;}
        .stat-card .value.complete{color:#27ae60;} .stat-card .value.incomplete{color:#e67e22;}
        .stat-card .value.leave{color:#6c757d;} .stat-card .value.missing{color:#dc3545;}

        .table-container{background:white;border-radius:0 0 10px 10px;box-shadow:0 2px 4px rgba(0,0,0,.1);overflow:auto;max-height:600px;}
        table{width:100%;border-collapse:collapse;}
        th{background:#f8f9fa;color:#333;font-weight:600;font-size:13px;padding:14px 15px;text-align:left;border-bottom:2px solid #dee2e6;position:sticky;top:0;z-index:10;white-space:nowrap;}
        td{padding:11px 15px;border-bottom:1px solid #e0e0e0;font-size:14px;}
        tr:hover td{background:#f5f5f5;}
        .team-header-row td{font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;padding:8px 15px;border-bottom:2px solid #dee2e6;}
        .team-header-row.annotation td{background:#e8f0fe;color:#1a4d8c;}
        .team-header-row.assessment td{background:#fef3e8;color:#c0631a;}

        .status-badge{padding:4px 8px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;}
        .status-complete{background:#d4edda;color:#155724;}
        .status-incomplete{background:#fff3cd;color:#856404;}
        .status-leave{background:#e2e3e5;color:#383d41;}
        .status-missing{background:#f8d7da;color:#721c24;}
        .time-badge{background:#e9ecef;padding:4px 8px;border-radius:15px;font-size:12px;}
        .team-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block;}
        .team-badge.annotation{background:#e8f0fe;color:#1a4d8c;}
        .team-badge.assessment{background:#fef3e8;color:#c0631a;}

        /* history */
        .history-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
        .history-toolbar select,.history-toolbar input[type=date]{padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;}
        .history-toolbar select:focus,.history-toolbar input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .history-toolbar label{font-size:13px;font-weight:600;color:#555;}

        .hist-emp-block{border:1px solid #e0e0e0;border-radius:10px;margin-bottom:10px;overflow:hidden;}
        .hist-emp-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f8f9fa;cursor:pointer;user-select:none;gap:10px;flex-wrap:wrap;}
        .hist-emp-header:hover{background:#eef0f3;}
        .hist-emp-name{font-weight:700;font-size:14px;color:#2c3e50;}
        .hist-emp-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
        .hist-violations-count{background:#dc3545;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-resolved-count{background:#27ae60;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-streak{background:#e67e22;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-emp-body{display:none;}
        .hist-emp-body.open{display:block;}
        .hist-table{width:100%;border-collapse:collapse;}
        .hist-table th{background:#f0f2f5;font-size:12px;padding:10px 14px;text-align:left;font-weight:600;color:#555;border-bottom:1px solid #dee2e6;}
        .hist-table td{padding:9px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;vertical-align:middle;}
        .hist-table tr:last-child td{border-bottom:none;}
        .hist-table tr:hover td{background:#fafafa;}
        .viol-row-missing td:first-child{border-left:4px solid #dc3545;}
        .viol-row-incomplete td:first-child{border-left:4px solid #e67e22;}
        .viol-row-resolved-leave td:first-child{border-left:4px solid #6c757d;}
        .viol-row-resolved-ignored td:first-child{border-left:4px solid #6f42c1;}
        .viol-row-resolved-leave td,.viol-row-resolved-ignored td{opacity:.65;}
        .res-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:4px;}
        .res-leave{background:#e2e3e5;color:#383d41;}
        .res-ignored{background:#e8d5ff;color:#5a32a3;}
        .res-reason{font-size:11px;color:#888;margin-top:3px;font-style:italic;}
        .no-history{padding:40px;text-align:center;color:#aaa;font-size:14px;}
        .history-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px;}
        .hist-stat{background:#f8f9fa;border:1px solid #eee;border-radius:8px;padding:12px;text-align:center;}
        .hist-stat .hv{font-size:22px;font-weight:bold;color:#dc3545;}
        .hist-stat .hl{font-size:11px;text-transform:uppercase;color:#999;margin-top:4px;}

        /* edit modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;align-items:center;justify-content:center;}
        .modal-overlay.open{display:flex;}
        .modal-confirm{background:white;border-radius:12px;padding:28px 32px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.2);text-align:center;}
        .modal-confirm h3{font-size:18px;margin-bottom:10px;color:#2c3e50;}
        .modal-confirm p{font-size:14px;color:#666;margin-bottom:22px;line-height:1.5;}
        .modal-btns{display:flex;gap:12px;justify-content:center;}
        .modal-edit{background:white;border-radius:14px;width:90%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-edit-header{background:linear-gradient(135deg,#1a4d8c,#2c3e50);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;}
        .modal-edit-header h3{font-size:16px;font-weight:700;}
        .modal-edit-close{background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;opacity:.8;}
        .modal-edit-close:hover{opacity:1;}
        .modal-edit-body{padding:24px;}
        .viol-info-box{background:#f8f9fa;border-radius:8px;padding:14px 16px;margin-bottom:20px;border:1px solid #e0e0e0;}
        .viol-info-box .vi-row{display:flex;justify-content:space-between;font-size:13px;padding:3px 0;color:#555;}
        .viol-info-box .vi-row strong{color:#2c3e50;}
        .resolution-options{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;}
        .res-option{border:2px solid #e0e0e0;border-radius:10px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;background:white;}
        .res-option:hover{border-color:#1a4d8c;background:#f0f4ff;}
        .res-option.selected-violation{border-color:#dc3545;background:#fff5f5;}
        .res-option.selected-on-leave{border-color:#6c757d;background:#f5f5f5;}
        .res-option.selected-ignored{border-color:#6f42c1;background:#f5f0ff;}
        .res-option .res-icon{font-size:24px;margin-bottom:6px;}
        .res-option .res-label{font-size:12px;font-weight:700;color:#333;}
        .res-option .res-desc{font-size:11px;color:#888;margin-top:3px;}
        .reason-field{margin-bottom:20px;}
        .reason-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
        .reason-field textarea{width:100%;padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;resize:none;height:72px;font-family:inherit;}
        .reason-field textarea:focus{outline:none;border-color:#1a4d8c;}
        .reason-field textarea.required-shake{animation:shake .3s;border-color:#dc3545;}
        .modal-edit-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        .debug-info{background:#f8f9fa;padding:10px;margin:10px 0;border-radius:5px;font-size:12px;color:#666;max-height:200px;overflow:auto;display:none;border:1px solid #dee2e6;font-family:monospace;}
        .footer{text-align:center;margin-top:20px;color:#666;font-size:13px;}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#2c3e50;color:white;padding:12px 24px;border-radius:30px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .3s;z-index:9999;}
        .toast.show{opacity:1;}
        .team-select{padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;background:white;cursor:pointer;}
        .team-select:focus{outline:none;border-color:#1a4d8c;}
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <h1>ğŸ“‹ Slack Login/Logout Tracker <span class="status-badge status-complete">v6.0</span></h1>
        <p>Shared history between both users â€” powered by Supabase cloud database</p>
    </div>

    <!-- Sync status bar -->
    <div class="sync-bar loading" id="syncBar">
        <div class="sync-dot loading" id="syncDot"></div>
        <span id="syncMsg">Connecting to shared databaseâ€¦</span>
    </div>

    <!-- Employee Management -->
    <div class="panel">
        <div class="panel-header" id="empPanelToggle">
            <h2>ğŸ‘¥ Manage Employees <span class="badge badge-blue" id="empCount">0</span></h2>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-body" id="empPanelBody">
            <div class="team-tabs">
                <div class="team-tab active-annotation" id="tabAnnotation">ğŸ”µ Data Annotation (<span id="countAnnotation">0</span>)</div>
                <div class="team-tab" id="tabAssessment">ğŸŸ  Data Assessment / DA (<span id="countAssessment">0</span>)</div>
            </div>
            <div class="add-emp-row">
                <input type="text" id="newEmpInput" placeholder="Employee nameâ€¦" maxlength="80"/>
                <select class="team-select" id="newEmpTeam">
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <button class="btn btn-primary" id="addEmpBtn">â• Add</button>
            </div>
            <div class="emp-grid" id="empGrid"></div>
            <div class="panel-footer">
                <span>ğŸ’¾ Saved in this browser. History is shared via cloud.</span>
                <button class="btn btn-danger btn-sm" id="resetEmpBtn">â†© Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Slack Input -->
    <div class="input-section">
        <div class="date-row">
            <label for="reportDate">ğŸ“… Date of this log:</label>
            <input type="date" id="reportDate"/>
            <span class="date-hint">Tags violations in shared history. Defaults to today.</span>
        </div>
        <textarea id="slackInput" placeholder="Paste Slack messages here â€” both teams together is fineâ€¦"></textarea>
        <div class="button-group">
            <button class="btn btn-primary"   id="processBtn">ğŸ” Process &amp; Save to History</button>
            <button class="btn btn-secondary" id="clearBtn">ğŸ—‘ï¸ Clear</button>
            <button class="btn btn-success"   id="sample1Btn">ğŸ“‹ Format 1</button>
            <button class="btn btn-info"      id="sample2Btn">ğŸ“‹ Format 2</button>
            <button class="btn btn-secondary" id="exportBtn">ğŸ“¥ Export CSV</button>
            <button class="btn btn-secondary" id="debugBtn">ğŸ› Debug</button>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <!-- Today's Results -->
    <div class="view-tabs" id="viewTabs" style="display:none;">
        <button class="view-tab active-all" data-view="all">ğŸ“Š All <span class="tab-count" id="tcAll">0</span></button>
        <button class="view-tab" data-view="annotation">ğŸ”µ Annotation <span class="tab-count" id="tcAnnotation">0</span></button>
        <button class="view-tab" data-view="assessment">ğŸŸ  Assessment <span class="tab-count" id="tcAssessment">0</span></button>
    </div>
    <div id="resultsArea" style="display:none;">
        <div class="stats-wrapper">
            <div class="stats-label" id="statsLabel">Overall</div>
            <div class="stats-container" id="statsContainer"></div>
        </div>
        <div class="table-container"><div id="tableContainer"></div></div>
    </div>

    <!-- Violation History -->
    <div class="panel" style="margin-top:24px;">
        <div class="panel-header" id="histPanelToggle">
            <h2>ğŸš¨ Violation History <span class="badge badge-red" id="histTotalBadge">0 violations</span>
                <button class="btn btn-info btn-sm" id="refreshHistBtn" style="margin-left:8px;font-size:11px;padding:3px 10px;">ğŸ”„ Refresh</button>
            </h2>
            <span class="toggle-icon">â–¼</span>
        </div>
        <div class="panel-body" id="histPanelBody">
            <div class="history-summary" id="histSummary"></div>
            <div class="history-toolbar">
                <label>Team:</label>
                <select id="histTeamFilter">
                    <option value="all">All Teams</option>
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <label>Show:</label>
                <select id="histTypeFilter">
                    <option value="all">All Records</option>
                    <option value="active">Active Violations Only</option>
                    <option value="resolved">Resolved Only</option>
                    <option value="Missing">Missing</option>
                    <option value="Incomplete">Incomplete</option>
                    <option value="On Leave">Marked On Leave</option>
                    <option value="Ignored">Ignored</option>
                </select>
                <label>From:</label><input type="date" id="histFromDate"/>
                <label>To:</label><input type="date" id="histToDate"/>
                <button class="btn btn-secondary btn-sm" id="histFilterBtn">ğŸ” Apply</button>
                <button class="btn btn-secondary btn-sm" id="histResetFilterBtn">âœ– Clear</button>
                <button class="btn btn-success btn-sm"   id="histExportBtn">ğŸ“¥ Export CSV</button>
                <button class="btn btn-danger btn-sm"    id="histClearBtn">ğŸ—‘ï¸ Clear All</button>
            </div>
            <div id="histContent"></div>
        </div>
    </div>

    <div class="footer"><span id="lastUpdated"></span></div>
</div>

<div class="toast" id="toast"></div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmOverlay">
    <div class="modal-confirm">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMsg"></p>
        <div class="modal-btns">
            <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
            <button class="btn btn-danger"    id="confirmOk">Confirm</button>
        </div>
    </div>
</div>

<!-- Edit Violation Modal -->
<div class="modal-overlay" id="editOverlay">
    <div class="modal-edit">
        <div class="modal-edit-header">
            <h3>âœï¸ Edit Violation</h3>
            <button class="modal-edit-close" id="editClose">Ã—</button>
        </div>
        <div class="modal-edit-body">
            <div class="viol-info-box" id="editInfoBox"></div>
            <p style="font-size:13px;font-weight:600;color:#555;margin-bottom:10px;">Change resolution to:</p>
            <div class="resolution-options">
                <div class="res-option" data-res="violation" id="resOptViolation">
                    <div class="res-icon">ğŸš¨</div>
                    <div class="res-label">Keep as Violation</div>
                    <div class="res-desc">Counts against the employee</div>
                </div>
                <div class="res-option" data-res="On Leave" id="resOptLeave">
                    <div class="res-icon">ğŸ“…</div>
                    <div class="res-label">Mark On Leave</div>
                    <div class="res-desc">Absent for legitimate reason</div>
                </div>
                <div class="res-option" data-res="Ignored" id="resOptIgnored">
                    <div class="res-icon">ğŸ”•</div>
                    <div class="res-label">Ignore / Excuse</div>
                    <div class="res-desc">System error or known reason</div>
                </div>
            </div>
            <div class="reason-field">
                <label for="editReason">Reason / Notes <span id="editReasonRequired" style="color:#dc3545;display:none;">*required</span></label>
                <textarea id="editReason" placeholder="Required for On Leave and Ignore â€” add a note explaining whyâ€¦"></textarea>
            </div>
        </div>
        <div class="modal-edit-footer">
            <button class="btn btn-secondary" id="editCancel">Cancel</button>
            <button class="btn btn-primary"   id="editSave">ğŸ’¾ Save to Cloud</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  SUPABASE CONFIG  â€” paste your keys here
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://tfapnbvrquswjzogdhbh.supabase.co';
const SUPABASE_KEY = 'sb_publishable_VcT6pNqY6tO0jwBgBkOqQQ_ie4JPHdD';  // â† replace this with the long eyJ... key
const TABLE = 'violation_history';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE API WRAPPER  (no extra libraries needed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbFetch(path, opts={}){
    const url = SUPABASE_URL + '/rest/v1/' + path;
    const res = await fetch(url, {
        ...opts,
        headers:{
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': opts.prefer || '',
            ...(opts.headers||{})
        }
    });
    if(!res.ok){
        const err = await res.text();
        throw new Error(err);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : [];
}

async function dbLoad(){
    return sbFetch(TABLE + '?order=date.asc');
}

async function dbUpsert(row){
    // upsert by date+name (unique combo)
    return sbFetch(TABLE + '?on_conflict=date,name', {
        method:'POST',
        prefer:'resolution=merge-duplicates',
        body: JSON.stringify(row)
    });
}

async function dbDelete(date, name){
    return sbFetch(TABLE + `?date=eq.${encodeURIComponent(date)}&name=eq.${encodeURIComponent(name)}`, {
        method:'DELETE'
    });
}

async function dbDeleteAll(){
    return sbFetch(TABLE + '?id=neq.00000000-0000-0000-0000-000000000000', {
        method:'DELETE'
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT_TEAMS={
    annotation:[
        "Ramyashree Ragupathy","Manoj kumar","Kalyani Dande","Sandhya D","Koteswari","Hari","Uma",
        "Manjunath Bandihal","Akshay Phatale","Maitra Salimath","YATHISH GOWDA KH","Pavan Yeddala",
        "sabarmathi","G umesh","Shilpa E","Prema Joshi","Keerti Doddwad","Ajayreddy","Varun Kumar H N",
        "Sneha B V","Fathima Reneesha P","Vishruthi Raghu","Sanjana G P","Dhanyasri as","Siddharth Anandan",
        "Bindu Sree","Anilkumar","Mihir","Suzan John","Umesh Barker","HR SUNIL KUMAR","Shanta mantri",
        "Nandini Keni","Shweta k","Kishore Devaragudi","ANIL GANDREDDI","K Ganesh","kirany","Vishwas Reddy"
    ],
    assessment:[
        "Sandhya K","Venkatesh Chilukuri","Gowthami TP","Jagadish","kaushik","Ishika","Ramyashree A",
        "Jobin Johnson","Divya K","Sujan Debnath","Sajina NM","Shivaranjani Hiremath","M.Sarvani",
        "vengatesan","V Srividhya","sunkavalli Gayatri","Aashvi"
    ]
};

const LS_TEAMS = 'slackTracker_teams_v1';
let teams = {annotation:[],assessment:[]};
let dbRows = [];   // flat array from Supabase
let lastReport = [];
let activeEmpTab = 'annotation';
let activeViewTab = 'all';
let editContext = null;
let selectedResolution = 'violation';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC STATUS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncStatus(state, msg){
    const bar=document.getElementById('syncBar');
    const dot=document.getElementById('syncDot');
    const txt=document.getElementById('syncMsg');
    bar.className='sync-bar '+(state==='ok'?'':state);
    dot.className='sync-dot '+(state==='ok'?'':state);
    txt.textContent=msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD FROM SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFromCloud(){
    setSyncStatus('loading','Loading shared history from cloudâ€¦');
    try{
        dbRows = await dbLoad();
        setSyncStatus('ok', `âœ… Connected â€” ${dbRows.length} records loaded. Both users share this history.`);
        renderHistory(getHistFilters());
    } catch(e){
        setSyncStatus('error','âŒ Could not connect to database. Check your API key. â€” '+e.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAVE VIOLATIONS TO CLOUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveViolationsForDate(dateStr, report){
    const viols = report.filter(r=>r.status==='Missing'||r.status==='Incomplete');
    setSyncStatus('loading','Saving to cloudâ€¦');
    try{
        // For each violation: upsert (preserving existing resolution if already in DB)
        for(const r of viols){
            const existing = dbRows.find(d=>d.date===dateStr && d.name===r.name);
            const row = {
                date: dateStr,
                name: r.name,
                team: r.team,
                status: r.status,
                login: r.login,
                logout: r.logout,
                working_hours: r.workingHours,
                resolution: existing ? existing.resolution : 'violation',
                reason: existing ? existing.reason : '',
                resolved_at: existing ? existing.resolved_at : ''
            };
            await dbUpsert(row);
        }
        // Reload
        await loadFromCloud();
    } catch(e){
        setSyncStatus('error','âŒ Save failed: '+e.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE RESOLUTION IN CLOUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveResolutionToCloud(date, name, resolution, reason){
    setSyncStatus('loading','Saving resolution to cloudâ€¦');
    try{
        const existing = dbRows.find(d=>d.date===date && d.name===name);
        if(!existing) return;
        const row = {
            ...existing,
            resolution,
            reason,
            resolved_at: resolution!=='violation' ? new Date().toLocaleString() : ''
        };
        await dbUpsert(row);
        await loadFromCloud();
        setSyncStatus('ok','âœ… Resolution saved and synced.');
    } catch(e){
        setSyncStatus('error','âŒ Could not save: '+e.message);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isActive(v){ return v.resolution==='violation'; }

function longestStreak(violations){
    const active=violations.filter(isActive);
    if(!active.length) return 0;
    const dates=[...new Set(active.map(v=>v.date))].sort();
    if(dates.length===1) return 1;
    let max=1,cur=1;
    for(let i=1;i<dates.length;i++){
        const d=(new Date(dates[i])-new Date(dates[i-1]))/86400000;
        if(d===1){cur++;max=Math.max(max,cur);}else cur=1;
    }
    return max;
}

function updateHistBadge(){
    const active=dbRows.filter(isActive).length;
    document.getElementById('histTotalBadge').textContent=active+' active violation'+(active!==1?'s':'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEditModal(date, name){
    const v = dbRows.find(d=>d.date===date && d.name===name);
    if(!v) return;
    editContext = {date, name};
    selectedResolution = v.resolution||'violation';

    document.getElementById('editInfoBox').innerHTML=`
        <div class="vi-row"><span>Employee</span><strong>${esc(v.name)}</strong></div>
        <div class="vi-row"><span>Date</span><strong>${formatDate(date)}</strong></div>
        <div class="vi-row"><span>Team</span><strong>${teamLabel(v.team)}</strong></div>
        <div class="vi-row"><span>Original Status</span><strong>${v.status}</strong></div>
        <div class="vi-row"><span>Login</span><strong>${v.login}</strong></div>
        <div class="vi-row"><span>Logout</span><strong>${v.logout}</strong></div>`;

    document.getElementById('editReason').value = v.reason||'';
    updateResOptions(); updateReasonLabel();
    document.getElementById('editOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('editReason').focus(),100);
}

function updateResOptions(){
    document.getElementById('resOptViolation').className='res-option'+(selectedResolution==='violation'?' selected-violation':'');
    document.getElementById('resOptLeave').className='res-option'+(selectedResolution==='On Leave'?' selected-on-leave':'');
    document.getElementById('resOptIgnored').className='res-option'+(selectedResolution==='Ignored'?' selected-ignored':'');
}

function updateReasonLabel(){
    document.getElementById('editReasonRequired').style.display=selectedResolution!=='violation'?'inline':'none';
}

async function saveEdit(){
    const reason = document.getElementById('editReason').value.trim();
    const ta = document.getElementById('editReason');
    ta.classList.remove('required-shake');
    if(selectedResolution!=='violation' && !reason){
        void ta.offsetWidth; ta.classList.add('required-shake'); ta.focus(); return;
    }
    closeEditModal();
    await saveResolutionToCloud(editContext.date, editContext.name, selectedResolution, reason);
    const label = selectedResolution==='violation'?'reverted to Violation':
                  selectedResolution==='On Leave'?'marked as On Leave':'marked as Ignored';
    showToast(`âœ… ${esc(editContext.name)} â€” ${label} (synced to cloud)`);
}

function closeEditModal(){ document.getElementById('editOverlay').classList.remove('open'); editContext=null; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory(filters={}){
    updateHistBadge();
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];

    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from) violations=violations.filter(v=>v.date>=from);
    if(to)   violations=violations.filter(v=>v.date<=to);

    const active   =violations.filter(isActive).length;
    const resolved =violations.filter(v=>!isActive(v)).length;
    const onLeave  =violations.filter(v=>v.resolution==='On Leave').length;
    const ignored  =violations.filter(v=>v.resolution==='Ignored').length;
    const uniqueEmp=new Set(violations.map(v=>v.name)).size;
    const uniqueDays=new Set(violations.map(v=>v.date)).size;

    document.getElementById('histSummary').innerHTML=`
        <div class="hist-stat"><div class="hv">${violations.length}</div><div class="hl">Total Records</div></div>
        <div class="hist-stat"><div class="hv">${active}</div><div class="hl">Active Violations</div></div>
        <div class="hist-stat"><div class="hv" style="color:#27ae60">${resolved}</div><div class="hl">Resolved</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6c757d">${onLeave}</div><div class="hl">On Leave</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6f42c1">${ignored}</div><div class="hl">Ignored</div></div>
        <div class="hist-stat"><div class="hv" style="color:#e67e22">${uniqueEmp}</div><div class="hl">Employees</div></div>
        <div class="hist-stat"><div class="hv" style="color:#1a4d8c">${uniqueDays}</div><div class="hl">Days</div></div>`;

    const content=document.getElementById('histContent');
    if(!violations.length){content.innerHTML='<div class="no-history">ğŸ‰ No records match the current filters.</div>';return;}

    const byEmp={};
    violations.forEach(v=>{
        if(!byEmp[v.name]) byEmp[v.name]={name:v.name,team:v.team,violations:[]};
        byEmp[v.name].violations.push(v);
    });

    const sorted=Object.values(byEmp).sort((a,b)=>
        b.violations.filter(isActive).length - a.violations.filter(isActive).length
    );

    content.innerHTML=sorted.map((emp,i)=>{
        const activeV=emp.violations.filter(isActive).length;
        const resolvedV=emp.violations.filter(v=>!isActive(v)).length;
        const streak=longestStreak(emp.violations);
        const streakBadge=streak>=3?`<span class="hist-streak">ğŸ”¥ ${streak}-day streak</span>`:'';
        const teamBadge=`<span class="team-badge ${emp.team}">${emp.team==='annotation'?'Annotation':'Assessment'}</span>`;
        const activeBadge=activeV?`<span class="hist-violations-count">${activeV} active</span>`:'';
        const resolvedBadge=resolvedV?`<span class="hist-resolved-count">${resolvedV} resolved</span>`:'';

        const rows=emp.violations.sort((a,b)=>b.date.localeCompare(a.date)).map(v=>{
            const res=v.resolution||'violation';
            const rowClass=res==='violation'
                ?`viol-row-${v.status.toLowerCase()}`
                :`viol-row-resolved-${res.toLowerCase().replace(' ','-')}`;

            let resBadge='';
            if(res==='On Leave') resBadge=`<span class="res-badge res-leave">ğŸ“… On Leave</span>`;
            else if(res==='Ignored') resBadge=`<span class="res-badge res-ignored">ğŸ”• Ignored</span>`;

            const reasonHtml=v.reason?`<div class="res-reason">ğŸ’¬ ${esc(v.reason)}</div>`:'';
            const resolvedAtHtml=v.resolved_at?`<div class="res-reason">ğŸ• ${v.resolved_at}</div>`:'';

            const statusHtml=res==='violation'
                ?`<span class="status-badge status-${v.status.toLowerCase()}">${v.status==='Missing'?'â“':'âš ï¸'} ${v.status}</span>`
                :`${resBadge}<div style="font-size:11px;color:#888;margin-top:3px;">was: ${v.status}</div>`;

            return`<tr class="${rowClass}">
                <td>${formatDate(v.date)}</td>
                <td>${statusHtml}${reasonHtml}${resolvedAtHtml}</td>
                <td><span class="time-badge">${v.login}</span></td>
                <td><span class="time-badge">${v.logout}</span></td>
                <td>${v.working_hours}</td>
                <td><button class="btn btn-xs btn-secondary"
                    onclick="openEditModal('${v.date}','${v.name.replace(/'/g,"\\'")}')">âœï¸ Edit</button></td>
            </tr>`;
        }).join('');

        return`<div class="hist-emp-block">
            <div class="hist-emp-header" onclick="toggleHistBlock('hb${i}')">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span class="hist-emp-name">${esc(emp.name)}</span>${teamBadge}
                </div>
                <div class="hist-emp-meta">${streakBadge}${activeBadge}${resolvedBadge}
                    <span style="color:#aaa;font-size:13px;">â–¼</span>
                </div>
            </div>
            <div class="hist-emp-body" id="hb${i}">
                <table class="hist-table"><thead><tr>
                    <th>Date</th><th>Status / Resolution</th><th>Login</th><th>Logout</th><th>Hours</th><th>Action</th>
                </tr></thead><tbody>${rows}</tbody></table>
            </div>
        </div>`;
    }).join('');
}

function toggleHistBlock(id){const el=document.getElementById(id);if(el)el.classList.toggle('open');}

function formatDate(d){
    if(!d)return'-';
    return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
}

function getHistFilters(){
    return{team:document.getElementById('histTeamFilter').value,
           type:document.getElementById('histTypeFilter').value,
           from:document.getElementById('histFromDate').value,
           to:  document.getElementById('histToDate').value};
}

function exportHistoryCSV(filters={}){
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];
    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from)violations=violations.filter(v=>v.date>=from);
    if(to)  violations=violations.filter(v=>v.date<=to);
    if(!violations.length){showToast('No records to export.');return;}
    let csv='Date,Employee,Team,Original Status,Resolution,Login,Logout,Working Hours,Reason,Resolved At\n';
    violations.forEach(v=>{
        csv+=`"${v.date}","${v.name}","${teamLabel(v.team)}","${v.status}","${v.resolution}","${v.login}","${v.logout}","${v.working_hours}","${(v.reason||'').replace(/"/g,'""')}","${v.resolved_at||''}"\n`;
    });
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`violation-history-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPLOYEE MANAGEMENT  (stays in localStorage â€” same for all)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadTeams(){
    try{const r=localStorage.getItem(LS_TEAMS);if(r){const p=JSON.parse(r);if(p&&p.annotation&&p.assessment){teams=p;return;}}}catch(e){}
    teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
}
function saveTeams(){try{localStorage.setItem(LS_TEAMS,JSON.stringify(teams));}catch(e){}}

function renderEmpGrid(){
    const list=[...teams[activeEmpTab]].sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    document.getElementById('countAnnotation').textContent=teams.annotation.length;
    document.getElementById('countAssessment').textContent=teams.assessment.length;
    document.getElementById('empCount').textContent=teams.annotation.length+teams.assessment.length;
    const grid=document.getElementById('empGrid');
    if(!list.length){grid.innerHTML='<p style="color:#bbb;font-size:13px;grid-column:1/-1;padding:10px 0;">No employees yet.</p>';return;}
    grid.innerHTML=list.map(name=>`
        <div class="emp-chip ${activeEmpTab}">
            <span class="emp-name" title="${esc(name)}">${esc(name)}</span>
            <button class="remove-btn" data-name="${esc(name)}" title="Remove">âœ•</button>
        </div>`).join('');
    grid.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',()=>confirmRemove(btn.dataset.name,activeEmpTab)));
    document.getElementById('newEmpTeam').value=activeEmpTab;
}

function switchEmpTab(t){
    activeEmpTab=t;
    document.getElementById('tabAnnotation').className='team-tab'+(t==='annotation'?' active-annotation':'');
    document.getElementById('tabAssessment').className='team-tab'+(t==='assessment'?' active-assessment':'');
    renderEmpGrid();
}

function addEmployee(){
    const input=document.getElementById('newEmpInput');
    const team=document.getElementById('newEmpTeam').value;
    const name=input.value.trim();
    input.classList.remove('shake');
    if(!name){void input.offsetWidth;input.classList.add('shake');input.focus();return;}
    if(allEmployees().some(e=>e.toLowerCase()===name.toLowerCase())){showToast(`âš ï¸ "${name}" already exists`);input.select();return;}
    teams[team].push(name);saveTeams();switchEmpTab(team);input.value='';input.focus();
    showToast(`âœ… "${name}" added to ${teamLabel(team)}`);
}

function confirmRemove(name,team){
    openConfirm('Remove Employee',`Remove <strong>${esc(name)}</strong> from ${teamLabel(team)}?`,()=>{
        teams[team]=teams[team].filter(e=>e!==name);saveTeams();renderEmpGrid();showToast(`ğŸ—‘ï¸ "${name}" removed`);
    });
}

function resetToDefaults(){
    openConfirm('Reset to Defaults','Replace both team lists with the original default employees?',()=>{
        teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
        saveTeams();renderEmpGrid();showToast('â†© Reset to defaults');
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dbg=[];
function addDebug(m){_dbg.push(m);}
function clearDebug(){_dbg=[];}
function flushDebug(){document.getElementById('debugInfo').innerHTML=_dbg.join('<br>');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function norm(n){return n.trim().toLowerCase().replace(/\s+/g,' ');}
function allEmployees(){return[...teams.annotation,...teams.assessment];}
function teamLabel(t){return t==='annotation'?'Data Annotation':'Data Assessment / DA';}
function getTeam(name){
    const n=norm(name);
    if(teams.annotation.some(e=>norm(e)===n))return 'annotation';
    if(teams.assessment.some(e=>norm(e)===n))return 'assessment';
    return null;
}
function findEmployee(rawName){
    const n=norm(rawName);const all=allEmployees();
    return all.find(e=>norm(e)===n)||all.find(e=>n.includes(norm(e))||norm(e).includes(n))||rawName;
}
function timeToMinutes(str){
    if(!str)return null;
    str=str.trim().toUpperCase().replace(/\./g,':').replace(/\s+/g,' ').replace(/(\d)([AP]M)/,'$1 $2');
    const pm=str.includes('PM'),am=str.includes('AM');
    str=str.replace(/[AP]M/,'').trim();
    let[h,m]=str.split(':');h=parseInt(h,10);m=parseInt(m,10)||0;
    if(isNaN(h))return null;
    if(pm&&h!==12)h+=12;if(am&&h===12)h=0;
    return h*60+m;
}

let _tt=null;
function showToast(msg){const t=document.getElementById('toast');t.innerHTML=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2800);}

let _ccb=null;
function openConfirm(title,msg,cb){
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').innerHTML=msg;
    document.getElementById('confirmOverlay').classList.add('open');_ccb=cb;
}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('open');_ccb=null;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseMessages(rawText){
    clearDebug();addDebug('=== Parsing ===');
    const lines=rawText.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    const headerRe=/^(.+?)\s+\[(\d{1,2}:\d{2}\s*[AP]M)\]\s*$/i;
    const msgs=[];let cur=null;
    function flush(){
        if(!cur)return;
        const body=cur.lines.join('\n');
        if(/\bon\s+leave\b/i.test(body)){msgs.push({name:cur.name,type:'leave'});return;}
        if(/\b(in\s+working|working\s+on)\b/i.test(body)||/\blogin\b/i.test(body)){msgs.push({name:cur.name,type:'login',time:cur.time});return;}
        if(/\bworked\s+on\b/i.test(body)||/\blogout\b/i.test(body)){msgs.push({name:cur.name,type:'logout',time:cur.time});return;}
    }
    for(const rawLine of lines){
        const line=rawLine.trim();if(!line)continue;
        const hm=line.match(headerRe);
        if(hm){flush();cur={name:findEmployee(hm[1].trim()),time:hm[2].replace(/\s+/g,' '),lines:[]};}
        else if(cur){cur.lines.push(line);if(/\bon\s+leave\b/i.test(line)){flush();cur=null;}}
    }
    flush();addDebug(`Events: ${msgs.length}`);flushDebug();return msgs;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT BUILDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReport(msgs){
    const state={};
    allEmployees().forEach(n=>{state[n]={logins:[],logouts:[],onLeave:false};});
    msgs.forEach(m=>{
        const s=state[m.name];if(!s)return;
        if(m.type==='leave')s.onLeave=true;
        if(m.type==='login')s.logins.push(m.time);
        if(m.type==='logout')s.logouts.push(m.time);
    });
    return Object.keys(state).sort().map(name=>{
        const s=state[name];const team=getTeam(name)||'annotation';
        if(s.onLeave)return{name,team,login:'-',logout:'-',workingHours:'-',status:'On Leave',statusClass:'status-leave',icon:'ğŸ“…'};
        const login=s.logins.sort((a,b)=>(timeToMinutes(a)||0)-(timeToMinutes(b)||0))[0]||null;
        const logout=s.logouts.sort((a,b)=>(timeToMinutes(b)||0)-(timeToMinutes(a)||0))[0]||null;
        let hours='-';
        if(login&&logout){const d=timeToMinutes(logout)-timeToMinutes(login);hours=((d<0?d+1440:d)/60).toFixed(2)+' hrs';}
        const status=login&&logout?'Complete':(login||logout)?'Incomplete':'Missing';
        const statusClass={Complete:'status-complete',Incomplete:'status-incomplete',Missing:'status-missing'}[status];
        const icon={Complete:'âœ…',Incomplete:'âš ï¸',Missing:'â“'}[status];
        return{name,team,login:login||'âŒ No login',logout:logout||'âŒ No logout',workingHours:hours,status,statusClass,icon};
    });
}

function calcStats(rows){
    const total=rows.length,comp=rows.filter(r=>r.status==='Complete').length,
          inc=rows.filter(r=>r.status==='Incomplete').length,
          leave=rows.filter(r=>r.status==='On Leave').length,
          miss=rows.filter(r=>r.status==='Missing').length,
          rate=total?((comp/total)*100).toFixed(1):'0';
    return{total,comp,inc,leave,miss,rate};
}
function renderStats(rows){
    const s=calcStats(rows);
    document.getElementById('statsContainer').innerHTML=`
        <div class="stat-card"><h3>Total</h3><div class="value">${s.total}</div></div>
        <div class="stat-card"><h3>âœ… Complete</h3><div class="value complete">${s.comp}</div></div>
        <div class="stat-card"><h3>âš ï¸ Incomplete</h3><div class="value incomplete">${s.inc}</div></div>
        <div class="stat-card"><h3>ğŸ“… On Leave</h3><div class="value leave">${s.leave}</div></div>
        <div class="stat-card"><h3>âŒ Missing</h3><div class="value missing">${s.miss}</div></div>
        <div class="stat-card"><h3>Completion</h3><div class="value">${s.rate}%</div></div>`;
}
function empRow(e){
    return`<tr>
        <td><strong>${esc(e.name)}</strong></td>
        <td><span class="team-badge ${e.team}">${e.team==='annotation'?'Annotation':'Assessment'}</span></td>
        <td><span class="status-badge ${e.statusClass}">${e.icon} ${e.status}</span></td>
        <td><span class="time-badge">${e.login}</span></td>
        <td><span class="time-badge">${e.logout}</span></td>
        <td><strong>${e.workingHours}</strong></td>
    </tr>`;
}
function renderView(view){
    activeViewTab=view;
    document.querySelectorAll('.view-tab').forEach(t=>{const v=t.dataset.view;t.className='view-tab'+(v===view?' active-'+view:'');});
    const filtered=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    document.getElementById('statsLabel').textContent=view==='all'?'All Employees':view==='annotation'?'Data Annotation':'Data Assessment / DA';
    renderStats(filtered);
    if(!filtered.length){document.getElementById('tableContainer').innerHTML='<p style="padding:20px;color:#aaa;">No data.</p>';return;}
    let rows='';
    if(view==='all'){
        const ann=filtered.filter(r=>r.team==='annotation'),ass=filtered.filter(r=>r.team==='assessment');
        rows+=`<tr class="team-header-row annotation"><td colspan="6">ğŸ”µ Data Annotation Team (${ann.length})</td></tr>`+ann.map(empRow).join('');
        rows+=`<tr class="team-header-row assessment"><td colspan="6">ğŸŸ  Data Assessment / DA Team (${ass.length})</td></tr>`+ass.map(empRow).join('');
    }else rows=filtered.map(empRow).join('');
    document.getElementById('tableContainer').innerHTML=`
        <table><thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th></tr></thead>
        <tbody>${rows}</tbody></table>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const sampleData1=`Ramyashree Ragupathy  [8:59 AM]
In working on car parts updates
Koteswari  [9:09 AM]
Working on all_new_car_parts _rear bumper review.
Anilkumar  [9:09 AM]
Working on all_new_car_parts_rear_bumper annotation.
Manoj kumar  [9:13 AM]
Working on volvo_pov_damage_2 Annotation.
Hari  [9:19 AM]
In working on VOLVO_POV_damage Review.
Kalyani Dande  [9:24 AM]
Working on all_new_car_parts_rear_bumper annotation.
Uma  [9:29 AM]
Working on all new car parts annotation.
Koteswari  [6:11 PM]
Worked on all_new_car_parts _rear bumper review.
Anilkumar  [6:11 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Hari  [6:18 PM]
Worked on VOLVO_POV_damage Review.
Manoj kumar  [6:21 PM]
Worked on volvo_pov_damage_2 Annotation.
Kalyani Dande  [6:25 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Uma  [6:30 PM]
Worked on all new car parts annotation.
Ramyashree Ragupathy  [6:37 PM]
Worked on car parts updates`;

const sampleData2=`Ishika  [7:16 AM]
Login - Working on: Production portals
Remarks: Nil
Jobin Johnson  [8:00 AM]
Login - Working on: Work hours 08:00 AM
Remarks: Nil
Jagadish  [8:04 AM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [8:31 AM]
Login - Working on: Production portals
Remarks: Nil
Sandhya K  [9:01 AM]
On leave
sunkavalli Gayatri  [9:28 AM]
Login - Working on: Production portal
Remarks: Nil
Gowthami TP  [9:29 AM]
Login - Working on: Pilot Portals
Remarks: Nil
Sajina NM  [9:32 AM]
Login - Working on: Production portals
Remarks: Nil
vengatesan  [9:56 AM]
On leave
M.Sarvani  [10:01 AM]
Login-Working on: Production portals
Remarks:Nil
Divya K  [10:59 AM]
Login - Working on: Production portals
Remarks: Nil
Ishika  [5:33 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.
Jobin Johnson  [5:36 PM]
Logout - Worked on: Production Portals
Remarks: Done
Gowthami TP  [6:30 PM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [6:30 PM]
Logout - Worked on: Production Portals
Remarks: 30 mins extra.
Sajina NM  [6:33 PM]
Logout - Worked on: Production Portals
Remarks: NIL
sunkavalli Gayatri  [7:01 PM]
Logout - Worked on: Production Portals
Remarks: Extended 30 mins
M.Sarvani  [7:35 PM]
Logout - Worked on: Production Portals
Remarks: 30mins extra.
Divya K  [8:31 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.`;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processMessages(){
    const input=document.getElementById('slackInput').value.trim();
    if(!input){alert('Please paste some Slack messages first!');return;}
    const msgs=parseMessages(input);
    if(!msgs.length){alert('No valid messages detected.');return;}
    lastReport=buildReport(msgs);
    let dateStr=document.getElementById('reportDate').value;
    if(!dateStr)dateStr=new Date().toISOString().split('T')[0];
    const ann=lastReport.filter(r=>r.team==='annotation'),ass=lastReport.filter(r=>r.team==='assessment');
    document.getElementById('tcAll').textContent=lastReport.length;
    document.getElementById('tcAnnotation').textContent=ann.length;
    document.getElementById('tcAssessment').textContent=ass.length;
    document.getElementById('viewTabs').style.display='flex';
    document.getElementById('resultsArea').style.display='block';
    renderView(activeViewTab);
    await saveViolationsForDate(dateStr,lastReport);
    const hp=document.getElementById('histPanelToggle'),hb=document.getElementById('histPanelBody');
    if(!hb.classList.contains('open')){hp.classList.add('open');hb.classList.add('open');}
    const vc=lastReport.filter(r=>r.status==='Missing'||r.status==='Incomplete').length;
    showToast(vc?`âœ… Saved to cloud. <strong>${vc} violation${vc!==1?'s':''}</strong> recorded.`:`âœ… Saved â€” everyone compliant!`);
    document.getElementById('lastUpdated').textContent=`âœ“ Last updated: ${new Date().toLocaleString()}`;
}

function clearAll(){
    document.getElementById('slackInput').value='';
    document.getElementById('viewTabs').style.display='none';
    document.getElementById('resultsArea').style.display='none';
    document.getElementById('lastUpdated').textContent='';
    lastReport=[];clearDebug();document.getElementById('debugInfo').innerHTML='';
}

function exportCSV(){
    if(!lastReport.length){alert('Process messages first!');return;}
    const view=activeViewTab,rows=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    let csv='Employee,Team,Status,Login,Logout,Working Hours\n';
    rows.forEach(r=>{csv+=`"${r.name}","${teamLabel(r.team)}","${r.status}","${r.login}","${r.logout}","${r.workingHours}"\n`;});
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`slack-attendance-${view}-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',async function(){
    loadTeams();renderEmpGrid();
    document.getElementById('reportDate').value=new Date().toISOString().split('T')[0];
    await loadFromCloud();

    document.getElementById('empPanelToggle').addEventListener('click',()=>{
        document.getElementById('empPanelToggle').classList.toggle('open');
        document.getElementById('empPanelBody').classList.toggle('open');
    });
    document.getElementById('tabAnnotation').addEventListener('click',()=>switchEmpTab('annotation'));
    document.getElementById('tabAssessment').addEventListener('click',()=>switchEmpTab('assessment'));
    document.getElementById('newEmpTeam').addEventListener('change',e=>switchEmpTab(e.target.value));
    document.getElementById('addEmpBtn').addEventListener('click',addEmployee);
    document.getElementById('newEmpInput').addEventListener('keydown',e=>{if(e.key==='Enter')addEmployee();});
    document.getElementById('resetEmpBtn').addEventListener('click',resetToDefaults);

    document.getElementById('histPanelToggle').addEventListener('click',()=>{
        document.getElementById('histPanelToggle').classList.toggle('open');
        document.getElementById('histPanelBody').classList.toggle('open');
    });
    document.getElementById('refreshHistBtn').addEventListener('click',e=>{e.stopPropagation();loadFromCloud();});
    document.getElementById('histFilterBtn').addEventListener('click',()=>renderHistory(getHistFilters()));
    document.getElementById('histResetFilterBtn').addEventListener('click',()=>{
        ['histTeamFilter','histTypeFilter','histFromDate','histToDate'].forEach(id=>document.getElementById(id).value=id.includes('Filter')?'all':'');
        renderHistory();
    });
    document.getElementById('histExportBtn').addEventListener('click',()=>exportHistoryCSV(getHistFilters()));
    document.getElementById('histClearBtn').addEventListener('click',()=>{
        openConfirm('Clear All History','This will permanently delete ALL violation history for both users. Cannot be undone.',async()=>{
            setSyncStatus('loading','Deleting all recordsâ€¦');
            try{await dbDeleteAll();await loadFromCloud();showToast('ğŸ—‘ï¸ History cleared.');}
            catch(e){setSyncStatus('error','Delete failed: '+e.message);}
        });
    });

    document.getElementById('confirmOk').addEventListener('click',()=>{if(_ccb)_ccb();closeConfirm();});
    document.getElementById('confirmCancel').addEventListener('click',closeConfirm);
    document.getElementById('confirmOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('confirmOverlay'))closeConfirm();});

    document.querySelectorAll('.res-option').forEach(opt=>{
        opt.addEventListener('click',()=>{selectedResolution=opt.dataset.res;updateResOptions();updateReasonLabel();});
    });
    document.getElementById('editSave').addEventListener('click',saveEdit);
    document.getElementById('editCancel').addEventListener('click',closeEditModal);
    document.getElementById('editClose').addEventListener('click',closeEditModal);
    document.getElementById('editOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('editOverlay'))closeEditModal();});

    document.querySelectorAll('.view-tab').forEach(t=>t.addEventListener('click',()=>renderView(t.dataset.view)));
    document.getElementById('processBtn').addEventListener('click',processMessages);
    document.getElementById('clearBtn').addEventListener('click',clearAll);
    document.getElementById('exportBtn').addEventListener('click',exportCSV);
    document.getElementById('debugBtn').addEventListener('click',()=>{
        const d=document.getElementById('debugInfo');d.style.display=d.style.display==='block'?'none':'block';
    });
    document.getElementById('sample1Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData1;processMessages();});
    document.getElementById('sample2Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData2;processMessages();});
});
</script>
</body>
</html>
