<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Login/Logout Tracker</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
        body{background:#f0f2f5;padding:20px;}
        .container{max-width:1500px;margin:0 auto;}
        .header{background:linear-gradient(135deg,#1a4d8c 0%,#2c3e50 100%);color:white;padding:20px 30px;border-radius:15px 15px 0 0;}
        .header h1{font-size:24px;margin-bottom:5px;}
        .header p{opacity:.9;font-size:14px;}

        /* sync status bar */
        .sync-bar{background:#e8f5e9;border:1px solid #c8e6c9;border-radius:8px;padding:10px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:13px;color:#2e7d32;}
        .sync-bar.error{background:#fdecea;border-color:#f5c6cb;color:#c62828;}
        .sync-bar.loading{background:#e3f2fd;border-color:#bbdefb;color:#1565c0;}
        .sync-dot{width:10px;height:10px;border-radius:50%;background:#27ae60;flex-shrink:0;}
        .sync-dot.error{background:#dc3545;}
        .sync-dot.loading{background:#1a4d8c;animation:pulse 1s infinite;}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

        /* panels */
        .panel{background:white;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.1);margin-bottom:20px;overflow:hidden;}
        .panel-header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;cursor:pointer;user-select:none;}
        .panel-header h2{font-size:15px;color:#333;font-weight:600;display:flex;align-items:center;gap:8px;}
        .panel-body{display:none;padding:20px;}
        .panel-body.open{display:block;}
        .toggle-icon{font-size:14px;color:#888;transition:transform .25s;}
        .panel-header.open .toggle-icon{transform:rotate(180deg);}

        .badge{font-size:12px;font-weight:700;padding:2px 9px;border-radius:20px;display:inline-block;}
        .badge-blue{background:#1a4d8c;color:white;}
        .badge-red{background:#dc3545;color:white;}

        .team-tabs{display:flex;gap:8px;margin-bottom:18px;flex-wrap:wrap;}
        .team-tab{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:2px solid transparent;transition:all .2s;background:#f0f2f5;color:#555;}
        .team-tab.active-annotation{background:#e8f0fe;color:#1a4d8c;border-color:#1a4d8c;}
        .team-tab.active-assessment{background:#fef3e8;color:#c0631a;border-color:#c0631a;}

        .add-emp-row{display:flex;gap:10px;margin-bottom:18px;}
        .add-emp-row input{flex:1;padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;transition:border-color .2s;}
        .add-emp-row input:focus{outline:none;border-color:#1a4d8c;}
        .add-emp-row input.shake{animation:shake .3s;border-color:#dc3545;}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
        .emp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;max-height:260px;overflow-y:auto;padding-right:4px;}
        .emp-chip{display:flex;align-items:center;justify-content:space-between;border-radius:8px;padding:8px 12px;font-size:13px;color:#333;transition:background .15s;}
        .emp-chip.annotation{background:#e8f0fe;} .emp-chip.annotation:hover{background:#d2e3fc;}
        .emp-chip.assessment{background:#fef3e8;} .emp-chip.assessment:hover{background:#fde0c0;}
        .emp-chip .emp-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
        .emp-chip .remove-btn{background:none;border:none;cursor:pointer;color:#ccc;font-size:16px;line-height:1;padding:0 0 0 8px;transition:color .15s;flex-shrink:0;}
        .emp-chip .remove-btn:hover{color:#dc3545;}
        .panel-footer{display:flex;align-items:center;justify-content:space-between;margin-top:14px;padding-top:14px;border-top:1px solid #eee;font-size:12px;color:#999;flex-wrap:wrap;gap:10px;}

        .btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;}
        .btn-sm{padding:6px 14px;font-size:12px;}
        .btn-xs{padding:4px 10px;font-size:11px;}
        .btn-primary{background:#1a4d8c;color:white;} .btn-primary:hover{background:#0d3a6b;}
        .btn-secondary{background:#e0e0e0;color:#333;} .btn-secondary:hover{background:#d0d0d0;}
        .btn-success{background:#27ae60;color:white;} .btn-success:hover{background:#219a52;}
        .btn-info{background:#17a2b8;color:white;} .btn-info:hover{background:#138496;}
        .btn-danger{background:#dc3545;color:white;} .btn-danger:hover{background:#b02a37;}
        .btn-warning{background:#e67e22;color:white;} .btn-warning:hover{background:#ca6f1e;}

        .input-section{background:white;padding:20px;border-radius:0 0 15px 15px;box-shadow:0 4px 6px rgba(0,0,0,.1);margin-bottom:20px;}
        .input-section textarea{width:100%;height:280px;padding:15px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;font-family:monospace;resize:vertical;margin-bottom:15px;line-height:1.5;}
        .input-section textarea:focus{outline:none;border-color:#1a4d8c;}
        .button-group{display:flex;gap:10px;flex-wrap:wrap;}
        .date-row{display:flex;align-items:center;gap:12px;margin-bottom:15px;flex-wrap:wrap;}
        .date-row label{font-size:14px;font-weight:600;color:#555;}
        .date-row input[type=date]{padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;cursor:pointer;}
        .date-row input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .date-row .date-hint{font-size:12px;color:#999;}

        .view-tabs{display:flex;gap:0;border-radius:10px 10px 0 0;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,.08);}
        .view-tab{flex:1;padding:14px;text-align:center;font-size:14px;font-weight:600;cursor:pointer;background:#e9ecef;color:#555;border:none;transition:background .2s,color .2s;}
        .view-tab .tab-count{font-size:11px;font-weight:700;margin-left:6px;padding:2px 7px;border-radius:20px;background:rgba(0,0,0,.1);}
        .view-tab.active-all{background:#2c3e50;color:white;}
        .view-tab.active-annotation{background:#1a4d8c;color:white;}
        .view-tab.active-assessment{background:#c0631a;color:white;}

        .stats-wrapper{background:white;padding:16px 16px 0;border-top:1px solid #dee2e6;}
        .stats-label{font-size:12px;font-weight:700;text-transform:uppercase;color:#999;letter-spacing:.5px;margin-bottom:10px;}
        .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px;}
        .stat-card{background:#f8f9fa;padding:16px;border-radius:10px;text-align:center;border:1px solid #eee;}
        .stat-card h3{color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase;letter-spacing:.4px;}
        .stat-card .value{font-size:28px;font-weight:bold;color:#1a4d8c;}
        .stat-card .value.complete{color:#27ae60;} .stat-card .value.incomplete{color:#e67e22;}
        .stat-card .value.leave{color:#6c757d;} .stat-card .value.missing{color:#dc3545;}

        .table-container{background:white;border-radius:0 0 10px 10px;box-shadow:0 2px 4px rgba(0,0,0,.1);overflow:auto;max-height:600px;}
        table{width:100%;border-collapse:collapse;}
        th{background:#f8f9fa;color:#333;font-weight:600;font-size:13px;padding:14px 15px;text-align:left;border-bottom:2px solid #dee2e6;position:sticky;top:0;z-index:10;white-space:nowrap;}
        td{padding:11px 15px;border-bottom:1px solid #e0e0e0;font-size:14px;}
        tr:hover td{background:#f5f5f5;}
        .team-header-row td{font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.5px;padding:8px 15px;border-bottom:2px solid #dee2e6;}
        .team-header-row.annotation td{background:#e8f0fe;color:#1a4d8c;}
        .team-header-row.assessment td{background:#fef3e8;color:#c0631a;}

        .status-badge{padding:4px 8px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block;}
        .status-complete{background:#d4edda;color:#155724;}
        .status-incomplete{background:#fff3cd;color:#856404;}
        .status-leave{background:#e2e3e5;color:#383d41;}
        .status-missing{background:#f8d7da;color:#721c24;}
        .time-badge{background:#e9ecef;padding:4px 8px;border-radius:15px;font-size:12px;}
        .team-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block;}
        .team-badge.annotation{background:#e8f0fe;color:#1a4d8c;}
        .team-badge.assessment{background:#fef3e8;color:#c0631a;}

        /* history */
        .history-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
        .history-toolbar select,.history-toolbar input[type=date]{padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;}
        .history-toolbar select:focus,.history-toolbar input[type=date]:focus{outline:none;border-color:#1a4d8c;}
        .history-toolbar label{font-size:13px;font-weight:600;color:#555;}

        .hist-emp-block{border:1px solid #e0e0e0;border-radius:10px;margin-bottom:10px;overflow:hidden;}
        .hist-emp-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#f8f9fa;cursor:pointer;user-select:none;gap:10px;flex-wrap:wrap;}
        .hist-emp-header:hover{background:#eef0f3;}
        .hist-emp-name{font-weight:700;font-size:14px;color:#2c3e50;}
        .hist-emp-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
        .hist-violations-count{background:#dc3545;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-resolved-count{background:#27ae60;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-streak{background:#e67e22;color:white;font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
        .hist-emp-body{display:none;}
        .hist-emp-body.open{display:block;}
        .hist-table{width:100%;border-collapse:collapse;}
        .hist-table th{background:#f0f2f5;font-size:12px;padding:10px 14px;text-align:left;font-weight:600;color:#555;border-bottom:1px solid #dee2e6;}
        .hist-table td{padding:9px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;vertical-align:middle;}
        .hist-table tr:last-child td{border-bottom:none;}
        .hist-table tr:hover td{background:#fafafa;}
        .viol-row-missing td:first-child{border-left:4px solid #dc3545;}
        .viol-row-incomplete td:first-child{border-left:4px solid #e67e22;}
        .viol-row-resolved-leave td:first-child{border-left:4px solid #6c757d;}
        .viol-row-resolved-ignored td:first-child{border-left:4px solid #6f42c1;}
        .viol-row-resolved-leave td,.viol-row-resolved-ignored td{opacity:.65;}
        .res-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:4px;}
        .res-leave{background:#e2e3e5;color:#383d41;}
        .res-ignored{background:#e8d5ff;color:#5a32a3;}
        .res-reason{font-size:11px;color:#888;margin-top:3px;font-style:italic;}
        .no-history{padding:40px;text-align:center;color:#aaa;font-size:14px;}
        .history-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-bottom:18px;}
        .hist-stat{background:#f8f9fa;border:1px solid #eee;border-radius:8px;padding:12px;text-align:center;}
        .hist-stat .hv{font-size:22px;font-weight:bold;color:#dc3545;}
        .hist-stat .hl{font-size:11px;text-transform:uppercase;color:#999;margin-top:4px;}

        /* edit modal */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;align-items:center;justify-content:center;}
        .modal-overlay.open{display:flex;}
        .modal-confirm{background:white;border-radius:12px;padding:28px 32px;max-width:420px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,.2);text-align:center;}
        .modal-confirm h3{font-size:18px;margin-bottom:10px;color:#2c3e50;}
        .modal-confirm p{font-size:14px;color:#666;margin-bottom:22px;line-height:1.5;}
        .modal-btns{display:flex;gap:12px;justify-content:center;}
        .modal-edit{background:white;border-radius:14px;width:90%;max-width:520px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-edit-header{background:linear-gradient(135deg,#1a4d8c,#2c3e50);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;}
        .modal-edit-header h3{font-size:16px;font-weight:700;}
        .modal-edit-close{background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;opacity:.8;}
        .modal-edit-close:hover{opacity:1;}
        .modal-edit-body{padding:24px;}
        .viol-info-box{background:#f8f9fa;border-radius:8px;padding:14px 16px;margin-bottom:20px;border:1px solid #e0e0e0;}
        .viol-info-box .vi-row{display:flex;justify-content:space-between;font-size:13px;padding:3px 0;color:#555;}
        .viol-info-box .vi-row strong{color:#2c3e50;}
        .resolution-options{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px;}
        .res-option{border:2px solid #e0e0e0;border-radius:10px;padding:14px 10px;text-align:center;cursor:pointer;transition:all .2s;background:white;}
        .res-option:hover{border-color:#1a4d8c;background:#f0f4ff;}
        .res-option.selected-violation{border-color:#dc3545;background:#fff5f5;}
        .res-option.selected-on-leave{border-color:#6c757d;background:#f5f5f5;}
        .res-option.selected-ignored{border-color:#6f42c1;background:#f5f0ff;}
        .res-option .res-icon{font-size:24px;margin-bottom:6px;}
        .res-option .res-label{font-size:12px;font-weight:700;color:#333;}
        .res-option .res-desc{font-size:11px;color:#888;margin-top:3px;}
        .reason-field{margin-bottom:20px;}
        .reason-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
        .reason-field textarea{width:100%;padding:10px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;resize:none;height:72px;font-family:inherit;}
        .reason-field textarea:focus{outline:none;border-color:#1a4d8c;}
        .reason-field textarea.required-shake{animation:shake .3s;border-color:#dc3545;}
        .modal-edit-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        /* date manager */
        .date-manager{background:#fff8e1;border:1px solid #ffe082;border-radius:10px;padding:16px;margin-bottom:18px;}
        .date-manager h4{font-size:13px;font-weight:700;color:#555;margin-bottom:12px;text-transform:uppercase;letter-spacing:.4px;}
        .date-manager-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .date-manager-row select{flex:1;min-width:200px;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;cursor:pointer;}
        .date-manager-row select:focus{outline:none;border-color:#1a4d8c;}
        .date-manager-meta{font-size:12px;color:#888;margin-top:8px;}
        .no-dates{color:#aaa;font-size:13px;padding:4px 0;}

        /* clear-all confirm modal */
        .modal-clear{background:white;border-radius:14px;width:90%;max-width:440px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-clear-header{background:linear-gradient(135deg,#dc3545,#b02a37);color:white;padding:18px 24px;}
        .modal-clear-header h3{font-size:16px;font-weight:700;}
        .modal-clear-body{padding:24px;}
        .modal-clear-body p{font-size:14px;color:#555;margin-bottom:16px;line-height:1.6;}
        .modal-clear-body input{width:100%;padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:15px;font-weight:700;letter-spacing:2px;text-align:center;}
        .modal-clear-body input:focus{outline:none;border-color:#dc3545;}
        .modal-clear-body input.match{border-color:#27ae60;background:#f0fff4;}
        .modal-clear-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        /* attendance panel */
        .attend-toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:16px;}
        .attend-toolbar select{padding:8px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;background:white;min-width:200px;}
        .attend-toolbar select:focus{outline:none;border-color:#1a4d8c;}
        .attend-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px;}
        .attend-stat{background:#f8f9fa;border:1px solid #eee;border-radius:8px;padding:12px;text-align:center;}
        .attend-stat .av{font-size:22px;font-weight:bold;}
        .attend-stat .al{font-size:11px;text-transform:uppercase;color:#999;margin-top:4px;}
        .attend-table-wrap{overflow:auto;border-radius:8px;border:1px solid #e0e0e0;}
        .attend-table{width:100%;border-collapse:collapse;}
        .attend-table th{background:#f0f2f5;font-size:12px;padding:10px 14px;text-align:left;font-weight:600;color:#555;border-bottom:1px solid #dee2e6;white-space:nowrap;}
        .attend-table td{padding:9px 14px;border-bottom:1px solid #f0f2f5;font-size:13px;vertical-align:middle;}
        .attend-table tr:last-child td{border-bottom:none;}
        .attend-table tr:hover td{background:#fafafa;}
        .attend-present td:first-child{border-left:4px solid #27ae60;}
        .attend-incomplete td:first-child{border-left:4px solid #e67e22;}
        .attend-absent td:first-child{border-left:4px solid #dc3545;}
        .attend-leave td:first-child{border-left:4px solid #6c757d;}
        .attend-badge{padding:3px 8px;border-radius:12px;font-size:11px;font-weight:700;}
        .ab-present{background:#d4edda;color:#155724;}
        .ab-incomplete{background:#fff3cd;color:#856404;}
        .ab-absent{background:#f8d7da;color:#721c24;}
        .ab-leave{background:#e2e3e5;color:#383d41;}
        .ab-manual{background:#e8d5ff;color:#5a32a3;font-size:10px;margin-left:4px;}
        .no-attend{padding:30px;text-align:center;color:#aaa;font-size:14px;}

        /* attendance manual entry modal */
        .modal-attend{background:white;border-radius:14px;width:90%;max-width:480px;box-shadow:0 8px 40px rgba(0,0,0,.25);overflow:hidden;}
        .modal-attend-header{background:linear-gradient(135deg,#27ae60,#1e8449);color:white;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;}
        .modal-attend-header h3{font-size:16px;font-weight:700;}
        .modal-attend-close{background:none;border:none;color:white;font-size:22px;cursor:pointer;line-height:1;opacity:.8;}
        .modal-attend-close:hover{opacity:1;}
        .modal-attend-body{padding:24px;}
        .attend-field{margin-bottom:14px;}
        .attend-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:5px;}
        .attend-field input,.attend-field select{width:100%;padding:9px 12px;border:2px solid #e0e0e0;border-radius:8px;font-size:13px;}
        .attend-field input:focus,.attend-field select:focus{outline:none;border-color:#27ae60;}
        .attend-field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
        .modal-attend-footer{padding:16px 24px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;}

        .debug-info{background:#f8f9fa;padding:10px;margin:10px 0;border-radius:5px;font-size:12px;color:#666;max-height:200px;overflow:auto;display:none;border:1px solid #dee2e6;font-family:monospace;}
        .footer{text-align:center;margin-top:20px;color:#666;font-size:13px;}
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#2c3e50;color:white;padding:12px 24px;border-radius:30px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .3s;z-index:9999;}
        .toast.show{opacity:1;}
        .team-select{padding:10px 14px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;background:white;cursor:pointer;}
        .team-select:focus{outline:none;border-color:#1a4d8c;}
        /* ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê */
        .login-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#1a4d8c 0%,#2c3e50 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
        .login-overlay.hidden{display:none;}
        .login-box{background:white;border-radius:20px;padding:40px 36px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,.4);text-align:center;}
        .login-logo{font-size:48px;margin-bottom:12px;}
        .login-box h2{font-size:22px;font-weight:700;color:#2c3e50;margin-bottom:4px;}
        .login-box p{font-size:13px;color:#888;margin-bottom:28px;}
        .login-field{text-align:left;margin-bottom:16px;}
        .login-field label{display:block;font-size:13px;font-weight:600;color:#555;margin-bottom:6px;}
        .login-field input{width:100%;padding:11px 14px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;transition:border-color .2s;}
        .login-field input:focus{outline:none;border-color:#1a4d8c;}
        .login-field input.error{border-color:#dc3545;animation:shake .3s;}
        .login-btn{width:100%;padding:13px;background:linear-gradient(135deg,#1a4d8c,#2c3e50);color:white;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;transition:opacity .2s;}
        .login-btn:hover{opacity:.9;}
        .login-error{color:#dc3545;font-size:13px;margin-top:12px;min-height:18px;font-weight:600;}
        .login-user-badge{display:inline-flex;align-items:center;gap:6px;background:#e8f0fe;color:#1a4d8c;border-radius:20px;padding:4px 12px;font-size:12px;font-weight:700;cursor:pointer;border:none;}
        .login-user-badge:hover{background:#d2e3fc;}
        .top-user-bar{display:flex;align-items:center;justify-content:flex-end;gap:10px;margin-bottom:12px;}
    </style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN SCREEN ‚ïê‚ïê -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div class="login-logo">üìã</div>
        <h2>Slack Tracker</h2>
        <p>Please log in to continue</p>

        <div class="login-field">
            <label for="loginUser">Username</label>
            <input type="text" id="loginUser" placeholder="Enter your username" autocomplete="username"/>
        </div>
        <div class="login-field">
            <label for="loginPass">Password</label>
            <input type="password" id="loginPass" placeholder="Enter your password" autocomplete="current-password"/>
        </div>
        <button class="login-btn" id="loginBtn">üîê Login</button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>

<div class="container" id="mainApp" style="display:none;">

    <div class="header">
        <div class="top-user-bar">
            <span style="color:rgba(255,255,255,.7);font-size:13px;">Logged in as:</span>
            <span class="login-user-badge" id="loggedUserBadge">üë§ ‚Äî</span>
            <button class="btn btn-sm" id="logoutBtn" style="background:rgba(255,255,255,.15);color:white;font-size:12px;padding:5px 14px;">üö™ Logout</button>
        </div>
        <h1>üìã Slack Login/Logout Tracker <span class="status-badge status-complete">v7.1</span></h1>
        <p>Shared history between both users ‚Äî powered by Supabase cloud database</p>
    </div>

    <!-- Sync status bar -->
    <div class="sync-bar loading" id="syncBar">
        <div class="sync-dot loading" id="syncDot"></div>
        <span id="syncMsg">Connecting to shared database‚Ä¶</span>
    </div>

    <!-- Employee Management -->
    <div class="panel">
        <div class="panel-header" id="empPanelToggle">
            <h2>üë• Manage Employees <span class="badge badge-blue" id="empCount">0</span></h2>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="panel-body" id="empPanelBody">
            <div class="team-tabs">
                <div class="team-tab active-annotation" id="tabAnnotation">üîµ Data Annotation (<span id="countAnnotation">0</span>)</div>
                <div class="team-tab" id="tabAssessment">üü† Data Assessment / DA (<span id="countAssessment">0</span>)</div>
            </div>
            <div class="add-emp-row">
                <input type="text" id="newEmpInput" placeholder="Employee name‚Ä¶" maxlength="80"/>
                <select class="team-select" id="newEmpTeam">
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <button class="btn btn-primary" id="addEmpBtn">‚ûï Add</button>
            </div>
            <div class="emp-grid" id="empGrid"></div>
            <div class="panel-footer">
                <span>üíæ Saved in this browser. History is shared via cloud.</span>
                <button class="btn btn-danger btn-sm" id="resetEmpBtn">‚Ü© Reset to Defaults</button>
            </div>
        </div>
    </div>

    <!-- Slack Input -->
    <div class="input-section">
        <div class="date-row">
            <label for="reportDate">üìÖ Date of this log:</label>
            <input type="date" id="reportDate"/>
            <span class="date-hint">Tags violations in shared history. Defaults to today.</span>
        </div>
        <textarea id="slackInput" placeholder="Paste Slack messages here ‚Äî both teams together is fine‚Ä¶"></textarea>
        <div class="button-group">
            <button class="btn btn-primary"   id="processBtn">üîç Process &amp; Save to History</button>
            <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear</button>
            <button class="btn btn-success"   id="sample1Btn">üìã Format 1</button>
            <button class="btn btn-info"      id="sample2Btn">üìã Format 2</button>
            <button class="btn btn-secondary" id="exportBtn">üì• Export CSV</button>
            <button class="btn btn-secondary" id="debugBtn">üêõ Debug</button>
        </div>
        <div class="debug-info" id="debugInfo"></div>
    </div>

    <!-- Today's Results -->
    <div class="view-tabs" id="viewTabs" style="display:none;">
        <button class="view-tab active-all" data-view="all">üìä All <span class="tab-count" id="tcAll">0</span></button>
        <button class="view-tab" data-view="annotation">üîµ Annotation <span class="tab-count" id="tcAnnotation">0</span></button>
        <button class="view-tab" data-view="assessment">üü† Assessment <span class="tab-count" id="tcAssessment">0</span></button>
    </div>
    <div id="resultsArea" style="display:none;">
        <div class="stats-wrapper">
            <div class="stats-label" id="statsLabel">Overall</div>
            <div class="stats-container" id="statsContainer"></div>
        </div>
        <div class="table-container"><div id="tableContainer"></div></div>
    </div>

    <!-- Violation History -->
    <div class="panel" style="margin-top:24px;">
        <div class="panel-header" id="histPanelToggle">
            <h2>üö® Violation History <span class="badge badge-red" id="histTotalBadge">0 violations</span>
                <button class="btn btn-info btn-sm" id="refreshHistBtn" style="margin-left:8px;font-size:11px;padding:3px 10px;">üîÑ Refresh</button>
            </h2>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="panel-body" id="histPanelBody">
            <div class="history-summary" id="histSummary"></div>
            <div class="history-toolbar">
                <label>Team:</label>
                <select id="histTeamFilter">
                    <option value="all">All Teams</option>
                    <option value="annotation">Data Annotation</option>
                    <option value="assessment">Data Assessment / DA</option>
                </select>
                <label>Show:</label>
                <select id="histTypeFilter">
                    <option value="all">All Records</option>
                    <option value="active" selected>Active Violations Only</option>
                    <option value="resolved">Resolved Only</option>
                    <option value="Missing">Missing</option>
                    <option value="Incomplete">Incomplete</option>
                    <option value="On Leave">Marked On Leave</option>
                    <option value="Ignored">Ignored</option>
                </select>
                <label>From:</label><input type="date" id="histFromDate"/>
                <label>To:</label><input type="date" id="histToDate"/>
                <button class="btn btn-secondary btn-sm" id="histFilterBtn">üîç Apply</button>
                <button class="btn btn-secondary btn-sm" id="histResetFilterBtn">‚úñ Clear</button>
                <button class="btn btn-success btn-sm"   id="histExportBtn">üì• Export CSV</button>
                <button class="btn btn-danger btn-sm"    id="histClearBtn">üóëÔ∏è Clear All</button>
            </div>
            <!-- Date Manager -->
            <div class="date-manager">
                <h4>üìÖ Manage Data by Date ‚Äî Select a date to delete and re-enter fresh data</h4>
                <div class="date-manager-row">
                    <select id="dateSelect" onchange="onDateSelectChange()">
                        <option value="">‚Äî Select a date ‚Äî</option>
                    </select>
                    <button class="btn btn-secondary btn-sm" id="dateReenterBtn" onclick="preloadSelectedDate()" disabled>‚úèÔ∏è Re-enter Data</button>
                    <button class="btn btn-danger btn-sm"   id="dateDeleteBtn"  onclick="deleteSelectedDate()"  disabled>üóëÔ∏è Delete Date</button>
                </div>
                <div class="date-manager-meta" id="dateMeta"></div>
            </div>

            <div id="histContent"></div>
        </div>
    </div>

    <!-- Attendance Tracker Panel -->
    <div class="panel" style="margin-top:24px;">
        <div class="panel-header" id="attendPanelToggle">
            <h2>üìä Daily Attendance Tracker
                <span class="badge badge-blue" id="attendBadge">Select a date</span>
            </h2>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="panel-body" id="attendPanelBody">
            <div class="attend-toolbar">
                <label style="font-size:13px;font-weight:600;color:#555;">Select Date:</label>
                <select id="attendDateSelect" onchange="loadAttendance()">
                    <option value="">‚Äî Pick a date ‚Äî</option>
                </select>
                <button class="btn btn-success btn-sm" id="attendAddBtn" onclick="openAttendanceModal()" disabled>‚ûï Add / Edit Entry</button>
                <button class="btn btn-secondary btn-sm" id="attendExportBtn" onclick="exportAttendanceCSV()" disabled>üì• Export CSV</button>
            </div>
            <div class="attend-summary" id="attendSummary"></div>
            <div class="attend-table-wrap">
                <div id="attendContent"><div class="no-attend">Select a date above to view attendance.</div></div>
            </div>
        </div>
    </div>

    <div class="footer"><span id="lastUpdated"></span></div>
</div><!-- end mainApp -->

<div class="toast" id="toast"></div>

<!-- Clear All Modal (requires typing CLEAR) -->
<div class="modal-overlay" id="clearOverlay">
    <div class="modal-clear">
        <div class="modal-clear-header">
            <h3>üóëÔ∏è Clear All History</h3>
        </div>
        <div class="modal-clear-body">
            <p>This will <strong>permanently delete ALL violation history</strong> for both users and cannot be undone.<br><br>
            To confirm, type <strong>CLEAR</strong> in the box below:</p>
            <input type="text" id="clearConfirmInput" placeholder="Type CLEAR here‚Ä¶" autocomplete="off"/>
        </div>
        <div class="modal-clear-footer">
            <button class="btn btn-secondary" id="clearOverlayCancel">Cancel</button>
            <button class="btn btn-danger"    id="clearOverlayConfirm" disabled>üóëÔ∏è Delete Everything</button>
        </div>
    </div>
</div>

<!-- Attendance Manual Entry Modal -->
<div class="modal-overlay" id="attendOverlay">
    <div class="modal-attend">
        <div class="modal-attend-header">
            <h3>‚ûï Add / Edit Attendance Entry</h3>
            <button class="modal-attend-close" id="attendCloseBtn">√ó</button>
        </div>
        <div class="modal-attend-body">
            <div class="attend-field">
                <label>Employee</label>
                <select id="attendEmpSelect">
                    <option value="">‚Äî Select employee ‚Äî</option>
                </select>
            </div>
            <div class="attend-field">
                <label>Status</label>
                <select id="attendStatus" onchange="onAttendStatusChange()">
                    <option value="Present">‚úÖ Present (has login + logout)</option>
                    <option value="Incomplete">‚ö†Ô∏è Incomplete (missing login or logout)</option>
                    <option value="Absent">‚ùå Absent</option>
                    <option value="On Leave">üìÖ On Leave</option>
                </select>
            </div>
            <div id="attendTimeFields">
                <div class="attend-field-row">
                    <div class="attend-field">
                        <label>Login Time</label>
                        <input type="text" id="attendLogin" placeholder="e.g. 9:00 AM"/>
                    </div>
                    <div class="attend-field">
                        <label>Logout Time</label>
                        <input type="text" id="attendLogout" placeholder="e.g. 6:00 PM"/>
                    </div>
                </div>
            </div>
            <div class="attend-field">
                <label>Notes (optional)</label>
                <input type="text" id="attendNotes" placeholder="Any notes or remarks‚Ä¶"/>
            </div>
        </div>
        <div class="modal-attend-footer">
            <button class="btn btn-secondary" id="attendCancelBtn" onclick="closeAttendanceModal()">Cancel</button>
            <button class="btn btn-success"   id="attendSaveBtn">üíæ Save Entry</button>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmOverlay">
    <div class="modal-confirm">
        <h3 id="confirmTitle">Confirm</h3>
        <p id="confirmMsg"></p>
        <div class="modal-btns">
            <button class="btn btn-secondary" id="confirmCancel">Cancel</button>
            <button class="btn btn-danger"    id="confirmOk">Confirm</button>
        </div>
    </div>
</div>

<!-- Edit Violation Modal -->
<div class="modal-overlay" id="editOverlay">
    <div class="modal-edit">
        <div class="modal-edit-header">
            <h3>‚úèÔ∏è Edit Violation</h3>
            <button class="modal-edit-close" id="editClose">√ó</button>
        </div>
        <div class="modal-edit-body">
            <div class="viol-info-box" id="editInfoBox"></div>
            <p style="font-size:13px;font-weight:600;color:#555;margin-bottom:10px;">Change resolution to:</p>
            <div class="resolution-options">
                <div class="res-option" data-res="violation" id="resOptViolation">
                    <div class="res-icon">üö®</div>
                    <div class="res-label">Keep as Violation</div>
                    <div class="res-desc">Counts against the employee</div>
                </div>
                <div class="res-option" data-res="On Leave" id="resOptLeave">
                    <div class="res-icon">üìÖ</div>
                    <div class="res-label">Mark On Leave</div>
                    <div class="res-desc">Absent for legitimate reason</div>
                </div>
                <div class="res-option" data-res="Ignored" id="resOptIgnored">
                    <div class="res-icon">üîï</div>
                    <div class="res-label">Ignore / Excuse</div>
                    <div class="res-desc">System error or known reason</div>
                </div>
            </div>
            <div class="reason-field">
                <label for="editReason">Reason / Notes <span id="editReasonRequired" style="color:#dc3545;display:none;">*required</span></label>
                <textarea id="editReason" placeholder="Required for On Leave and Ignore ‚Äî add a note explaining why‚Ä¶"></textarea>
            </div>
        </div>
        <div class="modal-edit-footer">
            <button class="btn btn-secondary" id="editCancel">Cancel</button>
            <button class="btn btn-primary"   id="editSave">üíæ Save to Cloud</button>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üë§  USER ACCOUNTS  ‚Äî change usernames and passwords here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const USERS = [
    { username: 'admin',   password: 'Admin@123',  displayName: 'Admin' },
    { username: 'user2',   password: 'User2@456',  displayName: 'User 2' }
];
// To add more users, copy a line above and change the details.
// Example: { username: 'john', password: 'John@789', displayName: 'John' }

const LS_SESSION = 'slackTracker_session';

function checkSession(){
    try{
        const s = localStorage.getItem(LS_SESSION);
        if(s){
            const parsed = JSON.parse(s);
            if(parsed && parsed.username && parsed.expires > Date.now()) return parsed;
        }
    } catch(e){}
    return null;
}

function doLogin(){
    const username = document.getElementById('loginUser').value.trim();
    const password = document.getElementById('loginPass').value;
    const errEl    = document.getElementById('loginError');
    errEl.textContent = '';

    if(!username || !password){
        errEl.textContent = 'Please enter both username and password.';
        return;
    }

    const user = USERS.find(u =>
        u.username.toLowerCase() === username.toLowerCase() && u.password === password
    );

    if(!user){
        errEl.textContent = '‚ùå Incorrect username or password.';
        document.getElementById('loginUser').classList.add('error');
        document.getElementById('loginPass').classList.add('error');
        setTimeout(()=>{
            document.getElementById('loginUser').classList.remove('error');
            document.getElementById('loginPass').classList.remove('error');
        }, 800);
        document.getElementById('loginPass').value = '';
        document.getElementById('loginPass').focus();
        return;
    }

    // Save session ‚Äî expires in 8 hours
    const session = { username: user.username, displayName: user.displayName, expires: Date.now() + 8*60*60*1000 };
    localStorage.setItem(LS_SESSION, JSON.stringify(session));
    showMainApp(session);
}

function doLogout(){
    localStorage.removeItem(LS_SESSION);
    document.getElementById('mainApp').style.display    = 'none';
    document.getElementById('loginOverlay').classList.remove('hidden');
    document.getElementById('loginUser').value = '';
    document.getElementById('loginPass').value = '';
    document.getElementById('loginError').textContent = '';
}

function showMainApp(session){
    document.getElementById('loginOverlay').classList.add('hidden');
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('loggedUserBadge').textContent = 'üë§ ' + session.displayName;
    // Only init app if not already initialised (prevents double-init on page load)
    if(!window._appInitialised) initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚öôÔ∏è  SUPABASE CONFIG  ‚Äî paste your keys here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = 'https://tfapnbvrquswjzogdhbh.supabase.co';
const SUPABASE_KEY = 'sb_publishable_VcT6pNqY6tO0jwBgBkOqQQ_ie4JPHdD';  // ‚Üê replace this with the long eyJ... key
const TABLE = 'violation_history';
const ATTEND_TABLE = 'attendance_records';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE API WRAPPER  (no extra libraries needed)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sbFetch(path, opts={}){
    const url = SUPABASE_URL + '/rest/v1/' + path;
    // Build headers ‚Äî Prefer must be set explicitly per call
    const headers = {
        'apikey': SUPABASE_KEY,
        'Authorization': 'Bearer ' + SUPABASE_KEY,
        'Content-Type': 'application/json',
    };
    if(opts.prefer) headers['Prefer'] = opts.prefer;
    if(opts.headers) Object.assign(headers, opts.headers);

    const res = await fetch(url, {
        method: opts.method || 'GET',
        headers,
        body: opts.body || undefined
    });
    if(!res.ok){
        const err = await res.text();
        throw new Error(`Supabase error ${res.status}: ${err}`);
    }
    const text = await res.text();
    return text ? JSON.parse(text) : [];
}

// Load all rows sorted by date
async function dbLoad(){
    return sbFetch(TABLE + '?order=date.asc&select=*');
}

// Insert a brand-new row (no id ‚Äî let Supabase generate uuid)
async function dbInsert(row){
    const {id, ...payload} = row; // strip id if present
    const url = SUPABASE_URL + '/rest/v1/' + TABLE;
    const res = await fetch(url, {
        method: 'POST',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(payload)
    });
    console.log('[dbInsert] response status='+res.status);
    if(!res.ok){
        const err = await res.text();
        throw new Error('INSERT failed '+res.status+': '+err);
    }
    return true;
}

// Update an existing row by its uuid ‚Äî used for resolution changes
async function dbPatch(rowId, fields){
    console.log('[dbPatch] PATCH id='+rowId, fields);
    const url = SUPABASE_URL + '/rest/v1/' + TABLE + '?id=eq.' + rowId;
    const res = await fetch(url, {
        method: 'PATCH',
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + SUPABASE_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
        },
        body: JSON.stringify(fields)
    });
    console.log('[dbPatch] response status='+res.status);
    if(!res.ok){
        const err = await res.text();
        throw new Error('PATCH failed '+res.status+': '+err);
    }
    return true;
}

// Check if row exists for date+name, then insert or patch
async function dbUpsertByDateName(row){
    const existing = dbRows.find(d => d.date === row.date && d.name === row.name);
    if(existing){
        // Update existing row ‚Äî only overwrite non-resolution fields; keep resolution/reason
        return dbPatch(existing.id, {
            team: row.team,
            status: row.status,
            login: row.login,
            logout: row.logout,
            working_hours: row.working_hours,
            // preserve existing resolution/reason
            resolution: existing.resolution,
            reason: existing.reason,
            resolved_at: existing.resolved_at
        });
    } else {
        const {id, ...payload} = row;
        return dbInsert(payload);
    }
}

async function dbDeleteAll(){
    return sbFetch(TABLE + '?date=gte.0000-00-00', {
        method: 'DELETE'
    });
}

async function dbDeleteByDate(dateStr){
    return sbFetch(TABLE + '?date=eq.' + encodeURIComponent(dateStr), {
        method: 'DELETE'
    });
}

// ‚îÄ‚îÄ Attendance DB helpers ‚îÄ‚îÄ
async function dbLoadAttendance(dateStr){
    return sbFetch(ATTEND_TABLE + '?date=eq.' + encodeURIComponent(dateStr) + '&order=name.asc&select=*');
}
async function dbSaveAttendance(row){
    // PATCH if id exists, else INSERT
    if(row.id){
        return sbFetch(ATTEND_TABLE + '?id=eq.' + row.id, {
            method:'PATCH', prefer:'return=minimal', body: JSON.stringify(row)
        });
    } else {
        const {id, ...payload} = row;
        return sbFetch(ATTEND_TABLE, {
            method:'POST', prefer:'return=minimal', body: JSON.stringify(payload)
        });
    }
}
async function dbDeleteAttendance(id){
    return sbFetch(ATTEND_TABLE + '?id=eq.' + id, { method:'DELETE' });
}
async function dbLoadAttendanceDates(){
    // Get distinct dates from attendance table
    return sbFetch(ATTEND_TABLE + '?select=date&order=date.desc');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEFAULTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULT_TEAMS={
    annotation:[
        "Ramyashree Ragupathy","Manoj kumar","Kalyani Dande","Sandhya D","Koteswari","Hari","Uma",
        "Manjunath Bandihal","Akshay Phatale","Maitra Salimath","YATHISH GOWDA KH","Pavan Yeddala",
        "sabarmathi","G umesh","Shilpa E","Prema Joshi","Keerti Doddwad","Ajayreddy","Varun Kumar H N",
        "Sneha B V","Fathima Reneesha P","Vishruthi Raghu","Sanjana G P","Dhanyasri as","Siddharth Anandan",
        "Bindu Sree","Anilkumar","Mihir","Suzan John","Umesh Barker","HR SUNIL KUMAR","Shanta mantri",
        "Nandini Keni","Shweta k","Kishore Devaragudi","ANIL GANDREDDI","K Ganesh","kirany","Vishwas Reddy"
    ],
    assessment:[
        "Sandhya K","Venkatesh Chilukuri","Gowthami TP","Jagadish","kaushik","Ishika","Ramyashree A",
        "Jobin Johnson","Divya K","Sujan Debnath","Sajina NM","Shivaranjani Hiremath","M.Sarvani",
        "vengatesan","V Srividhya","sunkavalli Gayatri","Aashvi"
    ]
};

const LS_TEAMS = 'slackTracker_teams_v1';
let teams = {annotation:[],assessment:[]};
let dbRows = [];   // flat array from Supabase
let lastReport = [];
let activeEmpTab = 'annotation';
let activeViewTab = 'all';
let editContext = null;
let selectedResolution = 'violation';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC STATUS UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(state, msg){
    const bar=document.getElementById('syncBar');
    const dot=document.getElementById('syncDot');
    const txt=document.getElementById('syncMsg');
    bar.className='sync-bar '+(state==='ok'?'':state);
    dot.className='sync-dot '+(state==='ok'?'':state);
    txt.textContent=msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOAD FROM SUPABASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromCloud(){
    setSyncStatus('loading','Loading shared history from cloud‚Ä¶');
    try{
        dbRows = await dbLoad();
        const active = dbRows.filter(r=>r.resolution==='violation').length;
        setSyncStatus('ok', '‚úÖ Connected ‚Äî ' + active + ' active violation' + (active!==1?'s':'') + ' | ' + dbRows.length + ' total records. Shared between both users.');
        renderHistory(getHistFilters());
        refreshAttendDateSelect();
    } catch(e){
        setSyncStatus('error','‚ùå Could not connect to database. Check your API key. ‚Äî '+e.message);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAVE VIOLATIONS TO CLOUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveViolationsForDate(dateStr, report){
    const viols = report.filter(r=>r.status==='Missing'||r.status==='Incomplete');
    setSyncStatus('loading','Saving to cloud‚Ä¶');
    try{
        for(const r of viols){
            const row = {
                date: dateStr,
                name: r.name,
                team: r.team,
                status: r.status,
                login: r.login,
                logout: r.logout,
                working_hours: r.workingHours,
                resolution: 'violation',
                reason: '',
                resolved_at: ''
            };
            await dbUpsertByDateName(row);
        }
        await loadFromCloud();
    } catch(e){
        setSyncStatus('error','‚ùå Save failed: '+e.message);
        console.error('saveViolationsForDate error:', e);
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE RESOLUTION IN CLOUD  ‚Äî uses PATCH by row id (reliable update)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function saveResolutionToCloud(date, name, resolution, reason){
    setSyncStatus('loading','Saving resolution to cloud‚Ä¶');
    try{
        // Find the row in our local cache
        const idx = dbRows.findIndex(d => d.date === date && d.name === name);
        if(idx === -1 || !dbRows[idx].id){
            setSyncStatus('error','‚ùå Record not found. Click üîÑ Refresh and try again.');
            return;
        }
        const rowId = dbRows[idx].id;
        const resolvedAt = resolution !== 'violation' ? new Date().toLocaleString() : '';

        // STEP 1: Send PATCH to Supabase
        await dbPatch(rowId, {
            resolution:  resolution,
            reason:      reason,
            resolved_at: resolvedAt
        });

        // STEP 2: Update local cache immediately ‚Äî no waiting for server reload
        dbRows[idx].resolution  = resolution;
        dbRows[idx].reason      = reason;
        dbRows[idx].resolved_at = resolvedAt;

        // STEP 3: Switch filter to Active Violations Only so resolved records hide
        if(resolution !== 'violation'){
            document.getElementById('histTypeFilter').value = 'active';
        }

        // STEP 4: Re-render right away using updated local data
        renderHistory(getHistFilters());
        updateHistBadge();

        const label = resolution === 'violation' ? 'Reverted to Violation' :
                      resolution === 'On Leave'  ? 'Marked as On Leave'    : 'Marked as Ignored';
        setSyncStatus('ok', '‚úÖ ' + label + ' for ' + name + ' ‚Äî saved & synced.');

        // STEP 5: Background reload from cloud to confirm (does not block UI)
        setTimeout(() => loadFromCloud().catch(e => console.warn('BG reload:', e)), 1500);

    } catch(e){
        setSyncStatus('error', '‚ùå Could not save: ' + e.message);
        console.error('[saveResolution] ERROR:', e);
    }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANALYTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isActive(v){ return v.resolution==='violation'; }

function longestStreak(violations){
    const active=violations.filter(isActive);
    if(!active.length) return 0;
    const dates=[...new Set(active.map(v=>v.date))].sort();
    if(dates.length===1) return 1;
    let max=1,cur=1;
    for(let i=1;i<dates.length;i++){
        const d=(new Date(dates[i])-new Date(dates[i-1]))/86400000;
        if(d===1){cur++;max=Math.max(max,cur);}else cur=1;
    }
    return max;
}

function updateHistBadge(){
    const active=dbRows.filter(isActive).length;
    document.getElementById('histTotalBadge').textContent=active+' active violation'+(active!==1?'s':'');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATE MANAGER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDateManager(){
    const sel = document.getElementById('dateSelect');
    if(!sel) return;

    // Remember current selection
    const prev = sel.value;

    // Get unique dates sorted newest first
    const dates = [...new Set(dbRows.map(r=>r.date))].sort().reverse();

    sel.innerHTML = '<option value="">‚Äî Select a date ‚Äî</option>';
    dates.forEach(date=>{
        const rows   = dbRows.filter(r=>r.date===date);
        const active = rows.filter(isActive).length;
        const total  = rows.length;
        const opt    = document.createElement('option');
        opt.value    = date;
        opt.textContent = formatDate(date) + '  (' + active + ' active / ' + total + ' total)';
        sel.appendChild(opt);
    });

    // Restore previous selection if still valid
    if(prev && dates.includes(prev)) sel.value = prev;
    onDateSelectChange();
}

function onDateSelectChange(){
    const sel      = document.getElementById('dateSelect');
    const dateStr  = sel.value;
    const meta     = document.getElementById('dateMeta');
    const reBtn    = document.getElementById('dateReenterBtn');
    const delBtn   = document.getElementById('dateDeleteBtn');

    if(!dateStr){
        meta.textContent = '';
        reBtn.disabled = true;
        delBtn.disabled = true;
        return;
    }

    const rows     = dbRows.filter(r=>r.date===dateStr);
    const active   = rows.filter(isActive).length;
    const resolved = rows.length - active;
    const parts    = [];
    if(active)   parts.push(active+' active violation'+(active!==1?'s':''));
    if(resolved) parts.push(resolved+' resolved');
    meta.textContent = parts.length ? parts.join(' ¬∑ ') : 'No violations on this date';
    reBtn.disabled = false;
    delBtn.disabled = false;
}

function preloadSelectedDate(){
    const dateStr = document.getElementById('dateSelect').value;
    if(!dateStr) return;
    document.getElementById('reportDate').value = dateStr;
    document.getElementById('slackInput').value = '';
    window.scrollTo({top:0, behavior:'smooth'});
    showToast('üìÖ Date set to '+formatDate(dateStr)+' ‚Äî paste fresh Slack data and click Process.');
}

function deleteSelectedDate(){
    const dateStr = document.getElementById('dateSelect').value;
    if(!dateStr) return;
    const count = dbRows.filter(r=>r.date===dateStr).length;
    openConfirm(
        'Delete Date',
        'This will permanently delete <strong>all '+count+' records</strong> for <strong>'+formatDate(dateStr)+'</strong>.<br><br>You can then paste fresh data for this date.',
        async ()=>{
            setSyncStatus('loading','Deleting records for '+formatDate(dateStr)+'‚Ä¶');
            try{
                await dbDeleteByDate(dateStr);
                // Also delete attendance records for this date
                const attendForDate = await dbLoadAttendance(dateStr);
                for(const r of attendForDate){ try{ await dbDeleteAttendance(r.id); } catch(e){} }
                await loadFromCloud();
                await refreshAttendDateSelect();
                document.getElementById('reportDate').value = dateStr;
                showToast('üóëÔ∏è Deleted all records for '+formatDate(dateStr)+'. Paste fresh data and click Process.');
            } catch(e){
                setSyncStatus('error','‚ùå Delete failed: '+e.message);
            }
        }
    );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openEditModal(date, name){
    const v = dbRows.find(d=>d.date===date && d.name===name);
    if(!v) return;
    editContext = {date, name};
    selectedResolution = v.resolution||'violation';

    document.getElementById('editInfoBox').innerHTML=`
        <div class="vi-row"><span>Employee</span><strong>${esc(v.name)}</strong></div>
        <div class="vi-row"><span>Date</span><strong>${formatDate(date)}</strong></div>
        <div class="vi-row"><span>Team</span><strong>${teamLabel(v.team)}</strong></div>
        <div class="vi-row"><span>Original Status</span><strong>${v.status}</strong></div>
        <div class="vi-row"><span>Login</span><strong>${v.login}</strong></div>
        <div class="vi-row"><span>Logout</span><strong>${v.logout}</strong></div>`;

    document.getElementById('editReason').value = v.reason||'';
    updateResOptions(); updateReasonLabel();
    document.getElementById('editOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('editReason').focus(),100);
}

function updateResOptions(){
    document.getElementById('resOptViolation').className='res-option'+(selectedResolution==='violation'?' selected-violation':'');
    document.getElementById('resOptLeave').className='res-option'+(selectedResolution==='On Leave'?' selected-on-leave':'');
    document.getElementById('resOptIgnored').className='res-option'+(selectedResolution==='Ignored'?' selected-ignored':'');
}

function updateReasonLabel(){
    document.getElementById('editReasonRequired').style.display=selectedResolution!=='violation'?'inline':'none';
}

async function saveEdit(){
    const reason = document.getElementById('editReason').value.trim();
    const ta = document.getElementById('editReason');
    ta.classList.remove('required-shake');
    if(selectedResolution!=='violation' && !reason){
        void ta.offsetWidth; ta.classList.add('required-shake'); ta.focus(); return;
    }

    // ‚ö†Ô∏è Capture BEFORE closing modal ‚Äî closeEditModal sets editContext to null
    const savedDate = editContext.date;
    const savedName = editContext.name;
    const savedResolution = selectedResolution;

    closeEditModal();

    await saveResolutionToCloud(savedDate, savedName, savedResolution, reason);

    const label = savedResolution==='violation' ? 'reverted to Violation' :
                  savedResolution==='On Leave'  ? 'marked as On Leave'    : 'marked as Ignored';
    showToast('‚úÖ ' + savedName + ' ‚Äî ' + label + ' (synced to cloud)');
}

function closeEditModal(){ document.getElementById('editOverlay').classList.remove('open'); editContext=null; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory(filters={}){
    updateHistBadge();
    renderDateManager();
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];

    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from) violations=violations.filter(v=>v.date>=from);
    if(to)   violations=violations.filter(v=>v.date<=to);

    const active   =violations.filter(isActive).length;
    const resolved =violations.filter(v=>!isActive(v)).length;
    const onLeave  =violations.filter(v=>v.resolution==='On Leave').length;
    const ignored  =violations.filter(v=>v.resolution==='Ignored').length;
    const uniqueEmp=new Set(violations.map(v=>v.name)).size;
    const uniqueDays=new Set(violations.map(v=>v.date)).size;

    document.getElementById('histSummary').innerHTML=`
        <div class="hist-stat"><div class="hv">${violations.length}</div><div class="hl">Total Records</div></div>
        <div class="hist-stat"><div class="hv">${active}</div><div class="hl">Active Violations</div></div>
        <div class="hist-stat"><div class="hv" style="color:#27ae60">${resolved}</div><div class="hl">Resolved</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6c757d">${onLeave}</div><div class="hl">On Leave</div></div>
        <div class="hist-stat"><div class="hv" style="color:#6f42c1">${ignored}</div><div class="hl">Ignored</div></div>
        <div class="hist-stat"><div class="hv" style="color:#e67e22">${uniqueEmp}</div><div class="hl">Employees</div></div>
        <div class="hist-stat"><div class="hv" style="color:#1a4d8c">${uniqueDays}</div><div class="hl">Days</div></div>`;

    const content=document.getElementById('histContent');
    if(!violations.length){content.innerHTML='<div class="no-history">üéâ No records match the current filters.</div>';return;}

    const byEmp={};
    violations.forEach(v=>{
        if(!byEmp[v.name]) byEmp[v.name]={name:v.name,team:v.team,violations:[]};
        byEmp[v.name].violations.push(v);
    });

    const sorted=Object.values(byEmp).sort((a,b)=>
        b.violations.filter(isActive).length - a.violations.filter(isActive).length
    );

    content.innerHTML=sorted.map((emp,i)=>{
        const activeV=emp.violations.filter(isActive).length;
        const resolvedV=emp.violations.filter(v=>!isActive(v)).length;
        const streak=longestStreak(emp.violations);
        const streakBadge=streak>=3?`<span class="hist-streak">üî• ${streak}-day streak</span>`:'';
        const teamBadge=`<span class="team-badge ${emp.team}">${emp.team==='annotation'?'Annotation':'Assessment'}</span>`;
        const activeBadge=activeV?`<span class="hist-violations-count">${activeV} active</span>`:'';
        const resolvedBadge=resolvedV?`<span class="hist-resolved-count">${resolvedV} resolved</span>`:'';

        const rows=emp.violations.sort((a,b)=>b.date.localeCompare(a.date)).map(v=>{
            const res=v.resolution||'violation';
            const rowClass=res==='violation'
                ?`viol-row-${v.status.toLowerCase()}`
                :`viol-row-resolved-${res.toLowerCase().replace(' ','-')}`;

            let resBadge='';
            if(res==='On Leave') resBadge=`<span class="res-badge res-leave">üìÖ On Leave</span>`;
            else if(res==='Ignored') resBadge=`<span class="res-badge res-ignored">üîï Ignored</span>`;

            const reasonHtml=v.reason?`<div class="res-reason">üí¨ ${esc(v.reason)}</div>`:'';
            const resolvedAtHtml=v.resolved_at?`<div class="res-reason">üïê ${v.resolved_at}</div>`:'';

            const statusHtml=res==='violation'
                ?`<span class="status-badge status-${v.status.toLowerCase()}">${v.status==='Missing'?'‚ùì':'‚ö†Ô∏è'} ${v.status}</span>`
                :`${resBadge}<div style="font-size:11px;color:#888;margin-top:3px;">was: ${v.status}</div>`;

            return`<tr class="${rowClass}">
                <td>${formatDate(v.date)}</td>
                <td>${statusHtml}${reasonHtml}${resolvedAtHtml}</td>
                <td><span class="time-badge">${v.login}</span></td>
                <td><span class="time-badge">${v.logout}</span></td>
                <td>${v.working_hours}</td>
                <td><button class="btn btn-xs btn-secondary"
                    onclick="openEditModal('${v.date}','${v.name.replace(/'/g,"\\'")}')">‚úèÔ∏è Edit</button></td>
            </tr>`;
        }).join('');

        return`<div class="hist-emp-block">
            <div class="hist-emp-header" onclick="toggleHistBlock('hb${i}')">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <span class="hist-emp-name">${esc(emp.name)}</span>${teamBadge}
                </div>
                <div class="hist-emp-meta">${streakBadge}${activeBadge}${resolvedBadge}
                    <span style="color:#aaa;font-size:13px;">‚ñº</span>
                </div>
            </div>
            <div class="hist-emp-body" id="hb${i}">
                <table class="hist-table"><thead><tr>
                    <th>Date</th><th>Status / Resolution</th><th>Login</th><th>Logout</th><th>Hours</th><th>Action</th>
                </tr></thead><tbody>${rows}</tbody></table>
            </div>
        </div>`;
    }).join('');
}

function toggleHistBlock(id){const el=document.getElementById(id);if(el)el.classList.toggle('open');}

function formatDate(d){
    if(!d)return'-';
    return new Date(d+'T00:00:00').toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});
}

function getHistFilters(){
    return{team:document.getElementById('histTeamFilter').value,
           type:document.getElementById('histTypeFilter').value,
           from:document.getElementById('histFromDate').value,
           to:  document.getElementById('histToDate').value};
}

function exportHistoryCSV(filters={}){
    const {team='all',type='all',from='',to=''}=filters;
    let violations=[...dbRows];
    if(team!=='all')           violations=violations.filter(v=>v.team===team);
    if(type==='active')        violations=violations.filter(v=>v.resolution==='violation');
    else if(type==='resolved') violations=violations.filter(v=>v.resolution!=='violation');
    else if(type==='On Leave') violations=violations.filter(v=>v.resolution==='On Leave');
    else if(type==='Ignored')  violations=violations.filter(v=>v.resolution==='Ignored');
    else if(type==='Missing')  violations=violations.filter(v=>v.status==='Missing');
    else if(type==='Incomplete')violations=violations.filter(v=>v.status==='Incomplete');
    if(from)violations=violations.filter(v=>v.date>=from);
    if(to)  violations=violations.filter(v=>v.date<=to);
    if(!violations.length){showToast('No records to export.');return;}
    let csv='Date,Employee,Team,Original Status,Resolution,Login,Logout,Working Hours,Reason,Resolved At\n';
    violations.forEach(v=>{
        csv+=`"${v.date}","${v.name}","${teamLabel(v.team)}","${v.status}","${v.resolution}","${v.login}","${v.logout}","${v.working_hours}","${(v.reason||'').replace(/"/g,'""')}","${v.resolved_at||''}"\n`;
    });
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`violation-history-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMPLOYEE MANAGEMENT  (stays in localStorage ‚Äî same for all)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadTeams(){
    try{const r=localStorage.getItem(LS_TEAMS);if(r){const p=JSON.parse(r);if(p&&p.annotation&&p.assessment){teams=p;return;}}}catch(e){}
    teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
}
function saveTeams(){try{localStorage.setItem(LS_TEAMS,JSON.stringify(teams));}catch(e){}}

function renderEmpGrid(){
    const list=[...teams[activeEmpTab]].sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));
    document.getElementById('countAnnotation').textContent=teams.annotation.length;
    document.getElementById('countAssessment').textContent=teams.assessment.length;
    document.getElementById('empCount').textContent=teams.annotation.length+teams.assessment.length;
    const grid=document.getElementById('empGrid');
    if(!list.length){grid.innerHTML='<p style="color:#bbb;font-size:13px;grid-column:1/-1;padding:10px 0;">No employees yet.</p>';return;}
    grid.innerHTML=list.map(name=>`
        <div class="emp-chip ${activeEmpTab}">
            <span class="emp-name" title="${esc(name)}">${esc(name)}</span>
            <button class="remove-btn" data-name="${esc(name)}" title="Remove">‚úï</button>
        </div>`).join('');
    grid.querySelectorAll('.remove-btn').forEach(btn=>btn.addEventListener('click',()=>confirmRemove(btn.dataset.name,activeEmpTab)));
    document.getElementById('newEmpTeam').value=activeEmpTab;
}

function switchEmpTab(t){
    activeEmpTab=t;
    document.getElementById('tabAnnotation').className='team-tab'+(t==='annotation'?' active-annotation':'');
    document.getElementById('tabAssessment').className='team-tab'+(t==='assessment'?' active-assessment':'');
    renderEmpGrid();
}

function addEmployee(){
    const input=document.getElementById('newEmpInput');
    const team=document.getElementById('newEmpTeam').value;
    const name=input.value.trim();
    input.classList.remove('shake');
    if(!name){void input.offsetWidth;input.classList.add('shake');input.focus();return;}
    if(allEmployees().some(e=>e.toLowerCase()===name.toLowerCase())){showToast(`‚ö†Ô∏è "${name}" already exists`);input.select();return;}
    teams[team].push(name);saveTeams();switchEmpTab(team);input.value='';input.focus();
    showToast(`‚úÖ "${name}" added to ${teamLabel(team)}`);
}

function confirmRemove(name,team){
    openConfirm('Remove Employee',`Remove <strong>${esc(name)}</strong> from ${teamLabel(team)}?`,()=>{
        teams[team]=teams[team].filter(e=>e!==name);saveTeams();renderEmpGrid();showToast(`üóëÔ∏è "${name}" removed`);
    });
}

function resetToDefaults(){
    openConfirm('Reset to Defaults','Replace both team lists with the original default employees?',()=>{
        teams={annotation:[...DEFAULT_TEAMS.annotation],assessment:[...DEFAULT_TEAMS.assessment]};
        saveTeams();renderEmpGrid();showToast('‚Ü© Reset to defaults');
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _dbg=[];
function addDebug(m){_dbg.push(m);}
function clearDebug(){_dbg=[];}
function flushDebug(){document.getElementById('debugInfo').innerHTML=_dbg.join('<br>');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function norm(n){return n.trim().toLowerCase().replace(/\s+/g,' ');}
function allEmployees(){return[...teams.annotation,...teams.assessment];}
function teamLabel(t){return t==='annotation'?'Data Annotation':'Data Assessment / DA';}
function getTeam(name){
    const n=norm(name);
    if(teams.annotation.some(e=>norm(e)===n))return 'annotation';
    if(teams.assessment.some(e=>norm(e)===n))return 'assessment';
    return null;
}
function findEmployee(rawName){
    const n=norm(rawName);const all=allEmployees();
    return all.find(e=>norm(e)===n)||all.find(e=>n.includes(norm(e))||norm(e).includes(n))||rawName;
}
function timeToMinutes(str){
    if(!str)return null;
    str=str.trim().toUpperCase().replace(/\./g,':').replace(/\s+/g,' ').replace(/(\d)([AP]M)/,'$1 $2');
    const pm=str.includes('PM'),am=str.includes('AM');
    str=str.replace(/[AP]M/,'').trim();
    let[h,m]=str.split(':');h=parseInt(h,10);m=parseInt(m,10)||0;
    if(isNaN(h))return null;
    if(pm&&h!==12)h+=12;if(am&&h===12)h=0;
    return h*60+m;
}

let _tt=null;
function showToast(msg){const t=document.getElementById('toast');t.innerHTML=msg;t.classList.add('show');clearTimeout(_tt);_tt=setTimeout(()=>t.classList.remove('show'),2800);}

let _ccb=null;
function openConfirm(title,msg,cb){
    document.getElementById('confirmTitle').textContent=title;
    document.getElementById('confirmMsg').innerHTML=msg;
    document.getElementById('confirmOverlay').classList.add('open');_ccb=cb;
}
function closeConfirm(){document.getElementById('confirmOverlay').classList.remove('open');_ccb=null;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARSER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseMessages(rawText){
    clearDebug();addDebug('=== Parsing ===');
    const lines=rawText.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    const headerRe=/^(.+?)\s+\[(\d{1,2}:\d{2}\s*[AP]M)\]\s*$/i;
    const msgs=[];let cur=null;
    function flush(){
        if(!cur)return;
        const body=cur.lines.join('\n');
        if(/\bon\s+leave\b/i.test(body)){msgs.push({name:cur.name,type:'leave'});return;}
        if(/\b(in\s+working|working\s+on)\b/i.test(body)||/\blogin\b/i.test(body)){msgs.push({name:cur.name,type:'login',time:cur.time});return;}
        if(/\bworked\s+on\b/i.test(body)||/\blogout\b/i.test(body)){msgs.push({name:cur.name,type:'logout',time:cur.time});return;}
    }
    for(const rawLine of lines){
        const line=rawLine.trim();if(!line)continue;
        const hm=line.match(headerRe);
        if(hm){flush();cur={name:findEmployee(hm[1].trim()),time:hm[2].replace(/\s+/g,' '),lines:[]};}
        else if(cur){cur.lines.push(line);if(/\bon\s+leave\b/i.test(line)){flush();cur=null;}}
    }
    flush();addDebug(`Events: ${msgs.length}`);flushDebug();return msgs;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REPORT BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildReport(msgs){
    const state={};
    allEmployees().forEach(n=>{state[n]={logins:[],logouts:[],onLeave:false};});
    msgs.forEach(m=>{
        const s=state[m.name];if(!s)return;
        if(m.type==='leave')s.onLeave=true;
        if(m.type==='login')s.logins.push(m.time);
        if(m.type==='logout')s.logouts.push(m.time);
    });
    return Object.keys(state).sort().map(name=>{
        const s=state[name];const team=getTeam(name)||'annotation';
        if(s.onLeave)return{name,team,login:'-',logout:'-',workingHours:'-',status:'On Leave',statusClass:'status-leave',icon:'üìÖ'};
        const login=s.logins.sort((a,b)=>(timeToMinutes(a)||0)-(timeToMinutes(b)||0))[0]||null;
        const logout=s.logouts.sort((a,b)=>(timeToMinutes(b)||0)-(timeToMinutes(a)||0))[0]||null;
        let hours='-';
        if(login&&logout){const d=timeToMinutes(logout)-timeToMinutes(login);hours=((d<0?d+1440:d)/60).toFixed(2)+' hrs';}
        const status=login&&logout?'Complete':(login||logout)?'Incomplete':'Missing';
        const statusClass={Complete:'status-complete',Incomplete:'status-incomplete',Missing:'status-missing'}[status];
        const icon={Complete:'‚úÖ',Incomplete:'‚ö†Ô∏è',Missing:'‚ùì'}[status];
        return{name,team,login:login||'‚ùå No login',logout:logout||'‚ùå No logout',workingHours:hours,status,statusClass,icon};
    });
}

function calcStats(rows){
    const total=rows.length,comp=rows.filter(r=>r.status==='Complete').length,
          inc=rows.filter(r=>r.status==='Incomplete').length,
          leave=rows.filter(r=>r.status==='On Leave').length,
          miss=rows.filter(r=>r.status==='Missing').length,
          rate=total?((comp/total)*100).toFixed(1):'0';
    return{total,comp,inc,leave,miss,rate};
}
function renderStats(rows){
    const s=calcStats(rows);
    document.getElementById('statsContainer').innerHTML=`
        <div class="stat-card"><h3>Total</h3><div class="value">${s.total}</div></div>
        <div class="stat-card"><h3>‚úÖ Complete</h3><div class="value complete">${s.comp}</div></div>
        <div class="stat-card"><h3>‚ö†Ô∏è Incomplete</h3><div class="value incomplete">${s.inc}</div></div>
        <div class="stat-card"><h3>üìÖ On Leave</h3><div class="value leave">${s.leave}</div></div>
        <div class="stat-card"><h3>‚ùå Missing</h3><div class="value missing">${s.miss}</div></div>
        <div class="stat-card"><h3>Completion</h3><div class="value">${s.rate}%</div></div>`;
}
function empRow(e){
    return`<tr>
        <td><strong>${esc(e.name)}</strong></td>
        <td><span class="team-badge ${e.team}">${e.team==='annotation'?'Annotation':'Assessment'}</span></td>
        <td><span class="status-badge ${e.statusClass}">${e.icon} ${e.status}</span></td>
        <td><span class="time-badge">${e.login}</span></td>
        <td><span class="time-badge">${e.logout}</span></td>
        <td><strong>${e.workingHours}</strong></td>
    </tr>`;
}
function renderView(view){
    activeViewTab=view;
    document.querySelectorAll('.view-tab').forEach(t=>{const v=t.dataset.view;t.className='view-tab'+(v===view?' active-'+view:'');});
    const filtered=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    document.getElementById('statsLabel').textContent=view==='all'?'All Employees':view==='annotation'?'Data Annotation':'Data Assessment / DA';
    renderStats(filtered);
    if(!filtered.length){document.getElementById('tableContainer').innerHTML='<p style="padding:20px;color:#aaa;">No data.</p>';return;}
    let rows='';
    if(view==='all'){
        const ann=filtered.filter(r=>r.team==='annotation'),ass=filtered.filter(r=>r.team==='assessment');
        rows+=`<tr class="team-header-row annotation"><td colspan="6">üîµ Data Annotation Team (${ann.length})</td></tr>`+ann.map(empRow).join('');
        rows+=`<tr class="team-header-row assessment"><td colspan="6">üü† Data Assessment / DA Team (${ass.length})</td></tr>`+ass.map(empRow).join('');
    }else rows=filtered.map(empRow).join('');
    document.getElementById('tableContainer').innerHTML=`
        <table><thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th></tr></thead>
        <tbody>${rows}</tbody></table>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SAMPLE DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sampleData1=`Ramyashree Ragupathy  [8:59 AM]
In working on car parts updates
Koteswari  [9:09 AM]
Working on all_new_car_parts _rear bumper review.
Anilkumar  [9:09 AM]
Working on all_new_car_parts_rear_bumper annotation.
Manoj kumar  [9:13 AM]
Working on volvo_pov_damage_2 Annotation.
Hari  [9:19 AM]
In working on VOLVO_POV_damage Review.
Kalyani Dande  [9:24 AM]
Working on all_new_car_parts_rear_bumper annotation.
Uma  [9:29 AM]
Working on all new car parts annotation.
Koteswari  [6:11 PM]
Worked on all_new_car_parts _rear bumper review.
Anilkumar  [6:11 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Hari  [6:18 PM]
Worked on VOLVO_POV_damage Review.
Manoj kumar  [6:21 PM]
Worked on volvo_pov_damage_2 Annotation.
Kalyani Dande  [6:25 PM]
Worked on all_new_car_parts_rear_bumper annotation.
Uma  [6:30 PM]
Worked on all new car parts annotation.
Ramyashree Ragupathy  [6:37 PM]
Worked on car parts updates`;

const sampleData2=`Ishika  [7:16 AM]
Login - Working on: Production portals
Remarks: Nil
Jobin Johnson  [8:00 AM]
Login - Working on: Work hours 08:00 AM
Remarks: Nil
Jagadish  [8:04 AM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [8:31 AM]
Login - Working on: Production portals
Remarks: Nil
Sandhya K  [9:01 AM]
On leave
sunkavalli Gayatri  [9:28 AM]
Login - Working on: Production portal
Remarks: Nil
Gowthami TP  [9:29 AM]
Login - Working on: Pilot Portals
Remarks: Nil
Sajina NM  [9:32 AM]
Login - Working on: Production portals
Remarks: Nil
vengatesan  [9:56 AM]
On leave
M.Sarvani  [10:01 AM]
Login-Working on: Production portals
Remarks:Nil
Divya K  [10:59 AM]
Login - Working on: Production portals
Remarks: Nil
Ishika  [5:33 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.
Jobin Johnson  [5:36 PM]
Logout - Worked on: Production Portals
Remarks: Done
Gowthami TP  [6:30 PM]
Logout - Worked on: Pilot Portals
Remarks: Done
kaushik  [6:30 PM]
Logout - Worked on: Production Portals
Remarks: 30 mins extra.
Sajina NM  [6:33 PM]
Logout - Worked on: Production Portals
Remarks: NIL
sunkavalli Gayatri  [7:01 PM]
Logout - Worked on: Production Portals
Remarks: Extended 30 mins
M.Sarvani  [7:35 PM]
Logout - Worked on: Production Portals
Remarks: 30mins extra.
Divya K  [8:31 PM]
Logout - Worked on: Production Portals
Remarks: half hour extra.`;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ATTENDANCE TRACKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let attendRows = [];        // current date's attendance rows from DB
let attendCurrentDate = ''; // currently selected date
let attendEditId = null;    // id of row being edited (null = new)

// Populate attendance date dropdown ‚Äî merge violation dates + attendance dates
async function refreshAttendDateSelect(){
    const sel = document.getElementById('attendDateSelect');
    const prev = sel.value;

    // Get dates from both tables
    let aDates = [];
    try{ const rows = await dbLoadAttendanceDates(); aDates = [...new Set(rows.map(r=>r.date))]; } catch(e){}
    const vDates = [...new Set(dbRows.map(r=>r.date))];
    const allDates = [...new Set([...aDates, ...vDates])].sort().reverse();

    sel.innerHTML = '<option value="">‚Äî Pick a date ‚Äî</option>';
    allDates.forEach(d=>{
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = formatDate(d);
        sel.appendChild(opt);
    });
    if(prev && allDates.includes(prev)) sel.value = prev;
}

async function loadAttendance(){
    const dateStr = document.getElementById('attendDateSelect').value;
    if(!dateStr){ document.getElementById('attendContent').innerHTML='<div class="no-attend">Select a date above to view attendance.</div>'; return; }
    attendCurrentDate = dateStr;
    document.getElementById('attendAddBtn').disabled = false;
    document.getElementById('attendExportBtn').disabled = false;
    document.getElementById('attendContent').innerHTML = '<div class="no-attend">Loading‚Ä¶</div>';
    try{
        attendRows = await dbLoadAttendance(dateStr);
        renderAttendance(dateStr);
    } catch(e){
        document.getElementById('attendContent').innerHTML = '<div class="no-attend">‚ùå Failed to load: '+e.message+'</div>';
    }
}

function calcWorkingHours(login, logout){
    if(!login || !logout) return '-';
    const a = timeToMinutes(login), b = timeToMinutes(logout);
    if(a===null || b===null) return '-';
    const diff = (b < a ? b+1440 : b) - a;
    return (diff/60).toFixed(2) + ' hrs';
}

function renderAttendance(dateStr){
    window._attendRowMap = {}; // clear map on each render
    const allEmp = [...teams.annotation.map(n=>({name:n,team:'annotation'})),
                    ...teams.assessment.map(n=>({name:n,team:'assessment'}))];
    const content = document.getElementById('attendContent');
    const badge   = document.getElementById('attendBadge');

    // Build merged list: start from all employees, overlay saved records
    const merged = allEmp.map(e=>{
        const saved = attendRows.find(r=>r.name===e.name);
        if(saved) return {...saved, fromDB:true};
        // Check violation table for this date
        const viol = dbRows.find(r=>r.date===dateStr && r.name===e.name);
        if(viol){
            return {
                name:e.name, team:e.team, date:dateStr,
                status: viol.resolution==='On Leave' ? 'On Leave' :
                        viol.status==='Missing' ? 'Absent' :
                        viol.status==='Incomplete' ? 'Incomplete' : 'Present',
                login:  viol.login  || '',
                logout: viol.logout || '',
                notes:  '', fromDB:false, fromViolation:true, id:null
            };
        }
        return { name:e.name, team:e.team, date:dateStr, status:'Unknown', login:'', logout:'', notes:'', fromDB:false, id:null };
    });

    const present    = merged.filter(r=>r.status==='Present').length;
    const incomplete = merged.filter(r=>r.status==='Incomplete').length;
    const absent     = merged.filter(r=>r.status==='Absent').length;
    const onLeave    = merged.filter(r=>r.status==='On Leave').length;
    const unknown    = merged.filter(r=>r.status==='Unknown').length;

    badge.textContent = formatDate(dateStr);
    document.getElementById('attendSummary').innerHTML = `
        <div class="attend-stat"><div class="av" style="color:#2c3e50">${merged.length}</div><div class="al">Total</div></div>
        <div class="attend-stat"><div class="av" style="color:#27ae60">${present}</div><div class="al">‚úÖ Present</div></div>
        <div class="attend-stat"><div class="av" style="color:#e67e22">${incomplete}</div><div class="al">‚ö†Ô∏è Incomplete</div></div>
        <div class="attend-stat"><div class="av" style="color:#dc3545">${absent}</div><div class="al">‚ùå Absent</div></div>
        <div class="attend-stat"><div class="av" style="color:#6c757d">${onLeave}</div><div class="al">üìÖ On Leave</div></div>
        <div class="attend-stat"><div class="av" style="color:#aaa">${unknown}</div><div class="al">‚ùì No Data</div></div>`;

    if(!merged.length){ content.innerHTML='<div class="no-attend">No employees found.</div>'; return; }

    const rows = merged.map(r=>{
        const rowClass = r.status==='Present'?'attend-present':
                         r.status==='Incomplete'?'attend-incomplete':
                         r.status==='Absent'?'attend-absent':
                         r.status==='On Leave'?'attend-leave':'';
        const badgeCls = r.status==='Present'?'ab-present':
                         r.status==='Incomplete'?'ab-incomplete':
                         r.status==='Absent'?'ab-absent':'ab-leave';
        const manualBadge = r.source === 'manual' ? '<span class="attend-badge ab-manual">‚úèÔ∏è Manual</span>' : '';
        const teamBadge   = `<span class="team-badge ${r.team}">${r.team==='annotation'?'Annotation':'Assessment'}</span>`;
        const hours       = calcWorkingHours(r.login, r.logout);
        const loginTxt    = r.login  && r.login!=='‚ùå No login'  ? r.login  : (r.status==='Absent'||r.status==='On Leave'||r.status==='Unknown')?'‚Äî':'‚ùå Missing';
        const logoutTxt   = r.logout && r.logout!=='‚ùå No logout' ? r.logout : (r.status==='Absent'||r.status==='On Leave'||r.status==='Unknown')?'‚Äî':'‚ùå Missing';
        // Store row data in a global map keyed by safe index ‚Äî avoids ALL quote issues in onclick
        const rowKey = 'ar_' + Date.now() + '_' + Math.random().toString(36).slice(2);
        window._attendRowMap = window._attendRowMap || {};
        window._attendRowMap[rowKey] = {id:r.id||null,name:r.name,status:r.status,login:r.login||'',logout:r.logout||'',notes:r.notes||''};

        return `<tr class="${rowClass}">
            <td><strong>${esc(r.name)}</strong>${manualBadge}</td>
            <td>${teamBadge}</td>
            <td><span class="attend-badge ${badgeCls}">${r.status}</span></td>
            <td><span class="time-badge">${loginTxt}</span></td>
            <td><span class="time-badge">${logoutTxt}</span></td>
            <td><strong>${hours}</strong></td>
            <td>${r.notes?'<span style="color:#888;font-size:12px;">'+esc(r.notes)+'</span>':''}</td>
            <td>
                <button class="btn btn-xs btn-secondary" onclick="openAttendanceModalFor(window._attendRowMap['${rowKey}'])">‚úèÔ∏è Edit</button>
                ${r.id?`<button class="btn btn-xs btn-danger" style="margin-left:4px;" onclick="deleteAttendEntry('${r.id}')">üóëÔ∏è</button>`:''}
            </td>
        </tr>`;
    }).join('');

    content.innerHTML = `<table class="attend-table">
        <thead><tr><th>Employee</th><th>Team</th><th>Status</th><th>Login</th><th>Logout</th><th>Hours</th><th>Notes</th><th>Action</th></tr></thead>
        <tbody>${rows}</tbody>
    </table>`;
}

function onAttendStatusChange(){
    const s = document.getElementById('attendStatus').value;
    document.getElementById('attendTimeFields').style.display = (s==='Absent'||s==='On Leave') ? 'none' : 'block';
}

function openAttendanceModal(){
    attendEditId = null;
    // Populate employee dropdown
    const sel = document.getElementById('attendEmpSelect');
    const allEmp = [...teams.annotation.map(n=>n), ...teams.assessment.map(n=>n)].sort();
    sel.innerHTML = '<option value="">‚Äî Select employee ‚Äî</option>' + allEmp.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    document.getElementById('attendStatus').value  = 'Present';
    document.getElementById('attendLogin').value   = '';
    document.getElementById('attendLogout').value  = '';
    document.getElementById('attendNotes').value   = '';
    onAttendStatusChange();
    document.getElementById('attendOverlay').classList.add('open');
    setTimeout(()=>document.getElementById('attendEmpSelect').focus(), 100);
}

function openAttendanceModalFor(data){
    attendEditId = data.id || null;
    const sel = document.getElementById('attendEmpSelect');
    const allEmp = [...teams.annotation.map(n=>n), ...teams.assessment.map(n=>n)].sort();
    sel.innerHTML = '<option value="">‚Äî Select employee ‚Äî</option>' + allEmp.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    sel.value      = data.name;
    document.getElementById('attendStatus').value  = data.status  || 'Present';
    document.getElementById('attendLogin').value   = data.login   || '';
    document.getElementById('attendLogout').value  = data.logout  || '';
    document.getElementById('attendNotes').value   = data.notes   || '';
    onAttendStatusChange();
    document.getElementById('attendOverlay').classList.add('open');
}

function closeAttendanceModal(){
    document.getElementById('attendOverlay').classList.remove('open');
    attendEditId = null;
}

async function saveManualEntry(){
    const name   = document.getElementById('attendEmpSelect').value.trim();
    const status = document.getElementById('attendStatus').value;
    const login  = document.getElementById('attendLogin').value.trim();
    const logout = document.getElementById('attendLogout').value.trim();
    const notes  = document.getElementById('attendNotes').value.trim();

    if(!name){ showToast('‚ö†Ô∏è Please select an employee.'); return; }
    if(!attendCurrentDate){ showToast('‚ö†Ô∏è No date selected.'); return; }

    // Check if a DB record already exists for this employee on this date
    const existing = attendRows.find(r=>r.name===name);
    const rowId    = attendEditId || (existing ? existing.id : null);

    const row = {
        id:     rowId || undefined,
        date:   attendCurrentDate,
        name:   name,
        team:   getTeam(name) || 'annotation',
        status: status,
        login:  (status==='Absent'||status==='On Leave') ? '' : login,
        logout: (status==='Absent'||status==='On Leave') ? '' : logout,
        notes:  notes,
        source: 'manual'   // manually entered by user
    };
    if(!rowId) delete row.id;

    closeAttendanceModal();
    try{
        await dbSaveAttendance(row);
        attendRows = await dbLoadAttendance(attendCurrentDate);
        renderAttendance(attendCurrentDate);
        showToast('‚úÖ Attendance saved for '+esc(name));
    } catch(e){
        showToast('‚ùå Save failed: '+e.message);
    }
}

async function deleteAttendEntry(id){
    openConfirm('Delete Entry','Remove this attendance record?', async()=>{
        try{
            await dbDeleteAttendance(id);
            attendRows = await dbLoadAttendance(attendCurrentDate);
            renderAttendance(attendCurrentDate);
            showToast('üóëÔ∏è Entry deleted.');
        } catch(e){ showToast('‚ùå Delete failed: '+e.message); }
    });
}

function exportAttendanceCSV(){
    if(!attendCurrentDate){ showToast('Select a date first.'); return; }
    const allEmp = [...teams.annotation.map(n=>({name:n,team:'annotation'})),
                    ...teams.assessment.map(n=>({name:n,team:'assessment'}))];
    const merged = allEmp.map(e=>{
        const saved = attendRows.find(r=>r.name===e.name);
        if(saved) return saved;
        const viol = dbRows.find(r=>r.date===attendCurrentDate && r.name===e.name);
        if(viol) return {name:e.name,team:e.team,status:viol.status==='Missing'?'Absent':viol.status,login:viol.login||'',logout:viol.logout||'',notes:''};
        return {name:e.name,team:e.team,status:'Unknown',login:'',logout:'',notes:''};
    });
    let csv = 'Date,Employee,Team,Status,Login,Logout,Working Hours,Notes\n';
    merged.forEach(r=>{
        const hrs = calcWorkingHours(r.login,r.logout);
        csv += `"${attendCurrentDate}","${r.name}","${teamLabel(r.team)}","${r.status}","${r.login||''}","${r.logout||''}","${hrs}","${(r.notes||'').replace(/"/g,'""')}"
`;
    });
    const a = Object.assign(document.createElement('a'),{
        href: URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download: `attendance-${attendCurrentDate}.csv`
    });
    a.click(); URL.revokeObjectURL(a.href);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Save ALL employees' attendance from Slack report to attendance_records table
async function saveAttendanceFromReport(dateStr, report){
    try{
        // Load existing attendance records for this date so we don't overwrite manual edits
        const existing = await dbLoadAttendance(dateStr);

        for(const r of report){
            // Skip if a manual entry already exists for this employee on this date
            const manualEntry = existing.find(e => e.name === r.name);
            if(manualEntry) continue; // preserve manual edits

            // Map report status to attendance status
            let status = 'Present';
            if(r.status === 'On Leave')   status = 'On Leave';
            else if(r.status === 'Missing')    status = 'Absent';
            else if(r.status === 'Incomplete') status = 'Incomplete';
            else if(r.status === 'Complete')   status = 'Present';

            const cleanLogin  = (r.login  === '‚ùå No login'  || !r.login)  ? '' : r.login;
            const cleanLogout = (r.logout === '‚ùå No logout' || !r.logout) ? '' : r.logout;

            const row = {
                date:   dateStr,
                name:   r.name,
                team:   r.team,
                status: status,
                login:  cleanLogin,
                logout: cleanLogout,
                notes:  '',
                source: 'slack'   // auto-saved from Slack ‚Äî not manually entered
            };
            await dbSaveAttendance(row);
        }
    } catch(e){
        console.error('saveAttendanceFromReport error:', e);
    }
}

async function processMessages(){
    const input=document.getElementById('slackInput').value.trim();
    if(!input){alert('Please paste some Slack messages first!');return;}
    const msgs=parseMessages(input);
    if(!msgs.length){alert('No valid messages detected.');return;}
    lastReport=buildReport(msgs);
    let dateStr=document.getElementById('reportDate').value;
    if(!dateStr)dateStr=new Date().toISOString().split('T')[0];
    const ann=lastReport.filter(r=>r.team==='annotation'),ass=lastReport.filter(r=>r.team==='assessment');
    document.getElementById('tcAll').textContent=lastReport.length;
    document.getElementById('tcAnnotation').textContent=ann.length;
    document.getElementById('tcAssessment').textContent=ass.length;
    document.getElementById('viewTabs').style.display='flex';
    document.getElementById('resultsArea').style.display='block';
    renderView(activeViewTab);
    // Save violations to violation_history table
    await saveViolationsForDate(dateStr, lastReport);

    // Save full attendance (all employees) to attendance_records table
    setSyncStatus('loading', 'Saving attendance records‚Ä¶');
    await saveAttendanceFromReport(dateStr, lastReport);

    // Refresh attendance panel ‚Äî reload from DB and auto-select this date
    await refreshAttendDateSelect();
    const attendSel = document.getElementById('attendDateSelect');
    attendSel.value = dateStr;
    await loadAttendance();

    // Open attendance panel automatically
    const ap = document.getElementById('attendPanelToggle');
    const ab = document.getElementById('attendPanelBody');
    if(!ab.classList.contains('open')){ ap.classList.add('open'); ab.classList.add('open'); }

    // Open violation history panel
    const hp=document.getElementById('histPanelToggle'),hb=document.getElementById('histPanelBody');
    if(!hb.classList.contains('open')){hp.classList.add('open');hb.classList.add('open');}

    const vc=lastReport.filter(r=>r.status==='Missing'||r.status==='Incomplete').length;
    setSyncStatus('ok', '‚úÖ Attendance & violations saved for ' + formatDate(dateStr));
    showToast(vc?`‚úÖ Saved. <strong>${vc} violation${vc!==1?'s':''}</strong> recorded for ${formatDate(dateStr)}.`:`‚úÖ Saved ‚Äî everyone compliant on ${formatDate(dateStr)}!`);
    document.getElementById('lastUpdated').textContent=`‚úì Last updated: ${new Date().toLocaleString()}`;
}

function clearAll(){
    document.getElementById('slackInput').value='';
    document.getElementById('viewTabs').style.display='none';
    document.getElementById('resultsArea').style.display='none';
    document.getElementById('lastUpdated').textContent='';
    lastReport=[];clearDebug();document.getElementById('debugInfo').innerHTML='';
}

function exportCSV(){
    if(!lastReport.length){alert('Process messages first!');return;}
    const view=activeViewTab,rows=view==='all'?lastReport:lastReport.filter(r=>r.team===view);
    let csv='Employee,Team,Status,Login,Logout,Working Hours\n';
    rows.forEach(r=>{csv+=`"${r.name}","${teamLabel(r.team)}","${r.status}","${r.login}","${r.logout}","${r.workingHours}"\n`;});
    const a=Object.assign(document.createElement('a'),{
        href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),
        download:`slack-attendance-${view}-${new Date().toISOString().split('T')[0]}.csv`
    });
    a.click();URL.revokeObjectURL(a.href);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ App init ‚Äî called once after login is confirmed ‚îÄ‚îÄ
async function initApp(){
    if(window._appInitialised) return;
    window._appInitialised = true;

    loadTeams(); renderEmpGrid();
    document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
    await loadFromCloud();

    document.getElementById('empPanelToggle').addEventListener('click',()=>{
        document.getElementById('empPanelToggle').classList.toggle('open');
        document.getElementById('empPanelBody').classList.toggle('open');
    });
    document.getElementById('tabAnnotation').addEventListener('click',()=>switchEmpTab('annotation'));
    document.getElementById('tabAssessment').addEventListener('click',()=>switchEmpTab('assessment'));
    document.getElementById('newEmpTeam').addEventListener('change',e=>switchEmpTab(e.target.value));
    document.getElementById('addEmpBtn').addEventListener('click',addEmployee);
    document.getElementById('newEmpInput').addEventListener('keydown',e=>{if(e.key==='Enter')addEmployee();});
    document.getElementById('resetEmpBtn').addEventListener('click',resetToDefaults);

    document.getElementById('histPanelToggle').addEventListener('click',()=>{
        document.getElementById('histPanelToggle').classList.toggle('open');
        document.getElementById('histPanelBody').classList.toggle('open');
    });
    document.getElementById('refreshHistBtn').addEventListener('click',e=>{e.stopPropagation();loadFromCloud();});
    document.getElementById('histFilterBtn').addEventListener('click',()=>renderHistory(getHistFilters()));
    document.getElementById('histResetFilterBtn').addEventListener('click',()=>{
        ['histTeamFilter','histTypeFilter','histFromDate','histToDate'].forEach(id=>document.getElementById(id).value=id.includes('Filter')?'all':'');
        renderHistory();
    });
    document.getElementById('histExportBtn').addEventListener('click',()=>exportHistoryCSV(getHistFilters()));
    document.getElementById('histClearBtn').addEventListener('click',()=>{
        document.getElementById('clearConfirmInput').value='';
        document.getElementById('clearOverlayConfirm').disabled=true;
        document.getElementById('clearOverlay').classList.add('open');
        setTimeout(()=>document.getElementById('clearConfirmInput').focus(),100);
    });
    document.getElementById('clearConfirmInput').addEventListener('input',function(){
        const match = this.value.trim().toUpperCase() === 'CLEAR';
        document.getElementById('clearOverlayConfirm').disabled = !match;
        this.classList.toggle('match', match);
    });
    document.getElementById('clearOverlayCancel').addEventListener('click',()=>{
        document.getElementById('clearOverlay').classList.remove('open');
    });
    document.getElementById('clearOverlayConfirm').addEventListener('click',async()=>{
        document.getElementById('clearOverlay').classList.remove('open');
        setSyncStatus('loading','Deleting all records‚Ä¶');
        try{
            await dbDeleteAll();
            // Also clear all attendance records
            const allAttend = await sbFetch(ATTEND_TABLE + '?date=gte.0000-00-00');
            for(const r of allAttend){ try{ await dbDeleteAttendance(r.id); } catch(e){} }
            await loadFromCloud();
            await refreshAttendDateSelect();
            document.getElementById('attendContent').innerHTML='<div class="no-attend">Select a date above to view attendance.</div>';
            document.getElementById('attendSummary').innerHTML='';
            showToast('üóëÔ∏è All history cleared.');
        }
        catch(e){ setSyncStatus('error','Delete failed: '+e.message); }
    });
    document.getElementById('clearOverlay').addEventListener('click',e=>{
        if(e.target===document.getElementById('clearOverlay'))
            document.getElementById('clearOverlay').classList.remove('open');
    });
    document.getElementById('confirmOk').addEventListener('click',()=>{if(_ccb)_ccb();closeConfirm();});
    document.getElementById('confirmCancel').addEventListener('click',closeConfirm);
    document.getElementById('confirmOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('confirmOverlay'))closeConfirm();});

    document.querySelectorAll('.res-option').forEach(opt=>{
        opt.addEventListener('click',()=>{selectedResolution=opt.dataset.res;updateResOptions();updateReasonLabel();});
    });
    document.getElementById('editSave').addEventListener('click',saveEdit);
    document.getElementById('editCancel').addEventListener('click',closeEditModal);
    document.getElementById('editClose').addEventListener('click',closeEditModal);
    document.getElementById('editOverlay').addEventListener('click',e=>{if(e.target===document.getElementById('editOverlay'))closeEditModal();});

    // Attendance modal wiring
    document.getElementById('attendCloseBtn').addEventListener('click', closeAttendanceModal);
    document.getElementById('attendOverlay').addEventListener('click', e=>{ if(e.target===document.getElementById('attendOverlay')) closeAttendanceModal(); });
    document.getElementById('attendSaveBtn').addEventListener('click', saveManualEntry);
    document.getElementById('attendPanelToggle').addEventListener('click',()=>{
        document.getElementById('attendPanelToggle').classList.toggle('open');
        document.getElementById('attendPanelBody').classList.toggle('open');
    });

    document.querySelectorAll('.view-tab').forEach(t=>t.addEventListener('click',()=>renderView(t.dataset.view)));
    document.getElementById('processBtn').addEventListener('click',processMessages);
    document.getElementById('clearBtn').addEventListener('click',clearAll);
    document.getElementById('exportBtn').addEventListener('click',exportCSV);
    document.getElementById('debugBtn').addEventListener('click',()=>{
        const d=document.getElementById('debugInfo');d.style.display=d.style.display==='block'?'none':'block';
    });
    document.getElementById('sample1Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData1;processMessages();});
    document.getElementById('sample2Btn').addEventListener('click',()=>{document.getElementById('slackInput').value=sampleData2;processMessages();});
}

document.addEventListener('DOMContentLoaded', function(){
    // Always wire login buttons first
    document.getElementById('loginBtn').addEventListener('click', doLogin);
    document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
    document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') document.getElementById('loginPass').focus(); });
    document.getElementById('logoutBtn').addEventListener('click', doLogout);

    // If already logged in, go straight to app
    const session = checkSession();
    if(session){ showMainApp(session); }
    // else: login screen stays visible, initApp called when user logs in via showMainApp()
});
</script>
</body>
</html>
